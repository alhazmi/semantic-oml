<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>oml2: api.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="oml_logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">oml2
   &#160;<span id="projectnumber">2.12.0pre.79-58cf-dirty</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('api_8c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">api.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Implement the user-visible API of OML.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;string.h&gt;</code><br/>
<code>#include &lt;stdlib.h&gt;</code><br/>
<code>#include &lt;errno.h&gt;</code><br/>
<code>#include &lt;assert.h&gt;</code><br/>
<code>#include &lt;sys/time.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="oml__filter_8h_source.html">oml2/oml_filter.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="omlc_8h_source.html">oml2/omlc.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="o__log_8h_source.html">ocomm/o_log.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="oml__value_8h_source.html">oml_value.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="validate_8h_source.html">validate.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="mem_8h_source.html">mem.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="client_8h_source.html">client.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="buffered__writer_8h_source.html">buffered_writer.h</a>&quot;</code><br/>
</div><div class="textblock"><div class="dynheader">
Include dependency graph for api.c:</div>
<div class="dyncontent">
<div class="center"><img src="api_8c__incl.png" border="0" usemap="#api_8c" alt=""/></div>
<map name="api_8c" id="api_8c">
<area shape="rect" id="node13" href="oml__filter_8h.html" title="Abstract interface for filters." alt="" coords="400,160,517,189"/><area shape="rect" id="node15" href="omlc_8h.html" title="Public API of the OML client library." alt="" coords="408,315,501,344"/><area shape="rect" id="node26" href="o__log_8h.html" title="ocomm/o_log.h" alt="" coords="284,392,393,421"/><area shape="rect" id="node35" href="oml__value_8h.html" title="oml_value.h" alt="" coords="251,237,341,267"/><area shape="rect" id="node42" href="validate_8h.html" title="validate.h" alt="" coords="679,83,756,112"/><area shape="rect" id="node44" href="mem_8h.html" title="mem.h" alt="" coords="661,315,723,344"/><area shape="rect" id="node49" href="client_8h.html" title="Defines various structures and functions used by various parts." alt="" coords="591,83,655,112"/><area shape="rect" id="node64" href="buffered__writer_8h.html" title="buffered_writer.h" alt="" coords="912,160,1029,189"/><area shape="rect" id="node30" href="oml__writer_8h.html" title="Abstract interface for writers." alt="" coords="492,237,617,267"/><area shape="rect" id="node58" href="oml__out__stream_8h.html" title="Abstract interface for output streams." alt="" coords="821,237,979,267"/><area shape="rect" id="node61" href="mstring_8h.html" title="mstring.h" alt="" coords="723,237,797,267"/><area shape="rect" id="node68" href="mbuf_8h.html" title="mbuf.h" alt="" coords="797,315,859,344"/></map>
</div>
</div>
<p><a href="api_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a3d45237584ca128d367f3a1cdce3b1ad"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="api_8c.html#a3d45237584ca128d367f3a1cdce3b1ad">omlc_process</a> (<a class="el" href="structOmlMP.html">OmlMP</a> *<a class="el" href="structmp.html">mp</a>, <a class="el" href="unionOmlValueU.html">OmlValueU</a> *values)</td></tr>
<tr class="memitem:ac714a82b22dfcc34a6b6130e047f2ab7"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="api_8c.html#ac714a82b22dfcc34a6b6130e047f2ab7">omlc_inject</a> (<a class="el" href="structOmlMP.html">OmlMP</a> *<a class="el" href="structmp.html">mp</a>, <a class="el" href="unionOmlValueU.html">OmlValueU</a> *values)</td></tr>
<tr class="memitem:a8c8205b04c4b8d19a38404ee5d4b3229"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="api_8c.html#a8c8205b04c4b8d19a38404ee5d4b3229">omlc_inject_metadata</a> (<a class="el" href="structOmlMP.html">OmlMP</a> *<a class="el" href="structmp.html">mp</a>, const char *key, const <a class="el" href="unionOmlValueU.html">OmlValueU</a> *value, <a class="el" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012">OmlValueT</a> <a class="el" href="check__libshared__headers_8c.html#a23506fc4821ab6d9671f3e6222591a96">type</a>, const char *fname)</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:ab37d06b7aa57f34099a4dbcff29635b7"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structOmlMP.html">OmlMP</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="api_8c.html#ab37d06b7aa57f34099a4dbcff29635b7">schema0</a></td></tr>
</table>
<a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>Implement the user-visible API of OML. </p>

<p>Definition in file <a class="el" href="api_8c_source.html">api.c</a>.</p>
</div><h2>Function Documentation</h2>
<a class="anchor" id="ac714a82b22dfcc34a6b6130e047f2ab7"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int omlc_inject </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structOmlMP.html">OmlMP</a> *&#160;</td>
          <td class="paramname"><em>mp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="unionOmlValueU.html">OmlValueU</a> *&#160;</td>
          <td class="paramname"><em>values</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Inject a measurement sample into a Measurement Point.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mp</td><td>pointer to <a class="el" href="structOmlMP.html">OmlMP</a> into which the new sample is being injected </td></tr>
    <tr><td class="paramname">values</td><td>an array of <a class="el" href="unionOmlValueU.html">OmlValueU</a> to be processed </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success, &lt;0 otherwise</dd></dl>
<p>The values' types is assumed to be the same as what was passed to omlc_add_mp Type information is stored in (stored in mp-&gt;param_defs[].param_types)</p>
<p>Traverse the list of MSs attached to this MP and, for each MS, the list of filters to apply to the sample. Input the relevant field of the MP to each filter, the call omlc_ms_process() to determine whether a new sample has to be output on that MS.</p>
<p>The content of values is deep-copied into the MSs' storage, so values can be directly freed/reused when inject returns.</p>
<p>This function might call omlc_inject_client_instr which in turns calls omlc_inject. We make sure not to loop.</p>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="omlc_8h.html#a13e1026b136bfacfbb3764d454241db0">omlc_add_mp</a>, omlc_ms_process, <a class="el" href="oml__value_8h.html#abce36c5bb2beea2a56812e84b9f1a7fa">oml_value_set</a>, omlc_inject_client_instr </dd></dl>

<p>Definition at line <a class="el" href="api_8c_source.html#l00149">149</a> of file <a class="el" href="api_8c_source.html">api.c</a>.</p>

<p>References <a class="el" href="oml__writer_8h_source.html#l00120">OmlWriter::bufferedWriter</a>, <a class="el" href="buffered__writer_8c_source.html#l00347">bw_nlost_reset()</a>, <a class="el" href="client_8h_source.html#l00080">OmlClient::client_instr</a>, <a class="el" href="omlc_8h_source.html#l00790">OmlMStream::dropped</a>, <a class="el" href="omlc_8h_source.html#l00749">OmlMStream::filters</a>, <a class="el" href="oml__filter_8h_source.html#l00133">OmlFilter::index</a>, <a class="el" href="oml__filter_8h_source.html#l00119">OmlFilter::input</a>, <a class="el" href="client_8h_source.html#l00086">OmlClient::instr_interval</a>, <a class="el" href="client_8h_source.html#l00083">OmlClient::instr_time</a>, <a class="el" href="o__log_8h_source.html#l00082">LOGDEBUG</a>, <a class="el" href="log_8c_source.html#l00297">logerror()</a>, <a class="el" href="log_8c_source.html#l00309">logwarn()</a>, <a class="el" href="misc_8c_source.html#l00030">mp_lock()</a>, <a class="el" href="misc_8c_source.html#l00040">mp_unlock()</a>, <a class="el" href="omlc_8h_source.html#l00691">OmlMP::name</a>, <a class="el" href="oml__filter_8h_source.html#l00143">OmlFilter::next</a>, <a class="el" href="omlc_8h_source.html#l00776">OmlMStream::next</a>, <a class="el" href="omlc_8h_source.html#l00784">OmlMStream::nwriters</a>, <a class="el" href="oml__value_8c_source.html#l00081">oml_value_init()</a>, <a class="el" href="oml__value_8c_source.html#l00217">oml_value_reset()</a>, <a class="el" href="oml__value_8c_source.html#l00146">oml_value_set()</a>, <a class="el" href="init_8c_source.html#l00040">omlc_instance</a>, <a class="el" href="omlc_8h_source.html#l00694">OmlMP::param_defs</a>, <a class="el" href="omlc_8h_source.html#l00671">OmlMPDef::param_types</a>, <a class="el" href="client_8h_source.html#l00057">OmlClient::start_time</a>, <a class="el" href="omlc_8h_source.html#l00702">OmlMP::streams</a>, <a class="el" href="omlc_8h_source.html#l00739">OmlMStream::table_name</a>, <a class="el" href="omlc_8h_source.html#l00782">OmlMStream::writers</a>, <a class="el" href="omlc_8h_source.html#l00787">OmlMStream::written</a>, <a class="el" href="mem_8c_source.html#l00077">xmaxbytes()</a>, <a class="el" href="mem_8c_source.html#l00071">xmembytes()</a>, <a class="el" href="mem_8c_source.html#l00075">xmemfreed()</a>, and <a class="el" href="mem_8c_source.html#l00073">xmemnew()</a>.</p>

<p>Referenced by <a class="el" href="counter_8c_source.html#l00005">main()</a>, <a class="el" href="api_8c_source.html#l00218">omlc_inject_metadata()</a>, <a class="el" href="api_8c_source.html#l00120">omlc_process()</a>, <a class="el" href="blobgen_8c_source.html#l00168">run()</a>, and <a class="el" href="check__liboml2__api_8c_source.html#l00143">START_TEST()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="structOmlMStream.html">OmlMStream</a>* ms;</div>
<div class="line">  <a class="code" href="structOmlValue.html">OmlValue</a> v;</div>
<div class="line">  <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (NULL == <a class="code" href="client_8h.html#ae265e6c78eb3c0a1f4fdb40fe894394e">omlc_instance</a> || <a class="code" href="client_8h.html#ae265e6c78eb3c0a1f4fdb40fe894394e">omlc_instance</a>-&gt;<a class="code" href="structOmlClient.html#a89d86ad01212dc1bcde47399d890fa2e">start_time</a> &lt;= 0) {</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Cannot inject samples prior to calling omlc_init and omlc_start\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (mp == NULL || values == NULL) {</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <a class="code" href="o__log_8h.html#a2dc2d04eb65917762fb0ad5ff7dd0910">LOGDEBUG</a>(<span class="stringliteral">&quot;Injecting data into MP &#39;%s&#39;\n&quot;</span>, mp-&gt;<a class="code" href="structOmlMP.html#a5f99c0c042cdd120e19271c716d3eaac">name</a>);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="oml__value_8c.html#aecf953b9ce05c582c030eec0e962c69c">oml_value_init</a>(&amp;v);</div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="client_8h.html#aa1f46a06d6e6693cba8548a3cc4048e8">mp_lock</a>(mp) == -1) {</div>
<div class="line">    <a class="code" href="log_8c.html#ac65b3f90d3228474368b2b48a488cd44">logwarn</a>(<span class="stringliteral">&quot;Cannot lock MP &#39;%s&#39; for injection\n&quot;</span>, mp-&gt;<a class="code" href="structOmlMP.html#a5f99c0c042cdd120e19271c716d3eaac">name</a>);</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  uint64_t written = 0;</div>
<div class="line">  uint64_t dropped = 0;</div>
<div class="line">  <span class="keywordflow">for</span> (ms = mp-&gt;<a class="code" href="structOmlMP.html#a0053c119979daf6d558c414b685e17f5">streams</a>; ms; ms = ms-&gt;<a class="code" href="structOmlMStream.html#a3dcd5e7eeb74525f3a003b08eed87e12">next</a>) {</div>
<div class="line">    <a class="code" href="o__log_8h.html#a2dc2d04eb65917762fb0ad5ff7dd0910">LOGDEBUG</a>(<span class="stringliteral">&quot;Filtering MP &#39;%s&#39; data into MS &#39;%s&#39;\n&quot;</span>, mp-&gt;<a class="code" href="structOmlMP.html#a5f99c0c042cdd120e19271c716d3eaac">name</a>, ms-&gt;<a class="code" href="structOmlMStream.html#a0613b1a0952e979da8fc278dc9b3c280">table_name</a>);</div>
<div class="line">    <a class="code" href="structOmlFilter.html">OmlFilter</a>* f = ms-&gt;<a class="code" href="structOmlMStream.html#a5b929155b553fd221a655734c82d10ac">filters</a>;</div>
<div class="line">    <span class="keywordflow">for</span> (; f != NULL; f = f-&gt;<a class="code" href="structOmlFilter.html#a702d8421bfd416f22633b0cc470e1f3a">next</a>) {</div>
<div class="line"></div>
<div class="line">      <span class="comment">/* FIXME:  Should validate this indexing */</span></div>
<div class="line">      <a class="code" href="oml__value_8c.html#abce36c5bb2beea2a56812e84b9f1a7fa">oml_value_set</a>(&amp;v, &amp;values[f-&gt;<a class="code" href="structOmlFilter.html#a1b7d0a995ae0fc16a493d8212b1b64ee">index</a>], mp-&gt;<a class="code" href="structOmlMP.html#a8269442d91a3e59d2e26b254eb232d3e">param_defs</a>[f-&gt;<a class="code" href="structOmlFilter.html#a1b7d0a995ae0fc16a493d8212b1b64ee">index</a>].<a class="code" href="structOmlMPDef.html#ae973305703cc2bbc5d72f110db6eba38">param_types</a>);</div>
<div class="line"></div>
<div class="line">      f-&gt;<a class="code" href="structOmlFilter.html#ab16680e82521f7966b8096e1a2b1d9b0">input</a>(f, &amp;v);</div>
<div class="line">    }</div>
<div class="line">    omlc_ms_process(ms);</div>
<div class="line">    written += ms-&gt;<a class="code" href="structOmlMStream.html#ae4727d93738998bab105ab7517ce55af">written</a>;</div>
<div class="line">    dropped += ms-&gt;<a class="code" href="structOmlMStream.html#a4f5c723592bdb37e866fe008e736604b">dropped</a>;</div>
<div class="line">    <span class="keywordflow">for</span> (i=0; i&lt;ms-&gt;<a class="code" href="structOmlMStream.html#a98172393f791aba57e2431a97f332ba2">nwriters</a>; i++) {</div>
<div class="line">      dropped += <a class="code" href="buffered__writer_8c.html#a3607c79d254a965b65617d7d75317569">bw_nlost_reset</a>(ms-&gt;<a class="code" href="structOmlMStream.html#ad436c40e7e14ae11cde0361871a7eabd">writers</a>[i]-&gt;<a class="code" href="structOmlWriter.html#ad85ce72b01aaccf12305c2f4cd41bc27">bufferedWriter</a>);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="client_8h.html#ae9551b52d060a0d9cf2aa2c01f5f5d12">mp_unlock</a>(mp);</div>
<div class="line">  <a class="code" href="oml__value_8c.html#ad73bf2617858cdc9c70722e1ca91eea3">oml_value_reset</a>(&amp;v);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* do we need to send client instrumentation? */</span></div>
<div class="line">  <span class="keywordflow">if</span>(mp != <a class="code" href="client_8h.html#ae265e6c78eb3c0a1f4fdb40fe894394e">omlc_instance</a>-&gt;<a class="code" href="structOmlClient.html#a301a86e1b0438b15f455f15e56111677">client_instr</a> &amp;&amp; <a class="code" href="client_8h.html#ae265e6c78eb3c0a1f4fdb40fe894394e">omlc_instance</a>-&gt;<a class="code" href="structOmlClient.html#ab926bac3c12f3771f37c2271f825bcc9">instr_interval</a>) {</div>
<div class="line">    time_t now;</div>
<div class="line">    time(&amp;now);</div>
<div class="line">    <span class="keywordflow">if</span>(<a class="code" href="client_8h.html#ae265e6c78eb3c0a1f4fdb40fe894394e">omlc_instance</a>-&gt;<a class="code" href="structOmlClient.html#af593694695f0cceba6b1883bff63312a">instr_time</a> + <a class="code" href="client_8h.html#ae265e6c78eb3c0a1f4fdb40fe894394e">omlc_instance</a>-&gt;<a class="code" href="structOmlClient.html#ab926bac3c12f3771f37c2271f825bcc9">instr_interval</a> &lt;= now) {</div>
<div class="line">      <a class="code" href="client_8h.html#ae265e6c78eb3c0a1f4fdb40fe894394e">omlc_instance</a>-&gt;<a class="code" href="structOmlClient.html#af593694695f0cceba6b1883bff63312a">instr_time</a> = now; <span class="comment">/* Make sure we don&#39;t loop */</span></div>
<div class="line">      omlc_inject_client_instr(written, dropped, <a class="code" href="mem_8c.html#ab1dfe760f9b07c1caeb1d5cbf932fe2d">xmemnew</a>(), <a class="code" href="mem_8c.html#ae4e73fd416748f359c3a71daba5393d6">xmemfreed</a>(), <a class="code" href="mem_8c.html#ad97124824e8df0d9d39bfbbde478f1b2">xmembytes</a>(), <a class="code" href="mem_8c.html#ad46b776f681149324ae89a7c19c2bbd2">xmaxbytes</a>());</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a8c8205b04c4b8d19a38404ee5d4b3229"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int omlc_inject_metadata </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structOmlMP.html">OmlMP</a> *&#160;</td>
          <td class="paramname"><em>mp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="unionOmlValueU.html">OmlValueU</a> *&#160;</td>
          <td class="paramname"><em>value</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012">OmlValueT</a>&#160;</td>
          <td class="paramname"><em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>fname</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Inject metadata (key/value) for a specific MP.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mp</td><td>pointer to the <a class="el" href="structOmlMP.html">OmlMP</a> to which the metadata relates </td></tr>
    <tr><td class="paramname">key</td><td>base name for the key (keys are unique) </td></tr>
    <tr><td class="paramname">value</td><td><a class="el" href="unionOmlValueU.html">OmlValueU</a> containing the value for the given key </td></tr>
    <tr><td class="paramname">type</td><td>OmlValueT of value, currently only OML_STRING_VALUE is valid </td></tr>
    <tr><td class="paramname">fname</td><td>optional field name to which this metadata relates </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success, -1 otherwise</dd></dl>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="omlc_8h.html#a13e1026b136bfacfbb3764d454241db0">omlc_add_mp</a> </dd></dl>

<p>Definition at line <a class="el" href="api_8c_source.html#l00218">218</a> of file <a class="el" href="api_8c_source.html">api.c</a>.</p>

<p>References <a class="el" href="client_8h_source.html#l00036">OmlClient::app_name</a>, <a class="el" href="init_8c_source.html#l00867">find_mp_field()</a>, <a class="el" href="log_8c_source.html#l00333">logdebug()</a>, <a class="el" href="log_8c_source.html#l00297">logerror()</a>, <a class="el" href="log_8c_source.html#l00309">logwarn()</a>, <a class="el" href="mstring_8c_source.html#l00222">mstring_buf()</a>, <a class="el" href="mstring_8c_source.html#l00073">mstring_create()</a>, <a class="el" href="mstring_8c_source.html#l00237">mstring_delete()</a>, <a class="el" href="mstring_8c_source.html#l00100">mstring_set()</a>, <a class="el" href="mstring_8c_source.html#l00160">mstring_sprintf()</a>, <a class="el" href="omlc_8h_source.html#l00691">OmlMP::name</a>, <a class="el" href="omlc_8h_source.html#l00039">OML_STRING_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00494">omlc_copy_string</a>, <a class="el" href="api_8c_source.html#l00149">omlc_inject()</a>, <a class="el" href="init_8c_source.html#l00040">omlc_instance</a>, <a class="el" href="omlc_8h_source.html#l00457">omlc_reset_string</a>, <a class="el" href="omlc_8h_source.html#l00505">omlc_set_string</a>, <a class="el" href="omlc_8h_source.html#l00217">omlc_zero_array</a>, <a class="el" href="client_8h_source.html#l00057">OmlClient::start_time</a>, and <a class="el" href="validate_8c_source.html#l00036">validate_name()</a>.</p>

<p>Referenced by <a class="el" href="generator_8c_source.html#l00092">main()</a>, <a class="el" href="init_8c_source.html#l00365">omlc_add_mp()</a>, <a class="el" href="blobgen_8c_source.html#l00168">run()</a>, and <a class="el" href="check__liboml2__api_8c_source.html#l00177">START_TEST()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> ret = -1;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="unionOmlValueU.html">OmlValueU</a> v[3];</div>
<div class="line">  <a class="code" href="omlc_8h.html#a40c74c037cf8ff96b0159ccdbad3a5a9">omlc_zero_array</a>(v, 3);</div>
<div class="line">  <a class="code" href="structMString.html">MString</a> *subject = <a class="code" href="mstring_8c.html#a49f0faf4fe4e38a6d7b4f0ef09d5fd24">mstring_create</a>();</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (NULL == <a class="code" href="client_8h.html#ae265e6c78eb3c0a1f4fdb40fe894394e">omlc_instance</a> || <a class="code" href="client_8h.html#ae265e6c78eb3c0a1f4fdb40fe894394e">omlc_instance</a>-&gt;<a class="code" href="structOmlClient.html#a89d86ad01212dc1bcde47399d890fa2e">start_time</a> &lt;= 0) {</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Cannot inject metadata prior to calling omlc_init and omlc_start\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!key || !value) {</div>
<div class="line">    <a class="code" href="log_8c.html#ac65b3f90d3228474368b2b48a488cd44">logwarn</a>(<span class="stringliteral">&quot;Trying to inject metadata with missing key and/or value\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (! <a class="code" href="validate_8c.html#a85934d9b2c3cfbeb3f718b179a2fb596">validate_name</a>(key)) {</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;%s is an invalid metadata key name\n&quot;</span>, key);</div>
<div class="line"></div>
<div class="line">  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="oml__value_8c.html#ae1087eeb503fb7b11a810d93605c97df">type</a> != <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012a42b33eb7c21f79727a894a530a05b559">OML_STRING_VALUE</a>) {</div>
<div class="line">    <a class="code" href="log_8c.html#ac65b3f90d3228474368b2b48a488cd44">logwarn</a>(<span class="stringliteral">&quot;Currently, only OML_STRING_VALUE are valid as metadata value\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <a class="code" href="mstring_8c.html#a08be5969ab75ab7f40d4a767c8024df0">mstring_set</a> (subject, <span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>(NULL == mp) {</div>
<div class="line">      <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a>(<span class="stringliteral">&quot;%s: supplied MP is NULL, assuming experiment metadata\n&quot;</span>,</div>
<div class="line">          __FUNCTION__);</div>
<div class="line"></div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <span class="comment">/* XXX: At the moment, MS are named as APPNAME_MPNAME.</span></div>
<div class="line"><span class="comment">       * Be consistent with it here, until #1055 is addressed */</span></div>
<div class="line">      <a class="code" href="mstring_8c.html#ad28234c6cddf0af9ad2c538885e70ebf">mstring_sprintf</a>(subject, <span class="stringliteral">&quot;%s_%s&quot;</span>, <a class="code" href="client_8h.html#ae265e6c78eb3c0a1f4fdb40fe894394e">omlc_instance</a>-&gt;<a class="code" href="structOmlClient.html#a892c8aaacb821f1c3e90285ab97dce1b">app_name</a>, mp-&gt;<a class="code" href="structOmlMP.html#a5f99c0c042cdd120e19271c716d3eaac">name</a>);</div>
<div class="line">      <span class="keywordflow">if</span> (fname) {</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="client_8h.html#adb0da318e59f1e48cbef3255e272ebdf">find_mp_field</a>(fname, mp) &lt; 0) {</div>
<div class="line">          <a class="code" href="log_8c.html#ac65b3f90d3228474368b2b48a488cd44">logwarn</a>(<span class="stringliteral">&quot;Field %s not found in MP %s, not reporting\n&quot;</span>, fname, mp-&gt;<a class="code" href="structOmlMP.html#a5f99c0c042cdd120e19271c716d3eaac">name</a>);</div>
<div class="line"></div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">          <a class="code" href="mstring_8c.html#ad28234c6cddf0af9ad2c538885e70ebf">mstring_sprintf</a>(subject, <span class="stringliteral">&quot;.%s&quot;</span>, fname);</div>
<div class="line"></div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="omlc_8h.html#a13be9537ef85ccdc463a6172d4716d3a">omlc_set_string</a>(v[0], <a class="code" href="mstring_8c.html#ab18dbe1f8aa51964e0a15813991daf73">mstring_buf</a>(subject));</div>
<div class="line">    <a class="code" href="omlc_8h.html#a13be9537ef85ccdc463a6172d4716d3a">omlc_set_string</a>(v[1], key);</div>
<div class="line">    <a class="code" href="omlc_8h.html#acc937f4c5d6c581360ddb3862e83590d">omlc_copy_string</a>(v[2], *value);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="api_8c.html#ac714a82b22dfcc34a6b6130e047f2ab7">omlc_inject</a>(<a class="code" href="api_8c.html#ab37d06b7aa57f34099a4dbcff29635b7">schema0</a>, v);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="omlc_8h.html#a1434bd8b5a841357336609930bdb05c3">omlc_reset_string</a>(v[0]);</div>
<div class="line">    <a class="code" href="omlc_8h.html#a1434bd8b5a841357336609930bdb05c3">omlc_reset_string</a>(v[1]);</div>
<div class="line">    <a class="code" href="omlc_8h.html#a1434bd8b5a841357336609930bdb05c3">omlc_reset_string</a>(v[2]);</div>
<div class="line">    <a class="code" href="mstring_8c.html#a22eb366ee3317407b4233d6216b690a3">mstring_delete</a>(subject);</div>
<div class="line"></div>
<div class="line">    ret = 0;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a3d45237584ca128d367f3a1cdce3b1ad"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void omlc_process </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structOmlMP.html">OmlMP</a> *&#160;</td>
          <td class="paramname"><em>mp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="unionOmlValueU.html">OmlValueU</a> *&#160;</td>
          <td class="paramname"><em>values</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>DEPRECATED </p>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="omlc_8h.html#ac714a82b22dfcc34a6b6130e047f2ab7">omlc_inject</a> </dd></dl>

<p>Definition at line <a class="el" href="api_8c_source.html#l00120">120</a> of file <a class="el" href="api_8c_source.html">api.c</a>.</p>

<p>References <a class="el" href="log_8c_source.html#l00309">logwarn()</a>, and <a class="el" href="api_8c_source.html#l00149">omlc_inject()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="log_8c.html#ac65b3f90d3228474368b2b48a488cd44">logwarn</a>(<span class="stringliteral">&quot;&#39;omlc_process&#39; is deprecated, use &#39;omlc_inject&#39; instead\n&quot;</span>);</div>
<div class="line">  <a class="code" href="api_8c.html#ac714a82b22dfcc34a6b6130e047f2ab7">omlc_inject</a>(mp, values);</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<h2>Variable Documentation</h2>
<a class="anchor" id="ab37d06b7aa57f34099a4dbcff29635b7"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structOmlMP.html">OmlMP</a>* schema0</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="init_8c_source.html#l00050">50</a> of file <a class="el" href="init_8c_source.html">init.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_97aefd0d527b934f1d99a682da8fe6a9.html">lib</a></li><li class="navelem"><a class="el" href="dir_faf4e77b1ae3fad210f246d6190ea8fa.html">client</a></li><li class="navelem"><a class="el" href="api_8c.html">api.c</a></li>
    <li class="footer">Generated on Thu Jun 25 2015 15:31:54 for oml2 by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.1.2 </li>
  </ul>
</div>
</body>
</html>
