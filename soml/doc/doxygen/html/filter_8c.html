<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>oml2: filter.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="oml_logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">oml2
   &#160;<span id="projectnumber">2.12.0pre.79-58cf-dirty</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('filter_8c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">filter.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>OML's client side filter engine.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;string.h&gt;</code><br/>
<code>#include &lt;stdlib.h&gt;</code><br/>
<code>#include &lt;pthread.h&gt;</code><br/>
<code>#include &lt;errno.h&gt;</code><br/>
<code>#include &lt;sys/time.h&gt;</code><br/>
<code>#include &lt;time.h&gt;</code><br/>
<code>#include &lt;unistd.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="omlc_8h_source.html">oml2/omlc.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="oml__filter_8h_source.html">oml2/oml_filter.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="oml__writer_8h_source.html">oml2/oml_writer.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="o__log_8h_source.html">ocomm/o_log.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="client_8h_source.html">client.h</a>&quot;</code><br/>
</div><div class="textblock"><div class="dynheader">
Include dependency graph for filter.c:</div>
<div class="dyncontent">
<div class="center"><img src="filter_8c__incl.png" border="0" usemap="#filter_8c" alt=""/></div>
<map name="filter_8c" id="filter_8c">
<area shape="rect" id="node17" href="omlc_8h.html" title="Public API of the OML client library." alt="" coords="417,315,511,344"/><area shape="rect" id="node27" href="o__log_8h.html" title="ocomm/o_log.h" alt="" coords="820,392,929,421"/><area shape="rect" id="node31" href="oml__filter_8h.html" title="Abstract interface for filters." alt="" coords="291,160,408,189"/><area shape="rect" id="node34" href="oml__writer_8h.html" title="Abstract interface for writers." alt="" coords="283,237,408,267"/><area shape="rect" id="node39" href="client_8h.html" title="Defines various structures and functions used by various parts." alt="" coords="507,83,571,112"/><area shape="rect" id="node47" href="oml__out__stream_8h.html" title="Abstract interface for output streams." alt="" coords="544,315,701,344"/><area shape="rect" id="node50" href="mstring_8h.html" title="mstring.h" alt="" coords="720,237,795,267"/></map>
</div>
</div>
<p><a href="filter_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a78c99ffd76a7bb3c8c74db76207e9ab4"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="filter_8c.html#a78c99ffd76a7bb3c8c74db76207e9ab4">_XOPEN_SOURCE</a>&#160;&#160;&#160;500     /* Or: #define _BSD_SOURCE; for useconds_t to be defined */</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a730b7e126d2d76050b7af1f9f0854c61"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="filter_8c.html#a730b7e126d2d76050b7af1f9f0854c61">filter_engine_start</a> (<a class="el" href="structOmlMStream.html">OmlMStream</a> *ms)</td></tr>
<tr class="memitem:a83b227852fde95008f971b77ce142ee7"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="filter_8c.html#a83b227852fde95008f971b77ce142ee7">filter_process</a> (<a class="el" href="structOmlMStream.html">OmlMStream</a> *ms)</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:ae265e6c78eb3c0a1f4fdb40fe894394e"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structOmlClient.html">OmlClient</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="filter_8c.html#ae265e6c78eb3c0a1f4fdb40fe894394e">omlc_instance</a></td></tr>
</table>
<a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>OML's client side filter engine. </p>

<p>Definition in file <a class="el" href="filter_8c_source.html">filter.c</a>.</p>
</div><h2>Macro Definition Documentation</h2>
<a class="anchor" id="a78c99ffd76a7bb3c8c74db76207e9ab4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define _XOPEN_SOURCE&#160;&#160;&#160;500     /* Or: #define _BSD_SOURCE; for useconds_t to be defined */</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="filter_8c_source.html#l00033">33</a> of file <a class="el" href="filter_8c_source.html">filter.c</a>.</p>

</div>
</div>
<h2>Function Documentation</h2>
<a class="anchor" id="a730b7e126d2d76050b7af1f9f0854c61"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void filter_engine_start </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structOmlMStream.html">OmlMStream</a> *&#160;</td>
          <td class="paramname"><em>ms</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Start the filtering engine on the given MS </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ms</td><td>pointer to <a class="el" href="structOmlMStream.html">OmlMStream</a> to start filtering on </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="filter_8c_source.html#l00050">50</a> of file <a class="el" href="filter_8c_source.html">filter.c</a>.</p>

<p>References <a class="el" href="omlc_8h_source.html#l00769">OmlMStream::filter_thread</a>, <a class="el" href="log_8c_source.html#l00333">logdebug()</a>, and <a class="el" href="omlc_8h_source.html#l00739">OmlMStream::table_name</a>.</p>

<p>Referenced by <a class="el" href="init_8c_source.html#l01153">oml_mp_get_default_ms()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;Starting filtering thread for MS &#39;%s&#39;\n&quot;</span>, ms-&gt;<a class="code" href="structOmlMStream.html#a0613b1a0952e979da8fc278dc9b3c280">table_name</a>);</div>
<div class="line">  pthread_create(&amp;ms-&gt;<a class="code" href="structOmlMStream.html#a254042fcbc6a171ef015966cc6d4fe5c">filter_thread</a>, NULL, thread_start, (<span class="keywordtype">void</span>*)ms);</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a83b227852fde95008f971b77ce142ee7"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int filter_process </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structOmlMStream.html">OmlMStream</a> *&#160;</td>
          <td class="paramname"><em>ms</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Run filters associated to an MS.</p>
<p>Get the writer associated to the MS, and generate and write initial metadata (seqno and time). Then, instruct all the filters, in sequence, to write their filtered sample to this writer before finalising the write.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ms</td><td>MS to generate output for </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 if success, -1 otherwise</dd></dl>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="structOmlWriter.html">OmlWriter</a>, <a class="el" href="oml__writer_8h.html#a41b081311eb21b4b76a31ae86a66dfe8">oml_writer_row_start</a>, <a class="el" href="oml__writer_8h.html#a43b4f370f713129f2c4abb9311e20b52">oml_writer_out</a>, <a class="el" href="oml__writer_8h.html#ada67a09a0370a5eb8be837a3be7b4293">oml_writer_row_end</a> </dd></dl>

<p>Definition at line <a class="el" href="filter_8c_source.html#l00103">103</a> of file <a class="el" href="filter_8c_source.html">filter.c</a>.</p>

<p>References <a class="el" href="omlc_8h_source.html#l00790">OmlMStream::dropped</a>, <a class="el" href="log_8c_source.html#l00297">logerror()</a>, <a class="el" href="log_8c_source.html#l00309">logwarn()</a>, <a class="el" href="oml__filter_8h_source.html#l00146">OmlFilter::newwindow</a>, <a class="el" href="oml__filter_8h_source.html#l00143">OmlFilter::next</a>, <a class="el" href="omlc_8h_source.html#l00784">OmlMStream::nwriters</a>, <a class="el" href="oml__filter_8h_source.html#l00121">OmlFilter::output</a>, <a class="el" href="oml__writer_8h_source.html#l00108">OmlWriter::row_end</a>, <a class="el" href="oml__writer_8h_source.html#l00106">OmlWriter::row_start</a>, <a class="el" href="omlc_8h_source.html#l00756">OmlMStream::sample_size</a>, <a class="el" href="omlc_8h_source.html#l00764">OmlMStream::seq_no</a>, <a class="el" href="client_8h_source.html#l00057">OmlClient::start_time</a>, <a class="el" href="omlc_8h_source.html#l00739">OmlMStream::table_name</a>, <a class="el" href="omlc_8h_source.html#l00782">OmlMStream::writers</a>, and <a class="el" href="omlc_8h_source.html#l00787">OmlMStream::written</a>.</p>

<p>Referenced by <a class="el" href="init_8c_source.html#l01088">destroy_ms()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="keyword">struct </span>timeval tv;</div>
<div class="line">  <span class="keywordtype">double</span> now;</div>
<div class="line">  <span class="keywordtype">int</span> i;</div>
<div class="line">  <a class="code" href="structOmlFilter.html">OmlFilter</a> *f;</div>
<div class="line">  <a class="code" href="structOmlWriter.html">OmlWriter</a> *writer;</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Get the time as soon as possible */</span></div>
<div class="line">  gettimeofday(&amp;tv, NULL);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (ms == NULL || <a class="code" href="client_8h.html#ae265e6c78eb3c0a1f4fdb40fe894394e">omlc_instance</a> == NULL || ms-&gt;<a class="code" href="structOmlMStream.html#ad436c40e7e14ae11cde0361871a7eabd">writers</a> == NULL) {</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Could not process filters because of null measurement stream, instance or writers array\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  now = tv.tv_sec - <a class="code" href="client_8h.html#ae265e6c78eb3c0a1f4fdb40fe894394e">omlc_instance</a>-&gt;<a class="code" href="structOmlClient.html#a89d86ad01212dc1bcde47399d890fa2e">start_time</a> + 0.000001 * tv.tv_usec;</div>
<div class="line">  ms-&gt;<a class="code" href="structOmlMStream.html#acfa303e0a07d706a78729571ac32b9d9">seq_no</a>++;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (i=0; i&lt;ms-&gt;<a class="code" href="structOmlMStream.html#a98172393f791aba57e2431a97f332ba2">nwriters</a>; i++) {</div>
<div class="line">    writer = ms-&gt;<a class="code" href="structOmlMStream.html#ad436c40e7e14ae11cde0361871a7eabd">writers</a>[i];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (writer == NULL) {</div>
<div class="line">      <a class="code" href="log_8c.html#ac65b3f90d3228474368b2b48a488cd44">logwarn</a>(<span class="stringliteral">&quot;%s: Sending data NULL writer (at %d)\n&quot;</span>, ms-&gt;<a class="code" href="structOmlMStream.html#a0613b1a0952e979da8fc278dc9b3c280">table_name</a>, i);</div>
<div class="line"></div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <span class="comment">/* Be aware that row_start is obtaining a lock on the writer</span></div>
<div class="line"><span class="comment">       * which is released in row_end. Always ensure that row_end is</span></div>
<div class="line"><span class="comment">       * called, even if there is a problem somewhere along the way.</span></div>
<div class="line"><span class="comment">       * \see oml_writer_row_start, oml_writer_out, oml_writer_row_end</span></div>
<div class="line"><span class="comment">       */</span></div>
<div class="line">      <span class="keywordflow">if</span>(writer-&gt;<a class="code" href="structOmlWriter.html#af7b417adb595f8e5d46112640825f6ea">row_start</a>(writer, ms, now) == 1)</div>
<div class="line">        ms-&gt;<a class="code" href="structOmlMStream.html#ae4727d93738998bab105ab7517ce55af">written</a>++;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        ms-&gt;<a class="code" href="structOmlMStream.html#a4f5c723592bdb37e866fe008e736604b">dropped</a>++;</div>
<div class="line"></div>
<div class="line">      f = ms-&gt;firstFilter;</div>
<div class="line">      for (; f != NULL; f = f-&gt;<a class="code" href="structOmlFilter.html#a702d8421bfd416f22633b0cc470e1f3a">next</a>) {</div>
<div class="line">        f-&gt;<a class="code" href="structOmlFilter.html#ab9dc92b278133b3245fcd6b2a6d9af13">output</a>(f, writer);</div>
<div class="line">      }</div>
<div class="line">      writer-&gt;<a class="code" href="structOmlWriter.html#a981ccb2404200aece3ea6574386ccf67">row_end</a>(writer, ms);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  f = ms-&gt;firstFilter;</div>
<div class="line">  <span class="keywordflow">for</span> (; f != NULL; f = f-&gt;<a class="code" href="structOmlFilter.html#a702d8421bfd416f22633b0cc470e1f3a">next</a>) {</div>
<div class="line">    f-&gt;<a class="code" href="structOmlFilter.html#ac40bc61108b29179955ea7393b85a78a">newwindow</a>(f);</div>
<div class="line">  }</div>
<div class="line">  ms-&gt;<a class="code" href="structOmlMStream.html#ada9e11ba6d89e2cca0787a65fb2b2c9d">sample_size</a> = 0;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<h2>Variable Documentation</h2>
<a class="anchor" id="ae265e6c78eb3c0a1f4fdb40fe894394e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structOmlClient.html">OmlClient</a>* omlc_instance</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Global <a class="el" href="structOmlClient.html">OmlClient</a> instance </p>

<p>Definition at line <a class="el" href="init_8c_source.html#l00040">40</a> of file <a class="el" href="init_8c_source.html">init.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_97aefd0d527b934f1d99a682da8fe6a9.html">lib</a></li><li class="navelem"><a class="el" href="dir_faf4e77b1ae3fad210f246d6190ea8fa.html">client</a></li><li class="navelem"><a class="el" href="filter_8c.html">filter.c</a></li>
    <li class="footer">Generated on Thu Jun 25 2015 15:31:55 for oml2 by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.1.2 </li>
  </ul>
</div>
</body>
</html>
