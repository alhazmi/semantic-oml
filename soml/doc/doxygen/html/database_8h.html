<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>oml2: database.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="oml_logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">oml2
   &#160;<span id="projectnumber">2.12.0pre.79-58cf-dirty</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('database_8h.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">database.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Interface that storage backend need to implement to be usable by the server.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="omlc_8h_source.html">oml2/omlc.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="mstring_8h_source.html">mstring.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="table__descr_8h_source.html">table_descr.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="schema_8h_source.html">schema.h</a>&quot;</code><br/>
</div><div class="textblock"><div class="dynheader">
Include dependency graph for database.h:</div>
<div class="dyncontent">
<div class="center"><img src="database_8h__incl.png" border="0" usemap="#database_8h" alt=""/></div>
<map name="database_8h" id="database_8h">
<area shape="rect" id="node3" href="omlc_8h.html" title="Public API of the OML client library." alt="" coords="309,237,403,267"/><area shape="rect" id="node21" href="mstring_8h.html" title="mstring.h" alt="" coords="543,237,617,267"/><area shape="rect" id="node24" href="table__descr_8h.html" title="table_descr.h" alt="" coords="444,83,543,112"/><area shape="rect" id="node26" href="schema_8h.html" title="schema.h" alt="" coords="424,160,501,189"/><area shape="rect" id="node17" href="o__log_8h.html" title="ocomm/o_log.h" alt="" coords="464,315,573,344"/></map>
</div>
</div><div class="textblock"><div class="dynheader">
This graph shows which files directly or indirectly include this file:</div>
<div class="dyncontent">
<div class="center"><img src="database_8h__dep__incl.png" border="0" usemap="#database_8hdep" alt=""/></div>
<map name="database_8hdep" id="database_8hdep">
<area shape="rect" id="node3" href="client__handler_8h.html" title="client_handler.h" alt="" coords="219,83,331,112"/><area shape="rect" id="node7" href="oml2-server_8c.html" title="Main oml2&#45;server functions." alt="" coords="507,169,608,199"/><area shape="rect" id="node9" href="check__binary__protocol_8c.html" title="check_binary_protocol.c" alt="" coords="197,256,360,285"/><area shape="rect" id="node16" href="check__text__protocol_8c.html" title="check_text_protocol.c" alt="" coords="391,256,540,285"/><area shape="rect" id="node20" href="database_8c.html" title="Generic interface for database backends." alt="" coords="733,169,819,199"/><area shape="rect" id="node22" href="sqlite__adapter_8h.html" title="sqlite_adapter.h" alt="" coords="639,83,753,112"/><area shape="rect" id="node26" href="sqlite__adapter_8c.html" title="Adapter code for the SQLite3 database backend." alt="" coords="843,169,957,199"/><area shape="rect" id="node30" href="fuseki__adapter_8h.html" title="fuseki_adapter.h" alt="" coords="1289,83,1407,112"/><area shape="rect" id="node33" href="fuseki__adapter-new-yahya_8c.html" title="fuseki_adapter&#45;new\l&#45;yahya.c" alt="" coords="1133,161,1267,207"/><area shape="rect" id="node35" href="fuseki__adapter_8c.html" title="fuseki_adapter.c" alt="" coords="1291,169,1408,199"/><area shape="rect" id="node37" href="fuseki__adapter__beforeyahyachanges_8c.html" title="fuseki_adapter_beforeyahyachanges.c" alt="" coords="1432,169,1677,199"/><area shape="rect" id="node39" href="fuseki__adapter__in__progress_8c.html" title="fuseki_adapter_in_progress.c" alt="" coords="1701,169,1893,199"/><area shape="rect" id="node41" href="fuseki__adapter__working_8c.html" title="fuseki_adapter_working.c" alt="" coords="1917,169,2088,199"/><area shape="rect" id="node44" href="virtuoso__adapter_8h.html" title="virtuoso_adapter.h" alt="" coords="828,83,956,112"/><area shape="rect" id="node48" href="virtuoso__adapter_8c.html" title="virtuoso_adapter.c" alt="" coords="981,169,1109,199"/><area shape="rect" id="node50" href="database__adapter_8c.html" title="database_adapter.c" alt="" coords="2112,169,2248,199"/><area shape="rect" id="node52" href="database__adapter_8h.html" title="Generic functions for database adapters." alt="" coords="1485,83,1621,112"/><area shape="rect" id="node60" href="psql__adapter_8c.html" title="Adapter code for the PostgreSQL database backend." alt="" coords="2272,169,2379,199"/><area shape="rect" id="node71" href="psql__adapter_8h.html" title="psql_adapter.h" alt="" coords="1979,83,2085,112"/><area shape="rect" id="node5" href="client__handler_8c.html" title="The client handler receives callbacks from the eventloop and processes messages in either OML&#39;s text ..." alt="" coords="85,169,197,199"/><area shape="rect" id="node11" href="check__server_8h.html" title="check_server.h" alt="" coords="221,169,331,199"/><area shape="rect" id="node14" href="check__server_8c.html" title="check_server.c" alt="" coords="5,256,115,285"/></map>
</div>
</div>
<p><a href="database_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structDbTable.html">DbTable</a></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structDatabase.html">Database</a></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structdb__typemap.html">db_typemap</a></td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:acefac27bcace3ecccbbc29141a899da9"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#acefac27bcace3ecccbbc29141a899da9">DEFAULT_DB_BACKEND</a>&#160;&#160;&#160;&quot;sqlite&quot;</td></tr>
<tr class="memitem:ac7c577d62e3d70f8dfee2a55a5d0e871"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#ac7c577d62e3d70f8dfee2a55a5d0e871">MAX_DB_NAME_SIZE</a>&#160;&#160;&#160;64</td></tr>
<tr class="memitem:a89637dad801616250bfa44c90c18e1be"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a89637dad801616250bfa44c90c18e1be">MAX_TABLE_NAME_SIZE</a>&#160;&#160;&#160;64</td></tr>
<tr class="memitem:a00ab022e18934817899722676173752f"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a00ab022e18934817899722676173752f">MAX_COL_NAME_SIZE</a>&#160;&#160;&#160;64</td></tr>
<tr class="memitem:a0154bdabfb90498331c1810ad20a4dba"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a0154bdabfb90498331c1810ad20a4dba">MAX_TABLE_RENAME</a>&#160;&#160;&#160;10</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:a5c0c379feaff078ac5045a0722a20ea2"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structDbTable.html">DbTable</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a5c0c379feaff078ac5045a0722a20ea2">DbTable</a></td></tr>
<tr class="memitem:a5c629e2ad1aa7588943c7009e9073b20"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structDatabase.html">Database</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a5c629e2ad1aa7588943c7009e9073b20">Database</a></td></tr>
<tr class="memitem:a8fcf84fbdf5d530754f5091e67149a54"><td class="memItemLeft" align="right" valign="top">typedef <a class="el" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012">OmlValueT</a>(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a8fcf84fbdf5d530754f5091e67149a54">db_adapter_type_to_oml</a> )(const char *<a class="el" href="check__libshared__headers_8c.html#a23506fc4821ab6d9671f3e6222591a96">type</a>)</td></tr>
<tr class="memitem:a1e4ff1cafb2218af62502f870ad39847"><td class="memItemLeft" align="right" valign="top">typedef const char *(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a1e4ff1cafb2218af62502f870ad39847">db_adapter_oml_to_type</a> )(<a class="el" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012">OmlValueT</a> <a class="el" href="check__libshared__headers_8c.html#a23506fc4821ab6d9671f3e6222591a96">type</a>)</td></tr>
<tr class="memitem:a8c2a88c4aff084ea780ae8a963734335"><td class="memItemLeft" align="right" valign="top">typedef int(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a8c2a88c4aff084ea780ae8a963734335">db_adapter_stmt</a> )(<a class="el" href="structDatabase.html">Database</a> *db, const char *stmt)</td></tr>
<tr class="memitem:a32151956d5be8c713abfd682578ee467"><td class="memItemLeft" align="right" valign="top">typedef int(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a32151956d5be8c713abfd682578ee467">db_adapter_create</a> )(<a class="el" href="structDatabase.html">Database</a> *db)</td></tr>
<tr class="memitem:aae500dd136c0003d777ce18d26212171"><td class="memItemLeft" align="right" valign="top">typedef void(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#aae500dd136c0003d777ce18d26212171">db_adapter_release</a> )(<a class="el" href="structDatabase.html">Database</a> *db)</td></tr>
<tr class="memitem:ac4d31692f155b3354e67d3fcbc07fc90"><td class="memItemLeft" align="right" valign="top">typedef int(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#ac4d31692f155b3354e67d3fcbc07fc90">db_adapter_table_create</a> )(<a class="el" href="structDatabase.html">Database</a> *db, <a class="el" href="structDbTable.html">DbTable</a> *table, int shallow)</td></tr>
<tr class="memitem:a1e93d685a8ccd6745080d3dcd915c74f"><td class="memItemLeft" align="right" valign="top">typedef int(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a1e93d685a8ccd6745080d3dcd915c74f">db_adapter_table_create_meta</a> )(<a class="el" href="structDatabase.html">Database</a> *db, const char *<a class="el" href="check__text__protocol_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)</td></tr>
<tr class="memitem:a8b49cea45b378400383e9448b1b316a8"><td class="memItemLeft" align="right" valign="top">typedef int(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a8b49cea45b378400383e9448b1b316a8">db_adapter_table_free</a> )(<a class="el" href="structDatabase.html">Database</a> *db, <a class="el" href="structDbTable.html">DbTable</a> *table)</td></tr>
<tr class="memitem:aa9d9a46ac301760f90b765ac0e045074"><td class="memItemLeft" align="right" valign="top">typedef char *(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#aa9d9a46ac301760f90b765ac0e045074">db_adapter_prepared_var</a> )(<a class="el" href="structDatabase.html">Database</a> *db, unsigned int order)</td></tr>
<tr class="memitem:ad458d4c2cd62ce366f690afc5796d33e"><td class="memItemLeft" align="right" valign="top">typedef <a class="el" href="structMString.html">MString</a> *(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#ad458d4c2cd62ce366f690afc5796d33e">db_adapter_prepare</a> )(<a class="el" href="structDatabase.html">Database</a> *db, <a class="el" href="structDbTable.html">DbTable</a> *table)</td></tr>
<tr class="memitem:af8c0c322a12c1d493b946742223e6eec"><td class="memItemLeft" align="right" valign="top">typedef int(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#af8c0c322a12c1d493b946742223e6eec">db_adapter_insert</a> )(<a class="el" href="structDatabase.html">Database</a> *db, <a class="el" href="structDbTable.html">DbTable</a> *table, int sender_id, int seq_no, double time_stamp, <a class="el" href="structOmlValue.html">OmlValue</a> *values, int value_count)</td></tr>
<tr class="memitem:a662d942361360b8bd25284f96a9ff06c"><td class="memItemLeft" align="right" valign="top">typedef char *(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a662d942361360b8bd25284f96a9ff06c">db_adapter_get_metadata</a> )(<a class="el" href="structDatabase.html">Database</a> *db, const char *key)</td></tr>
<tr class="memitem:a4bf257b6bcdc58acfc1ea1b71434bf69"><td class="memItemLeft" align="right" valign="top">typedef int(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a4bf257b6bcdc58acfc1ea1b71434bf69">db_adapter_set_metadata</a> )(<a class="el" href="structDatabase.html">Database</a> *db, const char *key, const char *value)</td></tr>
<tr class="memitem:aeb1572e4fda9459900ac8bf9cf10bb11"><td class="memItemLeft" align="right" valign="top">typedef char *(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#aeb1572e4fda9459900ac8bf9cf10bb11">db_adapter_get_uri</a> )(<a class="el" href="structDatabase.html">Database</a> *db, char *uri, size_t size)</td></tr>
<tr class="memitem:aa8fb9d2f557163cc43605cb82035eb71"><td class="memItemLeft" align="right" valign="top">typedef int(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#aa8fb9d2f557163cc43605cb82035eb71">db_add_sender_id</a> )(<a class="el" href="structDatabase.html">Database</a> *db, const char *sender_id)</td></tr>
<tr class="memitem:a3527b447d453a3afdd0fdfe0a0e2780f"><td class="memItemLeft" align="right" valign="top">typedef <a class="el" href="structTableDescr.html">TableDescr</a> *(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a3527b447d453a3afdd0fdfe0a0e2780f">db_adapter_get_table_list</a> )(<a class="el" href="structDatabase.html">Database</a> *db, int *num_tables)</td></tr>
<tr class="memitem:a539775aaa61b8f2cd168842a7e90d5a5"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structdb__typemap.html">db_typemap</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a539775aaa61b8f2cd168842a7e90d5a5">db_typemap</a></td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:adf175cbb06ea894cfbfa63eb6e056f12"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#adf175cbb06ea894cfbfa63eb6e056f12">database_setup_backend</a> (const char *backend)</td></tr>
<tr class="memitem:a908e1a6a7d15f4d9658fd0b2347667fd"><td class="memItemLeft" align="right" valign="top"><a class="el" href="database_8h.html#a32151956d5be8c713abfd682578ee467">db_adapter_create</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a908e1a6a7d15f4d9658fd0b2347667fd">database_create_function</a> (const char *backend)</td></tr>
<tr class="memitem:a6d78305dc93b0061ec6933dd99ad09da"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structDatabase.html">Database</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a6d78305dc93b0061ec6933dd99ad09da">database_find</a> (const char *<a class="el" href="check__text__protocol_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)</td></tr>
<tr class="memitem:a32ef977dd18a7370f0fe2d853d630591"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a32ef977dd18a7370f0fe2d853d630591">database_init</a> (<a class="el" href="structDatabase.html">Database</a> *self)</td></tr>
<tr class="memitem:a3f369cdf1c05d569973b42fdd8d5fadd"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a3f369cdf1c05d569973b42fdd8d5fadd">database_release</a> (<a class="el" href="structDatabase.html">Database</a> *database)</td></tr>
<tr class="memitem:a23a180ee6d2b981f8f5c95224db665ae"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a23a180ee6d2b981f8f5c95224db665ae">database_cleanup</a> ()</td></tr>
<tr class="memitem:a56b56af184ae0175a660fea4a7cec0d3"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structDbTable.html">DbTable</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a56b56af184ae0175a660fea4a7cec0d3">database_find_table</a> (<a class="el" href="structDatabase.html">Database</a> *database, const char *<a class="el" href="check__text__protocol_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)</td></tr>
<tr class="memitem:aff50a94959037620c59c4571a60e32ee"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structDbTable.html">DbTable</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#aff50a94959037620c59c4571a60e32ee">database_find_or_create_table</a> (<a class="el" href="structDatabase.html">Database</a> *database, struct <a class="el" href="structschema.html">schema</a> *<a class="el" href="structschema.html">schema</a>)</td></tr>
<tr class="memitem:af470dc8d827b3e372fb1bf81e1ca7bd1"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structDbTable.html">DbTable</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#af470dc8d827b3e372fb1bf81e1ca7bd1">database_create_table</a> (<a class="el" href="structDatabase.html">Database</a> *database, const struct <a class="el" href="structschema.html">schema</a> *<a class="el" href="structschema.html">schema</a>)</td></tr>
<tr class="memitem:a2a5cfaa80f79620f4e762a48a8446991"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a2a5cfaa80f79620f4e762a48a8446991">database_table_free</a> (<a class="el" href="structDatabase.html">Database</a> *database, <a class="el" href="structDbTable.html">DbTable</a> *table)</td></tr>
<tr class="memitem:a7300a86afceccbde1c8889f2166c0b30"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structMString.html">MString</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="database_8h.html#a7300a86afceccbde1c8889f2166c0b30">database_make_sql_insert</a> (<a class="el" href="structDatabase.html">Database</a> *db, <a class="el" href="structDbTable.html">DbTable</a> *table)</td></tr>
</table>
<a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>Interface that storage backend need to implement to be usable by the server. </p>

<p>Definition in file <a class="el" href="database_8h_source.html">database.h</a>.</p>
</div><h2>Macro Definition Documentation</h2>
<a class="anchor" id="acefac27bcace3ecccbbc29141a899da9"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEFAULT_DB_BACKEND&#160;&#160;&#160;&quot;sqlite&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="database_8h_source.html#l00021">21</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="a00ab022e18934817899722676173752f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAX_COL_NAME_SIZE&#160;&#160;&#160;64</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="database_8h_source.html#l00025">25</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="ac7c577d62e3d70f8dfee2a55a5d0e871"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAX_DB_NAME_SIZE&#160;&#160;&#160;64</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="database_8h_source.html#l00023">23</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

<p>Referenced by <a class="el" href="database_8c_source.html#l00214">database_find()</a>.</p>

</div>
</div>
<a class="anchor" id="a89637dad801616250bfa44c90c18e1be"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAX_TABLE_NAME_SIZE&#160;&#160;&#160;64</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="database_8h_source.html#l00024">24</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="a0154bdabfb90498331c1810ad20a4dba"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAX_TABLE_RENAME&#160;&#160;&#160;10</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Limit on the number of times the server tries to generate a table name for a different schema.</p>
<p>XXX: If this is changed, make sure enough memory is allocated in <a class="el" href="database_8c.html#aff50a94959037620c59c4571a60e32ee">database_find_or_create_table()</a> to hold the new table name in the schema structure. </p>

<p>Definition at line <a class="el" href="database_8h_source.html#l00035">35</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

<p>Referenced by <a class="el" href="database_8c_source.html#l00396">database_find_or_create_table()</a>.</p>

</div>
</div>
<h2>Typedef Documentation</h2>
<a class="anchor" id="a5c629e2ad1aa7588943c7009e9073b20"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structDatabase.html">Database</a> <a class="el" href="structDatabase.html">Database</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="database_8h_source.html#l00040">40</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="a32151956d5be8c713abfd682578ee467"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef int(* db_adapter_create)(<a class="el" href="structDatabase.html">Database</a> *db)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Create a database adapter structures</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">db</td><td>basic <a class="el" href="structDatabase.html">Database</a> structure to associate with the database </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 if successful, -1 otherwise </dd></dl>

<p>Definition at line <a class="el" href="database_8h_source.html#l00073">73</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="a662d942361360b8bd25284f96a9ff06c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef char*(* db_adapter_get_metadata)(<a class="el" href="structDatabase.html">Database</a> *db, const char *key)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Get data from the metadata table</p>
<p>The returned string should be oml_free'd by the caller when no longer needed.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">key</td><td>key to lookup </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>an oml_malloc'd string containing the current value for that key</dd></dl>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="mem_8h.html#a8616cb714d6589098267bba8fc7b48c2">oml_malloc</a>, <a class="el" href="mem_8h.html#aa191af748bdc144fc077967bdacaaf70">oml_free</a> </dd></dl>

<p>Definition at line <a class="el" href="database_8h_source.html#l00140">140</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="a3527b447d453a3afdd0fdfe0a0e2780f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef <a class="el" href="structTableDescr.html">TableDescr</a>*(* db_adapter_get_table_list)(<a class="el" href="structDatabase.html">Database</a> *db, int *num_tables)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Get a list of tables</p>
<p>The list of tables should also include _experiment_metadata and _senders, even though they might not be defined with a schema string.</p>
<p>The caller should oml_free the returned values when no longer needed.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">db</td><td><a class="el" href="structDatabase.html">Database</a> to list tables of </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">num_tables</td><td>pointer to an integer where the number of tables will be written, set to -1 on error </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>a linked list of <a class="el" href="structTableDescr.html">TableDescr</a> of length *num_tables, or NULL</dd></dl>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="table__descr_8h.html#a6e6dcd63b4fe4d1f4f30cf29666530b1">table_descr_new</a>, <a class="el" href="table__descr_8h.html#a54eea9971d4f144bdc791bbb7f7261e4">table_descr_list_free</a> </dd></dl>

<p>Definition at line <a class="el" href="database_8h_source.html#l00184">184</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="aeb1572e4fda9459900ac8bf9cf10bb11"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef char*(* db_adapter_get_uri)(<a class="el" href="structDatabase.html">Database</a> *db, char *uri, size_t size)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Get a URI to this database</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">db</td><td><a class="el" href="structDatabase.html">Database</a> object </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">uri</td><td>output string buffer </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">size</td><td>length of uri </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>uri on success, NULL otherwise (e.g., uri buffer too small) </dd></dl>

<p>Definition at line <a class="el" href="database_8h_source.html#l00157">157</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="af8c0c322a12c1d493b946742223e6eec"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef int(* db_adapter_insert)(<a class="el" href="structDatabase.html">Database</a> *db, <a class="el" href="structDbTable.html">DbTable</a> *table, int sender_id, int seq_no, double time_stamp, <a class="el" href="structOmlValue.html">OmlValue</a> *values, int value_count)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Insert value in the a table of a database</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">db</td><td><a class="el" href="structDatabase.html">Database</a> to write in </td></tr>
    <tr><td class="paramname">table</td><td><a class="el" href="structDbTable.html">DbTable</a> to insert data in </td></tr>
    <tr><td class="paramname">sender_id</td><td>sender ID </td></tr>
    <tr><td class="paramname">seq_no</td><td>sequence number </td></tr>
    <tr><td class="paramname">time_stamp</td><td>timestamp of the receiving data </td></tr>
    <tr><td class="paramname">values</td><td><a class="el" href="structOmlValue.html">OmlValue</a> array to insert </td></tr>
    <tr><td class="paramname">value_count</td><td>number of values </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 if successful, -1 otherwise </dd></dl>

<p>Definition at line <a class="el" href="database_8h_source.html#l00129">129</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="a1e4ff1cafb2218af62502f870ad39847"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef const char*(* db_adapter_oml_to_type)(<a class="el" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012">OmlValueT</a> <a class="el" href="check__libshared__headers_8c.html#a23506fc4821ab6d9671f3e6222591a96">type</a>)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Mapping from OML to native types.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">type</td><td>string describing the SQLite3 type </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the corresponding OmlValueT or OML_UNKNOWN_VALUE if unknown </dd></dl>

<p>Definition at line <a class="el" href="database_8h_source.html#l00054">54</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="ad458d4c2cd62ce366f690afc5796d33e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef <a class="el" href="structMString.html">MString</a>*(* db_adapter_prepare)(<a class="el" href="structDatabase.html">Database</a> *db, <a class="el" href="structDbTable.html">DbTable</a> *table)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="database_8h_source.html#l00116">116</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="aa9d9a46ac301760f90b765ac0e045074"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef char*(* db_adapter_prepared_var)(<a class="el" href="structDatabase.html">Database</a> *db, unsigned int order)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Return a string suitable to represent an unbound variable in a prepared statement.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">db</td><td>pointer to <a class="el" href="structDatabase.html">Database</a> </td></tr>
    <tr><td class="paramname">order</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>an oml_malloc'd string to be freed by the caller, or NULL on error </dd></dl>

<p>Definition at line <a class="el" href="database_8h_source.html#l00114">114</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="aae500dd136c0003d777ce18d26212171"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef void(* db_adapter_release)(<a class="el" href="structDatabase.html">Database</a> *db)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Release the database.</p>
<p>This is called when the last active client leaves.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">db</td><td><a class="el" href="structDatabase.html">Database</a> to release </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="database_8h_source.html#l00081">81</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="a4bf257b6bcdc58acfc1ea1b71434bf69"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef int(* db_adapter_set_metadata)(<a class="el" href="structDatabase.html">Database</a> *db, const char *key, const char *value)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Set data in the metadata table</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">key</td><td>key to lookup </td></tr>
    <tr><td class="paramname">value</td><td>a string to set for that key </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success, -1 otherwise </dd></dl>

<p>Definition at line <a class="el" href="database_8h_source.html#l00148">148</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="a8c2a88c4aff084ea780ae8a963734335"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef int(* db_adapter_stmt)(<a class="el" href="structDatabase.html">Database</a> *db, const char *stmt)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Execute an SQL statement with no data return.</p>
<p>This function executes a statement with the assumption that the result can be ignored; that is, it's not useful for SELECT statements.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">self</td><td>the database handle. </td></tr>
    <tr><td class="paramname">stmt</td><td>the SQL statement to execute. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 if successful, -1 if the database reports an error. </dd></dl>

<p>Definition at line <a class="el" href="database_8h_source.html#l00066">66</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="ac4d31692f155b3354e67d3fcbc07fc90"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef int(* db_adapter_table_create)(<a class="el" href="structDatabase.html">Database</a> *db, <a class="el" href="structDbTable.html">DbTable</a> *table, int shallow)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Create the adapter data structures required to represent a database table.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">db</td><td><a class="el" href="structDatabase.html">Database</a> to create the table adapter </td></tr>
    <tr><td class="paramname">table</td><td><a class="el" href="structDbTable.html">DbTable</a> description of the table to create </td></tr>
    <tr><td class="paramname">shallow</td><td>if 0, the table should be actively CREATEd in the database backend </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success, -1 on failure </dd></dl>

<p>Definition at line <a class="el" href="database_8h_source.html#l00090">90</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="a1e93d685a8ccd6745080d3dcd915c74f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef int(* db_adapter_table_create_meta)(<a class="el" href="structDatabase.html">Database</a> *db, const char *<a class="el" href="check__text__protocol_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Create a metadata table</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">db</td><td>pointer to <a class="el" href="structDatabase.html">Database</a> </td></tr>
    <tr><td class="paramname">name</td><td>name of the database table to create </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success, -1 otherwise </dd></dl>

<p>Definition at line <a class="el" href="database_8h_source.html#l00098">98</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="a8b49cea45b378400383e9448b1b316a8"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef int(* db_adapter_table_free)(<a class="el" href="structDatabase.html">Database</a> *db, <a class="el" href="structDbTable.html">DbTable</a> *table)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Free an SQLite3 table</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">database</td><td><a class="el" href="structDatabase.html">Database</a> in which the table is </td></tr>
    <tr><td class="paramname">table</td><td><a class="el" href="structDbTable.html">DbTable</a> structure to free </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success, &lt;0 otherwise </dd></dl>

<p>Definition at line <a class="el" href="database_8h_source.html#l00106">106</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="a8fcf84fbdf5d530754f5091e67149a54"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef <a class="el" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012">OmlValueT</a>(* db_adapter_type_to_oml)(const char *<a class="el" href="check__libshared__headers_8c.html#a23506fc4821ab6d9671f3e6222591a96">type</a>)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Mapping from native to OML types.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">type</td><td>string describing the SQLite3 type </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the corresponding OmlValueT or OML_UNKNOWN_VALUE if unknown </dd></dl>

<p>Definition at line <a class="el" href="database_8h_source.html#l00047">47</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="aa8fb9d2f557163cc43605cb82035eb71"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef int(* db_add_sender_id)(<a class="el" href="structDatabase.html">Database</a> *db, const char *sender_id)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Add a new sender to the database, returning its index.</p>
<p>If a sender with the given id already exists, its pre-existing index should be returned. Otherwise, a new sender is added to the table with a new sender id, unique to this experiment.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">db</td><td>the <a class="el" href="structDatabase.html">Database</a> to which the sender id is being added. </td></tr>
    <tr><td class="paramname">sender_id</td><td>the sender ID </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the index of the new sender </dd></dl>

<p>Definition at line <a class="el" href="database_8h_source.html#l00169">169</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<a class="anchor" id="a539775aaa61b8f2cd168842a7e90d5a5"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structdb__typemap.html">db_typemap</a>  <a class="el" href="structdb__typemap.html">db_typemap</a></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>A typemapping between OML types and their representation in the database backend </p>

</div>
</div>
<a class="anchor" id="a5c0c379feaff078ac5045a0722a20ea2"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structDbTable.html">DbTable</a> <a class="el" href="structDbTable.html">DbTable</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="database_8h_source.html#l00039">39</a> of file <a class="el" href="database_8h_source.html">database.h</a>.</p>

</div>
</div>
<h2>Function Documentation</h2>
<a class="anchor" id="a23a180ee6d2b981f8f5c95224db665ae"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void database_cleanup </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Close all open databases</p>
<p>Useful when exiting. </p>

<p>Definition at line <a class="el" href="database_8c_source.html#l00318">318</a> of file <a class="el" href="database_8c_source.html">database.c</a>.</p>

<p>References <a class="el" href="database_8c_source.html#l00270">database_release()</a>, <a class="el" href="log_8c_source.html#l00333">logdebug()</a>, and <a class="el" href="database_8h_source.html#l00249">Database::next</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="structDatabase.html">Database</a> *next, *db = first_db;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a>(<span class="stringliteral">&quot;Cleaning up databases\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">while</span> (db) {</div>
<div class="line">    next = db-&gt;<a class="code" href="structDatabase.html#acac99666d00c552a2692d954219a03ff">next</a>;</div>
<div class="line">    <a class="code" href="database_8c.html#a117606360dacfb5ba1624605829d9240">database_release</a>(db);</div>
<div class="line">    db = next;</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a908e1a6a7d15f4d9658fd0b2347667fd"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="database_8h.html#a32151956d5be8c713abfd682578ee467">db_adapter_create</a> database_create_function </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>backend</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Get the database-creation function for the selected backend.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">backend</td><td>name of the selected backed </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the backend's db_adapter_create function </dd></dl>

<p>Definition at line <a class="el" href="database_8c_source.html#l00196">196</a> of file <a class="el" href="database_8c_source.html">database.c</a>.</p>

<p>References <a class="el" href="oml__util_8h_source.html#l00027">LENGTH</a>, and <a class="el" href="init_8c_source.html#l01493">name</a>.</p>

<p>Referenced by <a class="el" href="database_8c_source.html#l00214">database_find()</a>, and <a class="el" href="database_8c_source.html#l00131">database_setup_backend()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> i = 0;</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="oml__util_8h.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a> (backends); i++)</div>
<div class="line">    <span class="keywordflow">if</span> (!strncmp (backend, backends[i].<a class="code" href="init_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, strlen (backends[i].name)))</div>
<div class="line">      <span class="keywordflow">return</span> backends[i].fn;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="af470dc8d827b3e372fb1bf81e1ca7bd1"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structDbTable.html">DbTable</a>* database_create_table </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structDatabase.html">Database</a> *&#160;</td>
          <td class="paramname"><em>database</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structschema.html">schema</a> *&#160;</td>
          <td class="paramname"><em>schema</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Create the adapter structure for a table.</p>
<p>Create a new table in the database, with given schema. Register the table with the database, so that database_find_table () will find it. Return a pointer to the table, or NULL on error.</p>
<p>The schema is deep copied, so the caller can safely free the schema.</p>
<p>Note: this function does NOT issue the SQL required to create the table in the actual storage backend.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">database</td><td><a class="el" href="structDatabase.html">Database</a> to add the <a class="el" href="structDbTable.html">DbTable</a> to </td></tr>
    <tr><td class="paramname">schema</td><td>schema structure for that tables </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>an oml_malloc'd <a class="el" href="structDbTable.html">DbTable</a> (already added to database), or NULL on error</dd></dl>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="database_8h.html#a56b56af184ae0175a660fea4a7cec0d3">database_find_table</a>, <a class="el" href="schema_8h.html#a13551c0b37985aeae6acbc40bf3317f0">schema_copy</a>, <a class="el" href="database_8h.html#a3f369cdf1c05d569973b42fdd8d5fadd">database_release</a> </dd></dl>

<p>Definition at line <a class="el" href="database_8c_source.html#l00365">365</a> of file <a class="el" href="database_8c_source.html">database.c</a>.</p>

<p>References <a class="el" href="database_8h_source.html#l00206">Database::first_table</a>, <a class="el" href="database_8h_source.html#l00193">DbTable::next</a>, <a class="el" href="mem_8c_source.html#l00240">oml_free()</a>, <a class="el" href="mem_8c_source.html#l00157">oml_malloc()</a>, <a class="el" href="database_8h_source.html#l00189">DbTable::schema</a>, and <a class="el" href="schema_8c_source.html#l00655">schema_copy()</a>.</p>

<p>Referenced by <a class="el" href="database_8c_source.html#l00396">database_find_or_create_table()</a>, <a class="el" href="database_8c_source.html#l00517">database_init()</a>, and <a class="el" href="database__adapter_8c_source.html#l00066">dba_table_create_from_schema()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="structDbTable.html">DbTable</a> *table = <a class="code" href="omlc_8h.html#a8616cb714d6589098267bba8fc7b48c2">oml_malloc</a> (<span class="keyword">sizeof</span> (<a class="code" href="structDbTable.html">DbTable</a>));</div>
<div class="line">  <span class="keywordflow">if</span> (!table)</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">  table-&gt;<a class="code" href="structDbTable.html#aeeda7dd16f500affa0db8fa6da124365">schema</a> = <a class="code" href="schema_8c.html#a13551c0b37985aeae6acbc40bf3317f0">schema_copy</a> (schema);</div>
<div class="line">  <span class="keywordflow">if</span> (!table-&gt;<a class="code" href="structDbTable.html#aeeda7dd16f500affa0db8fa6da124365">schema</a>) {</div>
<div class="line">    <a class="code" href="omlc_8h.html#aa191af748bdc144fc077967bdacaaf70">oml_free</a> (table);</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">  }</div>
<div class="line">  table-&gt;<a class="code" href="structDbTable.html#a049e276cbaa09518c95b0cbbf5b3201b">next</a> = database-&gt;<a class="code" href="structDatabase.html#a79125f9d180727e05c0f18e1e8ad6647">first_table</a>;</div>
<div class="line">  database-&gt;<a class="code" href="structDatabase.html#a79125f9d180727e05c0f18e1e8ad6647">first_table</a> = table;</div>
<div class="line">  <span class="keywordflow">return</span> table;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a6d78305dc93b0061ec6933dd99ad09da"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structDatabase.html">Database</a>* database_find </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>name</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Find a database instance for name.</p>
<p>If no database with this name exists, a new one is created.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">name</td><td>name of the database to find </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>a pointer to the database </dd></dl>

<p>Definition at line <a class="el" href="database_8c_source.html#l00214">214</a> of file <a class="el" href="database_8c_source.html">database.c</a>.</p>

<p>References <a class="el" href="database_8c_source.html#l00196">database_create_function()</a>, <a class="el" href="database_8c_source.html#l00517">database_init()</a>, <a class="el" href="database_8c_source.html#l00270">database_release()</a>, <a class="el" href="database_8c_source.html#l00093">dbbackend</a>, <a class="el" href="hook_8h_source.html#l00034">HOOK_CMD_DBCREATED</a>, <a class="el" href="hook_8h_source.html#l00035">HOOK_CMD_DBOPENED</a>, <a class="el" href="log_8c_source.html#l00333">logdebug()</a>, <a class="el" href="log_8c_source.html#l00321">loginfo()</a>, <a class="el" href="database_8h_source.html#l00023">MAX_DB_NAME_SIZE</a>, <a class="el" href="database_8h_source.html#l00199">Database::name</a>, <a class="el" href="database_8h_source.html#l00249">Database::next</a>, <a class="el" href="mem_8c_source.html#l00240">oml_free()</a>, <a class="el" href="mem_8c_source.html#l00157">oml_malloc()</a>, and <a class="el" href="database_8h_source.html#l00204">Database::ref_count</a>.</p>

<p>Referenced by <a class="el" href="check__binary__protocol_8c_source.html#l00093">START_TEST()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="structDatabase.html">Database</a>* db = first_db;</div>
<div class="line">  <span class="keywordflow">while</span> (db != NULL) {</div>
<div class="line">    <span class="keywordflow">if</span> (!strcmp(<a class="code" href="init_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, db-&gt;<a class="code" href="structDatabase.html#a167a73df85c505c998b60ff7966ef4ec">name</a>)) {</div>
<div class="line">      <a class="code" href="log_8c.html#aea4dca1a8e24794377ba1bf45fbbfce8">loginfo</a> (<span class="stringliteral">&quot;%s: Database already open (%d client%s)\n&quot;</span>,</div>
<div class="line">                <a class="code" href="init_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, db-&gt;<a class="code" href="structDatabase.html#ac27366c846d4011a111443ba4a5902da">ref_count</a>, db-&gt;<a class="code" href="structDatabase.html#ac27366c846d4011a111443ba4a5902da">ref_count</a>&gt;1?<span class="stringliteral">&quot;s&quot;</span>:<span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">      db-&gt;<a class="code" href="structDatabase.html#ac27366c846d4011a111443ba4a5902da">ref_count</a>++;</div>
<div class="line">      <span class="keywordflow">return</span> db;</div>
<div class="line">    }</div>
<div class="line">    db = db-&gt;<a class="code" href="structDatabase.html#acac99666d00c552a2692d954219a03ff">next</a>;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">// need to create a new one</span></div>
<div class="line">  <a class="code" href="structDatabase.html">Database</a> *<span class="keyword">self</span> = <a class="code" href="omlc_8h.html#a8616cb714d6589098267bba8fc7b48c2">oml_malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="structDatabase.html">Database</a>));</div>
<div class="line">  <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a>(<span class="stringliteral">&quot;%s: Creating or opening database\n&quot;</span>, <a class="code" href="init_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);</div>
<div class="line">  strncpy(self-&gt;name, <a class="code" href="init_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <a class="code" href="database_8h.html#ac7c577d62e3d70f8dfee2a55a5d0e871">MAX_DB_NAME_SIZE</a>);</div>
<div class="line">  <span class="keyword">self</span>-&gt;ref_count = 1;</div>
<div class="line">  <span class="keyword">self</span>-&gt;create = <a class="code" href="database_8c.html#a908e1a6a7d15f4d9658fd0b2347667fd">database_create_function</a> (<a class="code" href="database_8c.html#a8136c560ee2caddff4ac16e4b8f7d504">dbbackend</a>);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (self-&gt;create (<span class="keyword">self</span>)) {</div>
<div class="line">    <a class="code" href="omlc_8h.html#aa191af748bdc144fc077967bdacaaf70">oml_free</a>(<span class="keyword">self</span>);</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="database_8c.html#a16e150e3e818f5ca37d4975177291444">database_init</a> (<span class="keyword">self</span>) == -1) {</div>
<div class="line">    <a class="code" href="database_8c.html#a117606360dacfb5ba1624605829d9240">database_release</a>(<span class="keyword">self</span>);</div>
<div class="line">    <a class="code" href="omlc_8h.html#aa191af748bdc144fc077967bdacaaf70">oml_free</a> (<span class="keyword">self</span>);</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">char</span> *start_time_str = <span class="keyword">self</span>-&gt;get_metadata (<span class="keyword">self</span>, <span class="stringliteral">&quot;start_time&quot;</span>);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (start_time_str == NULL) {</div>
<div class="line">    <span class="comment">/* No start time: this is probably a new database */</span></div>
<div class="line">    database_hook_send_event(<span class="keyword">self</span>, <a class="code" href="hook_8h.html#a6e01cbd4ba0b7d48da05151369bbe825">HOOK_CMD_DBCREATED</a>);</div>
<div class="line"></div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    database_hook_send_event(<span class="keyword">self</span>, <a class="code" href="hook_8h.html#a9e4353e14124c8033df80dcc085269ff">HOOK_CMD_DBOPENED</a>);</div>
<div class="line">    <span class="keyword">self</span>-&gt;start_time = strtol (start_time_str, NULL, 0);</div>
<div class="line">    <a class="code" href="omlc_8h.html#aa191af748bdc144fc077967bdacaaf70">oml_free</a> (start_time_str);</div>
<div class="line">    <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a>(<span class="stringliteral">&quot;%s: Retrieved start-time = %lu\n&quot;</span>, <a class="code" href="init_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, self-&gt;start_time);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">// hook this one into the list of active databases</span></div>
<div class="line">  <span class="keyword">self</span>-&gt;next = first_db;</div>
<div class="line">  first_db = <span class="keyword">self</span>;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">self</span>;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="aff50a94959037620c59c4571a60e32ee"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structDbTable.html">DbTable</a>* database_find_or_create_table </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structDatabase.html">Database</a> *&#160;</td>
          <td class="paramname"><em>database</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structschema.html">schema</a> *&#160;</td>
          <td class="paramname"><em>schema</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Search a <a class="el" href="structDatabase.html">Database</a>'s registered DbTables for one matchng the given schema.</p>
<p>If none is found, the table is created. If one is found, but the schema differs, try to append a number to the name (up to MAX_TABLE_RENAME), create that table, and update the schema.</p>
<p>If the table search/creation is successful, the returned <a class="el" href="structDbTable.html">DbTable</a> is already added to the list of the <a class="el" href="structDatabase.html">Database</a>.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">database</td><td><a class="el" href="structDatabase.html">Database</a> to search </td></tr>
    <tr><td class="paramname">schema</td><td>schema structure for the table to add </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>a newly created <a class="el" href="structDbTable.html">DbTable</a> for that table, or NULL on error</dd></dl>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="database_8h.html#a0154bdabfb90498331c1810ad20a4dba">MAX_TABLE_RENAME</a>, <a class="el" href="database_8h.html#af470dc8d827b3e372fb1bf81e1ca7bd1">database_create_table</a> </dd></dl>

<p>Definition at line <a class="el" href="database_8c_source.html#l00396">396</a> of file <a class="el" href="database_8c_source.html">database.c</a>.</p>

<p>References <a class="el" href="database_8c_source.html#l00365">database_create_table()</a>, <a class="el" href="database_8c_source.html#l00335">database_find_table()</a>, <a class="el" href="database_8c_source.html#l00479">database_table_free()</a>, <a class="el" href="database_8h_source.html#l00206">Database::first_table</a>, <a class="el" href="log_8c_source.html#l00333">logdebug()</a>, <a class="el" href="log_8c_source.html#l00297">logerror()</a>, <a class="el" href="log_8c_source.html#l00309">logwarn()</a>, <a class="el" href="database_8h_source.html#l00035">MAX_TABLE_RENAME</a>, <a class="el" href="schema_8h_source.html#l00046">schema::name</a>, <a class="el" href="database_8h_source.html#l00199">Database::name</a>, <a class="el" href="database_8h_source.html#l00193">DbTable::next</a>, <a class="el" href="mem_8c_source.html#l00240">oml_free()</a>, <a class="el" href="mem_8c_source.html#l00206">oml_realloc()</a>, <a class="el" href="mem_8c_source.html#l00288">oml_strndup()</a>, <a class="el" href="database_8h_source.html#l00189">DbTable::schema</a>, <a class="el" href="schema_8c_source.html#l00655">schema_copy()</a>, <a class="el" href="schema_8c_source.html#l00733">schema_diff()</a>, <a class="el" href="schema_8c_source.html#l00607">schema_free()</a>, and <a class="el" href="database_8h_source.html#l00226">Database::table_create</a>.</p>

<p>Referenced by <a class="el" href="client__handler_8c_source.html#l00299">process_schema()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (database == NULL) <span class="keywordflow">return</span> NULL;</div>
<div class="line">  <span class="keywordflow">if</span> (schema == NULL) <span class="keywordflow">return</span> NULL;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="structDbTable.html">DbTable</a> *table = NULL;</div>
<div class="line">  <span class="keyword">struct </span>schema *s = <a class="code" href="schema_8c.html#a13551c0b37985aeae6acbc40bf3317f0">schema_copy</a>(schema);</div>
<div class="line">  <span class="keywordtype">int</span> i = 1;</div>
<div class="line">  <span class="keywordtype">int</span> diff = 0, tnlen;</div>
<div class="line"></div>
<div class="line">  tnlen = strlen(schema-&gt;<a class="code" href="structschema.html#a76dd713d21e726dc7dccd7b8c118d33c">name</a>);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    table = <a class="code" href="database_8c.html#a56b56af184ae0175a660fea4a7cec0d3">database_find_table</a> (database, s-&gt;<a class="code" href="structschema.html#a76dd713d21e726dc7dccd7b8c118d33c">name</a>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (table) {</div>
<div class="line">      diff = <a class="code" href="schema_8c.html#ac7e0f5c34f044a38675c0079dbe3b0f0">schema_diff</a> (s, table-&gt;<a class="code" href="structDbTable.html#aeeda7dd16f500affa0db8fa6da124365">schema</a>);</div>
<div class="line">      <span class="keywordflow">if</span> (!diff) {</div>
<div class="line">        <a class="code" href="schema_8c.html#afc682feb107ce19900207099d71c38d4">schema_free</a>(s);</div>
<div class="line">        <span class="keywordflow">return</span> table;</div>
<div class="line"></div>
<div class="line">      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (diff == -1) {</div>
<div class="line">        <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a> (<span class="stringliteral">&quot;%s: Schema error table &#39;%s&#39;\n&quot;</span>, database-&gt;<a class="code" href="structDatabase.html#a167a73df85c505c998b60ff7966ef4ec">name</a>, s-&gt;<a class="code" href="structschema.html#a76dd713d21e726dc7dccd7b8c118d33c">name</a>);</div>
<div class="line">        <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot; One of the server schema %p or the client schema %p is probably NULL\n&quot;</span>, s, table-&gt;<a class="code" href="structDbTable.html#aeeda7dd16f500affa0db8fa6da124365">schema</a>);</div>
<div class="line"></div>
<div class="line">      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (diff &gt; 0) {</div>
<div class="line">        <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;%s: Schema differ for table &#39;%s&#39;, at or after column %d\n&quot;</span>,</div>
<div class="line">            database-&gt;<a class="code" href="structDatabase.html#a167a73df85c505c998b60ff7966ef4ec">name</a>, s-&gt;<a class="code" href="structschema.html#a76dd713d21e726dc7dccd7b8c118d33c">name</a>, diff);</div>
<div class="line">      }</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">if</span> (i == 1) {</div>
<div class="line">        <span class="comment">/* First time we need to increase the size */</span></div>
<div class="line">        <span class="comment">/* Add space for 2 characters and null byte, that is up to &#39;_9&#39;, with MAX_TABLE_RENAME = 10 */</span></div>
<div class="line">        s-&gt;<a class="code" href="structschema.html#a76dd713d21e726dc7dccd7b8c118d33c">name</a> = <a class="code" href="mem_8c.html#ae75af3096ebd921116baca5ed9208488">oml_realloc</a>(s-&gt;<a class="code" href="structschema.html#a76dd713d21e726dc7dccd7b8c118d33c">name</a>, tnlen + 3);</div>
<div class="line">        strncpy(s-&gt;<a class="code" href="structschema.html#a76dd713d21e726dc7dccd7b8c118d33c">name</a>, schema-&gt;<a class="code" href="structschema.html#a76dd713d21e726dc7dccd7b8c118d33c">name</a>, tnlen);</div>
<div class="line">      }</div>
<div class="line">      snprintf(&amp;s-&gt;<a class="code" href="structschema.html#a76dd713d21e726dc7dccd7b8c118d33c">name</a>[tnlen], 3, <span class="stringliteral">&quot;_%d&quot;</span>, ++i);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">  } <span class="keywordflow">while</span>(table &amp;&amp; diff &amp;&amp; (i &lt; <a class="code" href="database_8h.html#a0154bdabfb90498331c1810ad20a4dba">MAX_TABLE_RENAME</a>));</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (table &amp;&amp; diff) {</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a> (<span class="stringliteral">&quot;%s: Too many (&gt;%d) tables named &#39;%s_x&#39;, giving up. Please use the rename attribute of &lt;mp /&gt; tags.\n&quot;</span>,</div>
<div class="line">      database-&gt;<a class="code" href="structDatabase.html#a167a73df85c505c998b60ff7966ef4ec">name</a>, <a class="code" href="database_8h.html#a0154bdabfb90498331c1810ad20a4dba">MAX_TABLE_RENAME</a>, schema-&gt;<a class="code" href="structschema.html#a76dd713d21e726dc7dccd7b8c118d33c">name</a>);</div>
<div class="line">    <a class="code" href="schema_8c.html#afc682feb107ce19900207099d71c38d4">schema_free</a>(s);</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span>(i&gt;1) {</div>
<div class="line">    <span class="comment">/* We had to change the table name*/</span></div>
<div class="line">    <a class="code" href="log_8c.html#ac65b3f90d3228474368b2b48a488cd44">logwarn</a>(<span class="stringliteral">&quot;%s: Creating table &#39;%s&#39; for new stream &#39;%s&#39; with incompatible schema\n&quot;</span>, database-&gt;<a class="code" href="structDatabase.html#a167a73df85c505c998b60ff7966ef4ec">name</a>, s-&gt;<a class="code" href="structschema.html#a76dd713d21e726dc7dccd7b8c118d33c">name</a>, schema-&gt;<a class="code" href="structschema.html#a76dd713d21e726dc7dccd7b8c118d33c">name</a>);</div>
<div class="line">    <a class="code" href="omlc_8h.html#aa191af748bdc144fc077967bdacaaf70">oml_free</a>(schema-&gt;<a class="code" href="structschema.html#a76dd713d21e726dc7dccd7b8c118d33c">name</a>);</div>
<div class="line">    schema-&gt;<a class="code" href="structschema.html#a76dd713d21e726dc7dccd7b8c118d33c">name</a> = <a class="code" href="mem_8c.html#adca1f9f48333b1fa9af21312a3f4534c">oml_strndup</a>(s-&gt;<a class="code" href="structschema.html#a76dd713d21e726dc7dccd7b8c118d33c">name</a>, tnlen+3);</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="schema_8c.html#afc682feb107ce19900207099d71c38d4">schema_free</a>(s);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* No table by that name exists, so we create it */</span></div>
<div class="line">  table = <a class="code" href="database_8c.html#af470dc8d827b3e372fb1bf81e1ca7bd1">database_create_table</a> (database, schema);</div>
<div class="line">  <span class="keywordflow">if</span> (!table)</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">  <span class="keywordflow">if</span> (database-&gt;<a class="code" href="structDatabase.html#ac35dabe4577144413446cbec73e7a627">table_create</a> (database, table, 0)) {</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a> (<span class="stringliteral">&quot;%s: Couldn&#39;t create table &#39;%s&#39;\n&quot;</span>, database-&gt;<a class="code" href="structDatabase.html#a167a73df85c505c998b60ff7966ef4ec">name</a>, schema-&gt;<a class="code" href="structschema.html#a76dd713d21e726dc7dccd7b8c118d33c">name</a>);</div>
<div class="line">    <span class="comment">/* Unlink the table from the experiment&#39;s list */</span></div>
<div class="line">    <a class="code" href="structDbTable.html">DbTable</a>* t = database-&gt;<a class="code" href="structDatabase.html#a79125f9d180727e05c0f18e1e8ad6647">first_table</a>;</div>
<div class="line">    <span class="keywordflow">if</span> (t == table)</div>
<div class="line">      database-&gt;<a class="code" href="structDatabase.html#a79125f9d180727e05c0f18e1e8ad6647">first_table</a> = t-&gt;<a class="code" href="structDbTable.html#a049e276cbaa09518c95b0cbbf5b3201b">next</a>;</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">      <span class="keywordflow">while</span> (t &amp;&amp; t-&gt;<a class="code" href="structDbTable.html#a049e276cbaa09518c95b0cbbf5b3201b">next</a> != table)</div>
<div class="line">        t = t-&gt;<a class="code" href="structDbTable.html#a049e276cbaa09518c95b0cbbf5b3201b">next</a>;</div>
<div class="line">      <span class="keywordflow">if</span> (t &amp;&amp; t-&gt;<a class="code" href="structDbTable.html#a049e276cbaa09518c95b0cbbf5b3201b">next</a>)</div>
<div class="line">        t-&gt;<a class="code" href="structDbTable.html#a049e276cbaa09518c95b0cbbf5b3201b">next</a> = t-&gt;<a class="code" href="structDbTable.html#a049e276cbaa09518c95b0cbbf5b3201b">next</a>-&gt;<a class="code" href="structDbTable.html#a049e276cbaa09518c95b0cbbf5b3201b">next</a>;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="database_8c.html#a2a5cfaa80f79620f4e762a48a8446991">database_table_free</a> (database, table);</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> table;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a56b56af184ae0175a660fea4a7cec0d3"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structDbTable.html">DbTable</a>* database_find_table </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structDatabase.html">Database</a> *&#160;</td>
          <td class="paramname"><em>database</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>name</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="database_8c_source.html#l00335">335</a> of file <a class="el" href="database_8c_source.html">database.c</a>.</p>

<p>References <a class="el" href="database_8h_source.html#l00206">Database::first_table</a>, <a class="el" href="schema_8h_source.html#l00046">schema::name</a>, <a class="el" href="database_8h_source.html#l00193">DbTable::next</a>, and <a class="el" href="database_8h_source.html#l00189">DbTable::schema</a>.</p>

<p>Referenced by <a class="el" href="database_8c_source.html#l00396">database_find_or_create_table()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="structDbTable.html">DbTable</a> *table = database-&gt;<a class="code" href="structDatabase.html#a79125f9d180727e05c0f18e1e8ad6647">first_table</a>;</div>
<div class="line">  <span class="keywordflow">while</span> (table) {</div>
<div class="line">    <span class="keywordflow">if</span> (!strcmp (table-&gt;<a class="code" href="structDbTable.html#aeeda7dd16f500affa0db8fa6da124365">schema</a>-&gt;<a class="code" href="structschema.html#a76dd713d21e726dc7dccd7b8c118d33c">name</a>, <a class="code" href="init_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>))</div>
<div class="line">      <span class="keywordflow">return</span> table;</div>
<div class="line">    table = table-&gt;<a class="code" href="structDbTable.html#a049e276cbaa09518c95b0cbbf5b3201b">next</a>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a32ef977dd18a7370f0fe2d853d630591"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int database_init </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structDatabase.html">Database</a> *&#160;</td>
          <td class="paramname"><em>database</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Initialise adapters for a new database</p>
<p>If the database already has tables, initialise the adapters.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">database</td><td>main <a class="el" href="structDatabase.html">Database</a> object </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success, -1 otherwise</dd></dl>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="database_8h.html#af470dc8d827b3e372fb1bf81e1ca7bd1">database_create_table</a>, <a class="el" href="database_8h.html#ac4d31692f155b3354e67d3fcbc07fc90">db_adapter_table_create</a> </dd></dl>

<p>Definition at line <a class="el" href="database_8c_source.html#l00517">517</a> of file <a class="el" href="database_8c_source.html">database.c</a>.</p>

<p>References <a class="el" href="database_8c_source.html#l00365">database_create_table()</a>, <a class="el" href="database_8c_source.html#l00479">database_table_free()</a>, <a class="el" href="database_8h_source.html#l00246">Database::get_table_list</a>, <a class="el" href="oml__util_8h_source.html#l00027">LENGTH</a>, <a class="el" href="log_8c_source.html#l00333">logdebug()</a>, <a class="el" href="log_8c_source.html#l00297">logerror()</a>, <a class="el" href="log_8c_source.html#l00309">logwarn()</a>, <a class="el" href="database_8h_source.html#l00199">Database::name</a>, <a class="el" href="table__descr_8h_source.html#l00037">TableDescr::next</a>, <a class="el" href="schema_8c_source.html#l00655">schema_copy()</a>, <a class="el" href="database_8h_source.html#l00213">Database::semantic</a>, <a class="el" href="database_8h_source.html#l00226">Database::table_create</a>, <a class="el" href="database_8h_source.html#l00228">Database::table_create_meta</a>, <a class="el" href="table__descr_8c_source.html#l00059">table_descr_have_table()</a>, and <a class="el" href="table__descr_8c_source.html#l00096">table_descr_list_free()</a>.</p>

<p>Referenced by <a class="el" href="database_8c_source.html#l00214">database_find()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> num_tables;</div>
<div class="line">  <a class="code" href="structTableDescr.html">TableDescr</a>* tables = database-&gt;<a class="code" href="structDatabase.html#a78ae7bf45a0794f5d2fdedb7c6bdd910">get_table_list</a> (database, &amp;num_tables);</div>
<div class="line">  <span class="keywordflow">if</span> (!database-&gt;<a class="code" href="structDatabase.html#afb9ead71a0eba6a9e7c5c03725db5ebd">semantic</a>)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="structTableDescr.html">TableDescr</a>* td = tables;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (num_tables == -1)</div>
<div class="line">      <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a>(<span class="stringliteral">&quot;%s: Got table list with %d tables in it\n&quot;</span>, database-&gt;<a class="code" href="structDatabase.html#a167a73df85c505c998b60ff7966ef4ec">name</a>, num_tables);</div>
<div class="line">    <span class="keywordtype">int</span> i = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; num_tables; i++, td = td-&gt;<a class="code" href="structTableDescr.html#acb6800995a399b32b7591020be42f0d5">next</a>) {</div>
<div class="line">      <span class="keywordflow">if</span> (td-&gt;schema) {</div>
<div class="line">        <span class="keyword">struct </span><a class="code" href="structschema.html">schema</a> *<a class="code" href="structschema.html">schema</a> = <a class="code" href="schema_8c.html#a13551c0b37985aeae6acbc40bf3317f0">schema_copy</a> (td-&gt;schema);</div>
<div class="line">        <a class="code" href="structDbTable.html">DbTable</a> *table = <a class="code" href="database_8c.html#af470dc8d827b3e372fb1bf81e1ca7bd1">database_create_table</a> (database, schema);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!table) {</div>
<div class="line">          <a class="code" href="log_8c.html#ac65b3f90d3228474368b2b48a488cd44">logwarn</a> (<span class="stringliteral">&quot;%s: Failed to create table &#39;%s&#39;\n&quot;</span>,</div>
<div class="line">                   database-&gt;<a class="code" href="structDatabase.html#a167a73df85c505c998b60ff7966ef4ec">name</a>, td-&gt;name);</div>
<div class="line">          <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">/* Create the required table data structures, but don&#39;t do SQL CREATE TABLE */</span></div>
<div class="line">        <span class="keywordflow">if</span> (database-&gt;<a class="code" href="structDatabase.html#ac35dabe4577144413446cbec73e7a627">table_create</a> (database, table, 1) == -1) {</div>
<div class="line">          <a class="code" href="log_8c.html#ac65b3f90d3228474368b2b48a488cd44">logwarn</a> (<span class="stringliteral">&quot;%s: Failed to create adapter structures for table &#39;%s&#39;\n&quot;</span>,</div>
<div class="line">                   database-&gt;<a class="code" href="structDatabase.html#a167a73df85c505c998b60ff7966ef4ec">name</a>, td-&gt;name);</div>
<div class="line">          <a class="code" href="database_8c.html#a2a5cfaa80f79620f4e762a48a8446991">database_table_free</a> (database, table);</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create default tables if they are not already present in the &#39;tables&#39; list */</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *meta_tables [] = { <span class="stringliteral">&quot;_senders&quot;</span>, <span class="stringliteral">&quot;_experiment_metadata&quot;</span> };</div>
<div class="line">    <span class="keywordtype">size_t</span> j;</div>
<div class="line">    <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="oml__util_8h.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(meta_tables); j++) {</div>
<div class="line">      <span class="keywordflow">if</span> (!<a class="code" href="table__descr_8c.html#a7759126cd2803049a68d3aef1455db35">table_descr_have_table</a> (tables, meta_tables[j])) {</div>
<div class="line">        <span class="keywordflow">if</span> (database-&gt;<a class="code" href="structDatabase.html#a0f4ae742aca8d1efb7addd9bd99bfd93">table_create_meta</a> (database, meta_tables[j])) {</div>
<div class="line">          <a class="code" href="table__descr_8c.html#a54eea9971d4f144bdc791bbb7f7261e4">table_descr_list_free</a> (tables);</div>
<div class="line">          <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;%s: Could not create default table %s\n&quot;</span>,</div>
<div class="line">              database-&gt;<a class="code" href="structDatabase.html#a167a73df85c505c998b60ff7966ef4ec">name</a>, meta_tables[j]);</div>
<div class="line">          <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="table__descr_8c.html#a54eea9971d4f144bdc791bbb7f7261e4">table_descr_list_free</a> (tables);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a7300a86afceccbde1c8889f2166c0b30"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structMString.html">MString</a>* database_make_sql_insert </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structDatabase.html">Database</a> *&#160;</td>
          <td class="paramname"><em>db</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structDbTable.html">DbTable</a> *&#160;</td>
          <td class="paramname"><em>table</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Prepare an INSERT statement for a given table</p>
<p>The returned value is to be destroyed by the caller.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">db</td><td><a class="el" href="structDatabase.html">Database</a> </td></tr>
    <tr><td class="paramname">table</td><td><a class="el" href="structDbTable.html">DbTable</a> adapter for the target SQLite3 table </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>an <a class="el" href="structMString.html">MString</a> containing the prepared statement, or NULL on error</dd></dl>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="mstring_8h.html#a49f0faf4fe4e38a6d7b4f0ef09d5fd24">mstring_create</a>, <a class="el" href="mstring_8h.html#a22eb366ee3317407b4233d6216b690a3">mstring_delete</a> </dd></dl>

<p>Definition at line <a class="el" href="database_8c_source.html#l00502">502</a> of file <a class="el" href="database_8c_source.html">database.c</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> db-&gt;<a class="code" href="structDatabase.html#a499b58168a1a4e99d0f363df5ddbc1f6">prepare</a>(db,table);</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a3f369cdf1c05d569973b42fdd8d5fadd"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void database_release </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structDatabase.html">Database</a> *&#160;</td>
          <td class="paramname"><em>self</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>One client no longer uses this database. If this was the last client checking out, close database. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">self</td><td>the database to release </td></tr>
  </table>
  </dd>
</dl>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="database_8h.html#aae500dd136c0003d777ce18d26212171">db_adapter_release</a> </dd></dl>

<p>Definition at line <a class="el" href="database_8c_source.html#l00270">270</a> of file <a class="el" href="database_8c_source.html">database.c</a>.</p>

<p>References <a class="el" href="database_8c_source.html#l00479">database_table_free()</a>, <a class="el" href="hook_8h_source.html#l00036">HOOK_CMD_DBCLOSED</a>, <a class="el" href="log_8c_source.html#l00297">logerror()</a>, <a class="el" href="log_8c_source.html#l00321">loginfo()</a>, <a class="el" href="database_8h_source.html#l00193">DbTable::next</a>, <a class="el" href="database_8h_source.html#l00249">Database::next</a>, and <a class="el" href="mem_8c_source.html#l00240">oml_free()</a>.</p>

<p>Referenced by <a class="el" href="client__handler_8c_source.html#l00227">client_handler_free()</a>, <a class="el" href="database_8c_source.html#l00318">database_cleanup()</a>, <a class="el" href="database_8c_source.html#l00214">database_find()</a>, and <a class="el" href="check__binary__protocol_8c_source.html#l00093">START_TEST()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (<span class="keyword">self</span> == NULL) {</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;NONE: Trying to release a NULL database.\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (--self-&gt;<a class="code" href="structDatabase.html#ac27366c846d4011a111443ba4a5902da">ref_count</a> &gt; 0) <span class="keywordflow">return</span>; <span class="comment">// still in use</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">// unlink DB</span></div>
<div class="line">  <a class="code" href="structDatabase.html">Database</a>* db_p = first_db;</div>
<div class="line">  <a class="code" href="structDatabase.html">Database</a>* prev_p = NULL;</div>
<div class="line">  <span class="keywordflow">while</span> (db_p != NULL &amp;&amp; db_p != <span class="keyword">self</span>) {</div>
<div class="line">    prev_p = db_p;</div>
<div class="line">    db_p = db_p-&gt;<a class="code" href="structDatabase.html#acac99666d00c552a2692d954219a03ff">next</a>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (db_p == NULL) {</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;%s:  Trying to release an unknown database\n&quot;</span>, self-&gt;<a class="code" href="structDatabase.html#a167a73df85c505c998b60ff7966ef4ec">name</a>);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (prev_p == NULL)</div>
<div class="line">    first_db = <span class="keyword">self</span>-&gt;<a class="code" href="structDatabase.html#acac99666d00c552a2692d954219a03ff">next</a>; <span class="comment">// was first</span></div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    prev_p-&gt;<a class="code" href="structDatabase.html#acac99666d00c552a2692d954219a03ff">next</a> = <span class="keyword">self</span>-&gt;<a class="code" href="structDatabase.html#acac99666d00c552a2692d954219a03ff">next</a>;</div>
<div class="line"></div>
<div class="line">  <span class="comment">// no longer needed</span></div>
<div class="line">  <a class="code" href="structDbTable.html">DbTable</a>* t_p = <span class="keyword">self</span>-&gt;first_table;</div>
<div class="line">  <span class="keywordflow">while</span> (t_p != NULL) {</div>
<div class="line">    <a class="code" href="structDbTable.html">DbTable</a>* t = t_p-&gt;<a class="code" href="structDbTable.html#a049e276cbaa09518c95b0cbbf5b3201b">next</a>;</div>
<div class="line">    <span class="comment">/* Release the backend storage for this table */</span></div>
<div class="line">    <span class="keyword">self</span>-&gt;table_free (<span class="keyword">self</span>, t_p);</div>
<div class="line">    <span class="comment">/* Release the table */</span></div>
<div class="line">    <a class="code" href="database_8c.html#a2a5cfaa80f79620f4e762a48a8446991">database_table_free</a>(<span class="keyword">self</span>, t_p);</div>
<div class="line">    t_p = t;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <a class="code" href="log_8c.html#aea4dca1a8e24794377ba1bf45fbbfce8">loginfo</a> (<span class="stringliteral">&quot;%s: Closing database\n&quot;</span>, self-&gt;<a class="code" href="structDatabase.html#a167a73df85c505c998b60ff7966ef4ec">name</a>);</div>
<div class="line">  <span class="keyword">self</span>-&gt;release (<span class="keyword">self</span>);</div>
<div class="line"></div>
<div class="line">  database_hook_send_event(<span class="keyword">self</span>, <a class="code" href="hook_8h.html#ab9d59c80c420ed0b361441bca2b49cb2">HOOK_CMD_DBCLOSED</a>);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="omlc_8h.html#aa191af748bdc144fc077967bdacaaf70">oml_free</a>(<span class="keyword">self</span>);</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="adf175cbb06ea894cfbfa63eb6e056f12"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int database_setup_backend </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>backend</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Setup the selected database backend.</p>
<p>Must be called after dropping privileges.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">backend</td><td>name of the selected backend </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success, -1 otherwise</dd></dl>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="sqlite__adapter_8h.html#a55e2e3f6b36cdfd3bf171b7f8c6f1626">sq3_backend_setup</a>, <a class="el" href="psql__adapter_8h.html#af2edfcd6e173f4c85e3e77950d9b4602">psql_backend_setup</a> </dd></dl>

<p>Definition at line <a class="el" href="database_8c_source.html#l00131">131</a> of file <a class="el" href="database_8c_source.html">database.c</a>.</p>

<p>References <a class="el" href="database_8c_source.html#l00196">database_create_function()</a>, <a class="el" href="fuseki__adapter-new-yahya_8c_source.html#l00130">fuseki_backend_setup()</a>, <a class="el" href="log_8c_source.html#l00333">logdebug()</a>, <a class="el" href="log_8c_source.html#l00297">logerror()</a>, <a class="el" href="psql__adapter_8c_source.html#l00127">psql_backend_setup()</a>, <a class="el" href="sqlite__adapter_8c_source.html#l00128">sq3_backend_setup()</a>, and <a class="el" href="virtuoso__adapter_8c_source.html#l00123">virtuoso_backend_setup()</a>.</p>

<p>Referenced by <a class="el" href="oml2-server_8c_source.html#l00292">main()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;Database backend: &#39;%s&#39;\n&quot;</span>, backend);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (!<a class="code" href="database_8c.html#a908e1a6a7d15f4d9658fd0b2347667fd">database_create_function</a> (backend)) {</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a> (<span class="stringliteral">&quot;Unknown database backend &#39;%s&#39; (valid backends: %s)\n&quot;</span>,</div>
<div class="line">         backend, database_valid_backends ());</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (!strcmp (backend, <span class="stringliteral">&quot;sqlite&quot;</span>)) {</div>
<div class="line">    <span class="keywordflow">if</span>(<a class="code" href="sqlite__adapter_8c.html#a55e2e3f6b36cdfd3bf171b7f8c6f1626">sq3_backend_setup</a> ()) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="preprocessor">#if HAVE_LIBPQ</span></div>
<div class="line"><span class="preprocessor"></span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp (backend, <span class="stringliteral">&quot;postgresql&quot;</span>)) {</div>
<div class="line">    <span class="keywordflow">if</span>(<a class="code" href="psql__adapter_8c.html#a8ababd35cdec2f80ec4c20c3305a7f51">psql_backend_setup</a> ()) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp (backend, <span class="stringliteral">&quot;fuseki&quot;</span>)) {</div>
<div class="line">    <span class="keywordflow">if</span>(<a class="code" href="fuseki__adapter-new-yahya_8c.html#a4f9a6be6e9a241fef3ed8fed34246f56">fuseki_backend_setup</a> ()) <span class="keywordflow">return</span> -1;</div>
<div class="line">  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp (backend, <span class="stringliteral">&quot;virtuoso&quot;</span>)) {</div>
<div class="line">    <span class="keywordflow">if</span>(<a class="code" href="virtuoso__adapter_8c.html#a609cf7e61183dee00c3cdf5669a49426">virtuoso_backend_setup</a> ()) <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a2a5cfaa80f79620f4e762a48a8446991"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void database_table_free </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structDatabase.html">Database</a> *&#160;</td>
          <td class="paramname"><em>database</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structDbTable.html">DbTable</a> *&#160;</td>
          <td class="paramname"><em>table</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="database_8c_source.html#l00479">479</a> of file <a class="el" href="database_8c_source.html">database.c</a>.</p>

<p>References <a class="el" href="log_8c_source.html#l00333">logdebug()</a>, <a class="el" href="log_8c_source.html#l00309">logwarn()</a>, <a class="el" href="schema_8h_source.html#l00046">schema::name</a>, <a class="el" href="database_8h_source.html#l00199">Database::name</a>, <a class="el" href="mem_8c_source.html#l00240">oml_free()</a>, <a class="el" href="database_8h_source.html#l00189">DbTable::schema</a>, and <a class="el" href="schema_8c_source.html#l00607">schema_free()</a>.</p>

<p>Referenced by <a class="el" href="database_8c_source.html#l00396">database_find_or_create_table()</a>, <a class="el" href="database_8c_source.html#l00517">database_init()</a>, and <a class="el" href="database_8c_source.html#l00270">database_release()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (database &amp;&amp; table) {</div>
<div class="line">    <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a>(<span class="stringliteral">&quot;%s: Freeing table &#39;%s&#39;\n&quot;</span>, database-&gt;<a class="code" href="structDatabase.html#a167a73df85c505c998b60ff7966ef4ec">name</a>, table-&gt;<a class="code" href="structDbTable.html#aeeda7dd16f500affa0db8fa6da124365">schema</a>-&gt;<a class="code" href="structschema.html#a76dd713d21e726dc7dccd7b8c118d33c">name</a>);</div>
<div class="line">    <a class="code" href="schema_8c.html#afc682feb107ce19900207099d71c38d4">schema_free</a> (table-&gt;<a class="code" href="structDbTable.html#aeeda7dd16f500affa0db8fa6da124365">schema</a>);</div>
<div class="line">    <a class="code" href="omlc_8h.html#aa191af748bdc144fc077967bdacaaf70">oml_free</a>(table);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <a class="code" href="log_8c.html#ac65b3f90d3228474368b2b48a488cd44">logwarn</a>(<span class="stringliteral">&quot;%s: Tried to free a NULL table (or database was NULL).\n&quot;</span>,</div>
<div class="line">            (database ? database-&gt;<a class="code" href="structDatabase.html#a167a73df85c505c998b60ff7966ef4ec">name</a> : <span class="stringliteral">&quot;NONE&quot;</span>));</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_41e1742e44e2de38b3bc91f993fed282.html">server</a></li><li class="navelem"><a class="el" href="database_8h.html">database.h</a></li>
    <li class="footer">Generated on Thu Jun 25 2015 15:31:55 for oml2 by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.1.2 </li>
  </ul>
</div>
</body>
</html>
