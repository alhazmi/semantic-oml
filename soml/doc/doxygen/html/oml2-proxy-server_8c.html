<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>oml2: oml2-proxy-server.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="oml_logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">oml2
   &#160;<span id="projectnumber">2.12.0pre.79-58cf-dirty</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('oml2-proxy-server_8c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">oml2-proxy-server.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Implement the proxy server's top-level <a class="el" href="generator_8c.html#ac0f2228420376f4db7e1274f2b41667c">main()</a> and its supporting functions.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;stdlib.h&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
<code>#include &lt;unistd.h&gt;</code><br/>
<code>#include &lt;errno.h&gt;</code><br/>
<code>#include &lt;signal.h&gt;</code><br/>
<code>#include &lt;popt.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="o__log_8h_source.html">ocomm/o_log.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="o__socket_8h_source.html">ocomm/o_socket.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="o__eventloop_8h_source.html">ocomm/o_eventloop.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="mstring_8h_source.html">mstring.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="session_8h_source.html">session.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="proxy__client_8h_source.html">proxy_client.h</a>&quot;</code><br/>
</div><div class="textblock"><div class="dynheader">
Include dependency graph for oml2-proxy-server.c:</div>
<div class="dyncontent">
<div class="center"><img src="oml2-proxy-server_8c__incl.png" border="0" usemap="#oml2-proxy-server_8c" alt=""/></div>
<map name="oml2-proxy-server_8c" id="oml2-proxy-server_8c">
<area shape="rect" id="node15" href="o__log_8h.html" title="ocomm/o_log.h" alt="" coords="325,469,435,499"/><area shape="rect" id="node19" href="o__socket_8h.html" title="Header file for the OComm Socket library. OSockets are a thin abstraction layer that manages sockets ..." alt="" coords="349,237,483,267"/><area shape="rect" id="node29" href="o__eventloop_8h.html" title="ocomm/o_eventloop.h" alt="" coords="312,160,461,189"/><area shape="rect" id="node34" href="mstring_8h.html" title="mstring.h" alt="" coords="739,392,813,421"/><area shape="rect" id="node37" href="session_8h.html" title="session.h" alt="" coords="1027,83,1104,112"/><area shape="rect" id="node39" href="proxy__client_8h.html" title="proxy_client.h" alt="" coords="575,83,676,112"/><area shape="rect" id="node45" href="mbuf_8h.html" title="mbuf.h" alt="" coords="939,392,1000,421"/><area shape="rect" id="node50" href="cbuf_8h.html" title="cbuf.h" alt="" coords="892,237,951,267"/><area shape="rect" id="node52" href="headers_8h.html" title="headers.h" alt="" coords="837,392,915,421"/><area shape="rect" id="node55" href="message_8h.html" title="Defines a container for either a text or binary message (struct oml_message) and the associated inter..." alt="" coords="695,237,780,267"/><area shape="rect" id="node75" href="message__queue_8h.html" title="message_queue.h" alt="" coords="773,160,901,189"/><area shape="rect" id="node58" href="omlc_8h.html" title="Public API of the OML client library." alt="" coords="520,392,613,421"/><area shape="rect" id="node68" href="schema_8h.html" title="schema.h" alt="" coords="739,315,816,344"/></map>
</div>
</div>
<p><a href="oml2-proxy-server_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a343bac9aba102cbb8787eefba33dd873"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#a343bac9aba102cbb8787eefba33dd873">V_STRING</a>&#160;&#160;&#160;&quot;OML2 Proxy Server V%s\n&quot;</td></tr>
<tr class="memitem:a6247bc79b0a606bddbf5a90fc3a03194"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#a6247bc79b0a606bddbf5a90fc3a03194">COPYRIGHT</a>&#160;&#160;&#160;&quot;Copyright 2007-2014 NICTA\n&quot;</td></tr>
<tr class="memitem:a3aaff003637cf49539879ebf960c7764"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#a3aaff003637cf49539879ebf960c7764">DEF_PORT</a>&#160;&#160;&#160;3003</td></tr>
<tr class="memitem:aaf17225f3a62e70bfb8b8194b376cfed"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#aaf17225f3a62e70bfb8b8194b376cfed">DEF_PORT_STR</a>&#160;&#160;&#160;&quot;3003&quot;</td></tr>
<tr class="memitem:a3915d898e4a93ac59deed907515867c5"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#a3915d898e4a93ac59deed907515867c5">DEF_CTRL_PORT</a>&#160;&#160;&#160;3004</td></tr>
<tr class="memitem:aad0859aa9be15d99cd46a9ecfa9b3243"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#aad0859aa9be15d99cd46a9ecfa9b3243">DEF_CTRL_PORT_STR</a>&#160;&#160;&#160;&quot;3004&quot;</td></tr>
<tr class="memitem:a2ecbb6b97620287d0a619efd366a2b46"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#a2ecbb6b97620287d0a619efd366a2b46">DEFAULT_LOG_FILE</a>&#160;&#160;&#160;&quot;oml_proxy_server.log&quot;</td></tr>
<tr class="memitem:a2b5eaed088d936799b7a5f31526a5bf4"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#a2b5eaed088d936799b7a5f31526a5bf4">DEFAULT_RESULT_FILE</a>&#160;&#160;&#160;&quot;oml_result_proxy.res&quot;</td></tr>
<tr class="memitem:a2ab370dcb12e8b14e1a63f81b7ab02f3"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#a2ab370dcb12e8b14e1a63f81b7ab02f3">DEF_PAGE_SIZE</a>&#160;&#160;&#160;1024</td></tr>
<tr class="memitem:a8d438dcdf6b178472503ea6398a019a7"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#a8d438dcdf6b178472503ea6398a019a7">DEFAULT_SERVER_ADDRESS</a>&#160;&#160;&#160;&quot;localhost&quot;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a08fc2e4060c8c78c7640519d9495bf9c"><td class="memItemLeft" align="right" valign="top">void *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#a08fc2e4060c8c78c7640519d9495bf9c">client_send_thread</a> (void *handle)</td></tr>
<tr class="memitem:ad5cbe5e00caa71043883f331d1d05fd7"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#ad5cbe5e00caa71043883f331d1d05fd7">proxy_message_loop</a> (const char *client_id, <a class="el" href="proxy__client_8h.html#a3a773b70e1497bdce4b49dc601e97663">Client</a> *client, void *buf, size_t size)</td></tr>
<tr class="memitem:ad06be2215447c5882d6a2e65c5708368"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#ad06be2215447c5882d6a2e65c5708368">client_callback</a> (<a class="el" href="o__eventloop_8h.html#ac2b8421423a2691d90489400dc948fb3">SockEvtSource</a> *source, void *handle, void *buf, int buf_size)</td></tr>
<tr class="memitem:ab407b62e3136824fb73bbbb5839cea56"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#ab407b62e3136824fb73bbbb5839cea56">status_callback</a> (<a class="el" href="o__eventloop_8h.html#ac2b8421423a2691d90489400dc948fb3">SockEvtSource</a> *source, <a class="el" href="o__eventloop_8h.html#a579723a800874d33587042781a60af86">SocketStatus</a> status, int error, void *handle)</td></tr>
<tr class="memitem:ab2f3e668cb06e8ae19e51c19db33867b"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#ab2f3e668cb06e8ae19e51c19db33867b">on_connect</a> (<a class="el" href="structSocket.html">Socket</a> *client_sock, void *handle)</td></tr>
<tr class="memitem:a17854ad7b1185ec8b3ff659e84c3fd43"><td class="memItemLeft" align="right" valign="top">void *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#a17854ad7b1185ec8b3ff659e84c3fd43">prepare_stdin</a> (void *handle)</td></tr>
<tr class="memitem:af32816f7efaf256ba76c084cb7af378f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#af32816f7efaf256ba76c084cb7af378f">stdin_handler</a> (<a class="el" href="o__eventloop_8h.html#ac2b8421423a2691d90489400dc948fb3">SockEvtSource</a> *source, void *handle, void *buf, int buf_size)</td></tr>
<tr class="memitem:afae559d162109a3db6d4d845647a9cb3"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#afae559d162109a3db6d4d845647a9cb3">on_control_connect</a> (<a class="el" href="structSocket.html">Socket</a> *sock, void *handle)</td></tr>
<tr class="memitem:aceab8c76067d9fb567c8f5a94d79d2ab"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#aceab8c76067d9fb567c8f5a94d79d2ab">sigpipe_handler</a> (int signum)</td></tr>
<tr class="memitem:a6bb68560564aadd06dfa334b3adb7092"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#a6bb68560564aadd06dfa334b3adb7092">setup_logging</a> (char *logfile, int level)</td></tr>
<tr class="memitem:ac0f2228420376f4db7e1274f2b41667c"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#ac0f2228420376f4db7e1274f2b41667c">main</a> (int argc, const char *argv[])</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:aabe906df2e9b738fc184732415dc7f48"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#aabe906df2e9b738fc184732415dc7f48">sigpipe_flag</a> = 0</td></tr>
<tr class="memitem:a6b32f07deadd1d267d1b669bc819f4fe"><td class="memItemLeft" align="right" valign="top"><a class="el" href="session_8h.html#a906c903b07fa6fbe3a2f78d7ca0ca686">Session</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#a6b32f07deadd1d267d1b669bc819f4fe">session</a> = NULL</td></tr>
<tr class="memitem:a2e48d05a30e5baae3312f63532cd9c21"><td class="memItemLeft" align="right" valign="top">struct poptOption&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="oml2-proxy-server_8c.html#a2e48d05a30e5baae3312f63532cd9c21">options</a> []</td></tr>
</table>
<a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>Implement the proxy server's top-level <a class="el" href="generator_8c.html#ac0f2228420376f4db7e1274f2b41667c">main()</a> and its supporting functions. </p>

<p>Definition in file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>
</div><h2>Macro Definition Documentation</h2>
<a class="anchor" id="a6247bc79b0a606bddbf5a90fc3a03194"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define COPYRIGHT&#160;&#160;&#160;&quot;Copyright 2007-2014 NICTA\n&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00031">31</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

<p>Referenced by <a class="el" href="oml2-proxy-server_8c_source.html#l00307">main()</a>.</p>

</div>
</div>
<a class="anchor" id="a3915d898e4a93ac59deed907515867c5"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEF_CTRL_PORT&#160;&#160;&#160;3004</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00035">35</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

</div>
</div>
<a class="anchor" id="aad0859aa9be15d99cd46a9ecfa9b3243"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEF_CTRL_PORT_STR&#160;&#160;&#160;&quot;3004&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00036">36</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

</div>
</div>
<a class="anchor" id="a2ab370dcb12e8b14e1a63f81b7ab02f3"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEF_PAGE_SIZE&#160;&#160;&#160;1024</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00039">39</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

</div>
</div>
<a class="anchor" id="a3aaff003637cf49539879ebf960c7764"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEF_PORT&#160;&#160;&#160;3003</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00033">33</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

</div>
</div>
<a class="anchor" id="aaf17225f3a62e70bfb8b8194b376cfed"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEF_PORT_STR&#160;&#160;&#160;&quot;3003&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00034">34</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

</div>
</div>
<a class="anchor" id="a2ecbb6b97620287d0a619efd366a2b46"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEFAULT_LOG_FILE&#160;&#160;&#160;&quot;oml_proxy_server.log&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00037">37</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

<p>Referenced by <a class="el" href="oml2-proxy-server_8c_source.html#l00292">setup_logging()</a>.</p>

</div>
</div>
<a class="anchor" id="a2b5eaed088d936799b7a5f31526a5bf4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEFAULT_RESULT_FILE&#160;&#160;&#160;&quot;oml_result_proxy.res&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00038">38</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

</div>
</div>
<a class="anchor" id="a8d438dcdf6b178472503ea6398a019a7"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEFAULT_SERVER_ADDRESS&#160;&#160;&#160;&quot;localhost&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00040">40</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

</div>
</div>
<a class="anchor" id="a343bac9aba102cbb8787eefba33dd873"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define V_STRING&#160;&#160;&#160;&quot;OML2 Proxy Server V%s\n&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00030">30</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

<p>Referenced by <a class="el" href="oml2-proxy-server_8c_source.html#l00307">main()</a>.</p>

</div>
</div>
<h2>Function Documentation</h2>
<a class="anchor" id="ad06be2215447c5882d6a2e65c5708368"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void client_callback </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="o__eventloop_8h.html#ac2b8421423a2691d90489400dc948fb3">SockEvtSource</a> *&#160;</td>
          <td class="paramname"><em>source</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>buf_size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Callback function called when the socket receive some data </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">source</td><td>the socket event </td></tr>
    <tr><td class="paramname">handle</td><td>the client handler </td></tr>
    <tr><td class="paramname">buf</td><td>data received from the socket </td></tr>
    <tr><td class="paramname">bufsize</td><td>the size of the data set from the socket</td></tr>
  </table>
  </dd>
</dl>
<ul>
<li>Callback function called when the socket receive some data <dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">source</td><td>the socket event </td></tr>
    <tr><td class="paramname">handle</td><td>the client handler </td></tr>
    <tr><td class="paramname">buf</td><td>data received from the socket </td></tr>
    <tr><td class="paramname">bufsize</td><td>the size of the data set from the socket </td></tr>
  </table>
  </dd>
</dl>
</li>
</ul>

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00081">81</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

<p>Referenced by <a class="el" href="client__handler_8c_source.html#l00206">client_handler_new()</a>, <a class="el" href="oml2-proxy-server_8c_source.html#l00143">on_connect()</a>, and <a class="el" href="check__binary__protocol_8c_source.html#l00093">START_TEST()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  (void)source;</div>
<div class="line">  <a class="code" href="struct__client.html">Client</a>* <span class="keyword">self</span> = (<a class="code" href="struct__client.html">Client</a>*)handle;</div>
<div class="line"></div>
<div class="line">  <span class="comment">//  logdebug (&quot;&#39;%s&#39;: received %d octets of data\n&quot;, source-&gt;name, buf_size);</span></div>
<div class="line">  <span class="comment">//  logdebug (&quot;&#39;%s&#39;: %s\n&quot;, source-&gt;name, to_octets (buf, buf_size));</span></div>
<div class="line"></div>
<div class="line">  <a class="code" href="oml2-proxy-server_8c.html#ad5cbe5e00caa71043883f331d1d05fd7">proxy_message_loop</a> (source-&gt;<a class="code" href="struct__sockEvtSource.html#ae736ed058fdf889d84740d8d8be9fffa">name</a>, <span class="keyword">self</span>, buf, buf_size);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="mbuf_8c.html#a6197418fb3ef89250ac51be751e7805c">mbuf_repack_message</a> (self-&gt;mbuf);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (self-&gt;state == <a class="code" href="proxy__client_8h.html#a8d4a6786d6193f0e6245c44e4a7bb4a0ae5948dea6f5f07cf3b03e786128dda68">C_PROTOCOL_ERROR</a>) {</div>
<div class="line">    <a class="code" href="o__socket_8h.html#ab8e18bfbef40930e4e38a2e5b69801a2">socket_close</a> (self-&gt;recv_socket);</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;&#39;%s&#39;: protocol error, proxy server will disconnect upstream client\n&quot;</span>, source-&gt;<a class="code" href="struct__sockEvtSource.html#ae736ed058fdf889d84740d8d8be9fffa">name</a>);</div>
<div class="line">    <a class="code" href="eventloop_8c.html#a5a3644a8f05609def4e6c259ebc4d68b">eventloop_socket_remove</a> (self-&gt;recv_event);  <span class="comment">// Note:  this free()&#39;s source!</span></div>
<div class="line">    <span class="keyword">self</span>-&gt;recv_event = NULL;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  fwrite (buf, <span class="keyword">sizeof</span> (<span class="keywordtype">char</span>), buf_size, self-&gt;file);</div>
<div class="line"></div>
<div class="line">  pthread_mutex_lock (&amp;self-&gt;mutex);</div>
<div class="line">  pthread_cond_signal (&amp;self-&gt;condvar);</div>
<div class="line">  pthread_mutex_unlock (&amp;self-&gt;mutex);</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a08fc2e4060c8c78c7640519d9495bf9c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void* client_send_thread </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>handle</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Try to send data to the real OML server </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">handle</td><td>the client data structure i.e. a pointer to a Client*. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="sender_8c_source.html#l00147">147</a> of file <a class="el" href="sender_8c_source.html">sender.c</a>.</p>

<p>References <a class="el" href="proxy__client_8h_source.html#l00046">C_CONFIGURE</a>, <a class="el" href="proxy__client_8h_source.html#l00049">C_DISCONNECTED</a>, <a class="el" href="proxy__client_8h_source.html#l00045">C_HEADER</a>, <a class="el" href="cbuf_8c_source.html#l00220">cbuf_advance_cursor()</a>, <a class="el" href="cbuf_8c_source.html#l00245">cbuf_consume_cursor()</a>, <a class="el" href="cbuf_8c_source.html#l00210">cbuf_cursor_page_remaining()</a>, <a class="el" href="cbuf_8c_source.html#l00200">cbuf_cursor_pointer()</a>, <a class="el" href="proxy__client_8c_source.html#l00074">client_free()</a>, <a class="el" href="sender_8c_source.html#l00110">client_send_headers()</a>, <a class="el" href="sender_8c_source.html#l00034">client_sender_connect()</a>, <a class="el" href="proxy__client_8h_source.html#l00097">_client::condvar</a>, <a class="el" href="stddev__0_8c_source.html#l00021">count</a>, <a class="el" href="message__queue_8h_source.html#l00031">msg_queue_node::cursor</a>, <a class="el" href="cbuf_8h_source.html#l00029">cbuffer_page::fill</a>, <a class="el" href="message_8h_source.html#l00032">oml_message::length</a>, <a class="el" href="message__queue_8h_source.html#l00036">msg_queue::length</a>, <a class="el" href="log_8c_source.html#l00333">logdebug()</a>, <a class="el" href="log_8c_source.html#l00321">loginfo()</a>, <a class="el" href="proxy__client_8h_source.html#l00088">_client::messages</a>, <a class="el" href="message__queue_8h_source.html#l00030">msg_queue_node::msg</a>, <a class="el" href="message__queue_8c_source.html#l00072">msg_queue_head()</a>, <a class="el" href="message__queue_8c_source.html#l00082">msg_queue_remove()</a>, <a class="el" href="proxy__client_8h_source.html#l00096">_client::mutex</a>, <a class="el" href="o__socket_8h_source.html#l00045">Socket::name</a>, <a class="el" href="cbuf_8h_source.html#l00042">cbuffer_cursor::page</a>, <a class="el" href="session_8h_source.html#l00029">ProxyState_PAUSED</a>, <a class="el" href="session_8h_source.html#l00030">ProxyState_SENDING</a>, <a class="el" href="proxy__client_8h_source.html#l00080">_client::recv_socket</a>, <a class="el" href="proxy__client_8h_source.html#l00081">_client::send_socket</a>, <a class="el" href="proxy__client_8h_source.html#l00082">_client::sender_connected</a>, <a class="el" href="message_8h_source.html#l00029">oml_message::seqno</a>, <a class="el" href="oml2-proxy-server_8c_source.html#l00053">session</a>, <a class="el" href="proxy__client_8h_source.html#l00062">_client::session</a>, <a class="el" href="session_8c_source.html#l00026">session_remove_client()</a>, <a class="el" href="oml2-proxy-server_8c_source.html#l00051">sigpipe_flag</a>, <a class="el" href="session_8h_source.html#l00035">_session::state</a>, and <a class="el" href="proxy__client_8h_source.html#l00072">_client::state</a>.</p>

<p>Referenced by <a class="el" href="oml2-proxy-server_8c_source.html#l00143">on_connect()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="struct__client.html">Client</a> *client = (<a class="code" href="struct__client.html">Client</a>*)handle;</div>
<div class="line">  <a class="code" href="struct__session.html">Session</a> *<a class="code" href="oml2-proxy-server_8c.html#a6b32f07deadd1d267d1b669bc819f4fe">session</a> = client-&gt;<a class="code" href="struct__client.html#a97ab583f1fde5791522319fa02b19b47">session</a>;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="log_8c.html#aea4dca1a8e24794377ba1bf45fbbfce8">loginfo</a> (<span class="stringliteral">&quot;&#39;%s&#39;: client sender thread started\n&quot;</span>, client-&gt;<a class="code" href="struct__client.html#ac8e04edc05f30e30c8bb27949ca538e8">recv_socket</a>-&gt;<a class="code" href="structSocket.html#a0777b306460511cf44c7ff0935e14348">name</a>);</div>
<div class="line">  pthread_mutex_lock (&amp;client-&gt;<a class="code" href="struct__client.html#aaf0a1fc03a0da21247122a080bf53da6">mutex</a>);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;Mutex locked...\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">while</span>(1) {</div>
<div class="line">    <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;Sender waiting...\n&quot;</span>);</div>
<div class="line">    pthread_cond_wait (&amp;client-&gt;<a class="code" href="struct__client.html#aea55ded0a1ad83fcaf33eeb50e2e54b7">condvar</a>, &amp;client-&gt;<a class="code" href="struct__client.html#aaf0a1fc03a0da21247122a080bf53da6">mutex</a>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct__session.html#a2085db2e358b0ad60c1412f0efd25473">state</a> == <a class="code" href="session_8h.html#a25e9a86878af66f124d069ff1ea8da5ea7d1818a2209457b192befad3bc551957">ProxyState_SENDING</a>) {</div>
<div class="line">      <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="struct__client.html#a2837954835d22a93b75795a271d15376">sender_connected</a>) {</div>
<div class="line">        <span class="comment">// try to connect</span></div>
<div class="line">        <span class="keywordflow">if</span> (client-&gt;<a class="code" href="struct__client.html#a42c195e1d36d935f56c87888e35cd3df">state</a> == <a class="code" href="proxy__client_8h.html#a8d4a6786d6193f0e6245c44e4a7bb4a0a56dc878997593e5c3e69f07676f6b1e3">C_HEADER</a> || client-&gt;<a class="code" href="struct__client.html#a42c195e1d36d935f56c87888e35cd3df">state</a> == <a class="code" href="proxy__client_8h.html#a8d4a6786d6193f0e6245c44e4a7bb4a0a8b60b848d3f4e9f001a14ec0443d3dc8">C_CONFIGURE</a>)</div>
<div class="line">          <span class="keywordflow">continue</span>; <span class="comment">// Haven&#39;t finished receiving the headers</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">        pthread_mutex_unlock (&amp;client-&gt;<a class="code" href="struct__client.html#aaf0a1fc03a0da21247122a080bf53da6">mutex</a>);</div>
<div class="line">        <span class="keywordflow">while</span> (!client-&gt;<a class="code" href="struct__client.html#a2837954835d22a93b75795a271d15376">sender_connected</a> &amp;&amp; session-&gt;<a class="code" href="struct__session.html#a2085db2e358b0ad60c1412f0efd25473">state</a> == <a class="code" href="session_8h.html#a25e9a86878af66f124d069ff1ea8da5ea7d1818a2209457b192befad3bc551957">ProxyState_SENDING</a>) {</div>
<div class="line">          <span class="keywordflow">if</span> (<a class="code" href="sender_8c.html#a347b49ab8337a5e541824ed7000de7be">client_sender_connect</a> (client) == 0) {</div>
<div class="line">            <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;Connected to downstream OK\n&quot;</span>);</div>
<div class="line">            client-&gt;<a class="code" href="struct__client.html#a2837954835d22a93b75795a271d15376">sender_connected</a> = 1;</div>
<div class="line">          } <span class="keywordflow">else</span> {</div>
<div class="line">            <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;Failed to connect to downstream:  %s\n&quot;</span>, strerror (errno));</div>
<div class="line">            sleep (1); <span class="comment">// Retry every second.</span></div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">          }</div>
<div class="line">        }</div>
<div class="line">        pthread_mutex_lock (&amp;client-&gt;<a class="code" href="struct__client.html#aaf0a1fc03a0da21247122a080bf53da6">mutex</a>);</div>
<div class="line">        <span class="keywordflow">if</span> (client-&gt;<a class="code" href="struct__client.html#a2837954835d22a93b75795a271d15376">sender_connected</a> &amp;&amp; <a class="code" href="sender_8c.html#a3ae7c2b86ec08ca0e69988a0683a54b2">client_send_headers</a> (client) == -1) {</div>
<div class="line">          <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;Something failed while sending headers:  %s\n&quot;</span>, strerror (errno));</div>
<div class="line">          client-&gt;<a class="code" href="struct__client.html#a2837954835d22a93b75795a271d15376">sender_connected</a> = 0;</div>
<div class="line">          <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">while</span> (client-&gt;<a class="code" href="struct__client.html#abc32c7d05cc2d8200653229687c05b1e">messages</a>-&gt;<a class="code" href="structmsg__queue.html#a3e9c332da727c18f23ad223a4b3457ae">length</a> &gt; 0 &amp;&amp; client-&gt;<a class="code" href="struct__client.html#a2837954835d22a93b75795a271d15376">sender_connected</a>) {</div>
<div class="line">        <span class="keyword">struct </span><a class="code" href="structmsg__queue__node.html">msg_queue_node</a> *head = <a class="code" href="message__queue_8c.html#a6fac57a3dbebdc8a1a0ec8aa4f8c3f60">msg_queue_head</a> (client-&gt;<a class="code" href="struct__client.html#abc32c7d05cc2d8200653229687c05b1e">messages</a>);</div>
<div class="line">        <span class="keyword">struct </span><a class="code" href="structcbuffer__cursor.html">cbuffer_cursor</a> cursor = head-&gt;<a class="code" href="structmsg__queue__node.html#a62f5f06e758698c1bb85d8f105a6bc6c">cursor</a>;</div>
<div class="line">        <span class="keywordtype">size_t</span> length = head-&gt;<a class="code" href="structmsg__queue__node.html#a2ddba7a4abcbe8e787140736a6b3774c">msg</a>-&gt;<a class="code" href="structoml__message.html#a2ec2e3b0ab3f3fff27bbcc78a795c01a">length</a>;</div>
<div class="line">        <span class="keywordtype">size_t</span> <a class="code" href="stddev__0_8c.html#af16d1aad57793bdd673526c79ac6fbfe">count</a> = 0;</div>
<div class="line">        <span class="keywordtype">int</span> result = 0;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">while</span> (length &gt; 0) {</div>
<div class="line">          <span class="keywordtype">char</span> *buf = <a class="code" href="cbuf_8c.html#a24ea44e33badc2a8d96f3888ba93f2fd">cbuf_cursor_pointer</a> (&amp;cursor);</div>
<div class="line">          <span class="keywordtype">size_t</span> page_remaining = <a class="code" href="cbuf_8c.html#a2b5a6566526ee8cbf8146cad8aaac218">cbuf_cursor_page_remaining</a> (&amp;cursor);</div>
<div class="line">          <span class="keywordtype">size_t</span> to_write = length &lt; page_remaining ? length : page_remaining;</div>
<div class="line"></div>
<div class="line">          <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;Seqno: %d Sending %d bytes (fill=%d, remain=%d)\n&quot;</span>, head-&gt;<a class="code" href="structmsg__queue__node.html#a2ddba7a4abcbe8e787140736a6b3774c">msg</a>-&gt;<a class="code" href="structoml__message.html#a394653d7de7bb4bb3e1159a7123ae4ea">seqno</a>, to_write, cursor.<a class="code" href="structcbuffer__cursor.html#a9dbfc30280fe23566950586ec303e69b">page</a>-&gt;<a class="code" href="structcbuffer__page.html#a50dcf482a43712b10457b11877d5daa4">fill</a>, page_remaining);</div>
<div class="line">          pthread_mutex_unlock (&amp;client-&gt;<a class="code" href="struct__client.html#aaf0a1fc03a0da21247122a080bf53da6">mutex</a>);</div>
<div class="line">          result = send (client-&gt;<a class="code" href="struct__client.html#a66338ba37185c4825ea7ad032dfc75b8">send_socket</a>, buf, to_write, 0);</div>
<div class="line">          pthread_mutex_lock (&amp;client-&gt;<a class="code" href="struct__client.html#aaf0a1fc03a0da21247122a080bf53da6">mutex</a>);</div>
<div class="line"></div>
<div class="line">          <span class="keywordflow">if</span> (result == -1) {</div>
<div class="line">            <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;send(2) returned -1 (%s)\n&quot;</span>, strerror (errno));</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="oml2-proxy-server_8c.html#aabe906df2e9b738fc184732415dc7f48">sigpipe_flag</a> == 1) {</div>
<div class="line">              <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;sigpipe_flag is 1\n&quot;</span>);</div>
<div class="line">              <a class="code" href="oml2-proxy-server_8c.html#aabe906df2e9b738fc184732415dc7f48">sigpipe_flag</a> = 0;</div>
<div class="line">            }</div>
<div class="line">            client-&gt;<a class="code" href="struct__client.html#a2837954835d22a93b75795a271d15376">sender_connected</a> = 0;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (result &lt; (<span class="keywordtype">int</span>)to_write) {</div>
<div class="line">            <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;Wrote less than expected \n&quot;</span>);</div>
<div class="line">          }</div>
<div class="line">          <a class="code" href="cbuf_8c.html#af1cd117458fa10c6b47ed96b9f1e1f4d">cbuf_advance_cursor</a> (&amp;cursor, result);</div>
<div class="line">          length -= result;</div>
<div class="line">          count += result;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (result != -1) {</div>
<div class="line">          <a class="code" href="cbuf_8c.html#af2f74ead176da7ee81ba38179d7e513d">cbuf_consume_cursor</a> (&amp;head-&gt;<a class="code" href="structmsg__queue__node.html#a62f5f06e758698c1bb85d8f105a6bc6c">cursor</a>, head-&gt;<a class="code" href="structmsg__queue__node.html#a2ddba7a4abcbe8e787140736a6b3774c">msg</a>-&gt;<a class="code" href="structoml__message.html#a2ec2e3b0ab3f3fff27bbcc78a795c01a">length</a>);</div>
<div class="line">          <a class="code" href="message__queue_8c.html#a360e2dfeee254ec5d779b3859083d38c">msg_queue_remove</a> (client-&gt;<a class="code" href="struct__client.html#abc32c7d05cc2d8200653229687c05b1e">messages</a>);</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">if</span> (client-&gt;<a class="code" href="struct__client.html#a42c195e1d36d935f56c87888e35cd3df">state</a> == <a class="code" href="proxy__client_8h.html#a8d4a6786d6193f0e6245c44e4a7bb4a0a0f3ff8121e7e63d8e0b3bd1263f89b9c">C_DISCONNECTED</a> &amp;&amp; client-&gt;<a class="code" href="struct__client.html#abc32c7d05cc2d8200653229687c05b1e">messages</a>-&gt;<a class="code" href="structmsg__queue.html#a3e9c332da727c18f23ad223a4b3457ae">length</a> == 0) {</div>
<div class="line">        <a class="code" href="log_8c.html#aea4dca1a8e24794377ba1bf45fbbfce8">loginfo</a> (<span class="stringliteral">&quot;Client disconnected and all pending measurements have been sent; shutting down this client\n&quot;</span>);</div>
<div class="line">        shutdown (client-&gt;<a class="code" href="struct__client.html#a66338ba37185c4825ea7ad032dfc75b8">send_socket</a>, SHUT_RDWR);</div>
<div class="line">        sleep (1);</div>
<div class="line">        close (client-&gt;<a class="code" href="struct__client.html#a66338ba37185c4825ea7ad032dfc75b8">send_socket</a>);</div>
<div class="line">        <a class="code" href="session_8c.html#ac9d9810128c3d1c2b176e0e71f584891">session_remove_client</a> (session, client);</div>
<div class="line">        <a class="code" href="proxy__client_8c.html#a96b937ad742816e42110300545e376b2">client_free</a> (client);</div>
<div class="line">        pthread_exit (NULL);</div>
<div class="line">      }</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct__session.html#a2085db2e358b0ad60c1412f0efd25473">state</a> == <a class="code" href="session_8h.html#a25e9a86878af66f124d069ff1ea8da5eaa38f3858b2e01da9917f5659d3d950ea">ProxyState_PAUSED</a> &amp;&amp; client-&gt;<a class="code" href="struct__client.html#a2837954835d22a93b75795a271d15376">sender_connected</a>) {</div>
<div class="line">      shutdown (client-&gt;<a class="code" href="struct__client.html#a66338ba37185c4825ea7ad032dfc75b8">send_socket</a>, SHUT_RDWR);</div>
<div class="line">      sleep (1);</div>
<div class="line">      close (client-&gt;<a class="code" href="struct__client.html#a66338ba37185c4825ea7ad032dfc75b8">send_socket</a>);</div>
<div class="line">      client-&gt;<a class="code" href="struct__client.html#a2837954835d22a93b75795a271d15376">sender_connected</a> = 0;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ac0f2228420376f4db7e1274f2b41667c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>argc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>argv</em>[]&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00307">307</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

<p>References <a class="el" href="oml2-proxy-server_8c_source.html#l00031">COPYRIGHT</a>, <a class="el" href="eventloop_8c_source.html#l00210">eventloop_init()</a>, <a class="el" href="eventloop_8c_source.html#l00570">eventloop_on_stdin()</a>, <a class="el" href="eventloop_8c_source.html#l00257">eventloop_run()</a>, <a class="el" href="log_8c_source.html#l00297">logerror()</a>, <a class="el" href="log_8c_source.html#l00321">loginfo()</a>, <a class="el" href="mem_8c_source.html#l00240">oml_free()</a>, <a class="el" href="mem_8c_source.html#l00157">oml_malloc()</a>, <a class="el" href="oml2-proxy-server_8c_source.html#l00143">on_connect()</a>, <a class="el" href="oml2-proxy-server_8c_source.html#l00261">on_control_connect()</a>, <a class="el" href="oml2-proxy-server_8c_source.html#l00057">options</a>, <a class="el" href="oml2-proxy-server_8c_source.html#l00177">prepare_stdin()</a>, <a class="el" href="session_8h_source.html#l00029">ProxyState_PAUSED</a>, <a class="el" href="oml2-proxy-server_8c_source.html#l00292">setup_logging()</a>, <a class="el" href="oml2-proxy-server_8c_source.html#l00269">sigpipe_handler()</a>, <a class="el" href="socket_8c_source.html#l00157">socket_free()</a>, <a class="el" href="socket_8c_source.html#l00464">socket_server_new()</a>, <a class="el" href="session_8h_source.html#l00035">_session::state</a>, <a class="el" href="oml2-proxy-server_8c_source.html#l00218">stdin_handler()</a>, <a class="el" href="oml2-proxy-server_8c_source.html#l00030">V_STRING</a>, and <a class="el" href="config_8h_source.html#l00164">VERSION</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="structSocket.html">Socket</a>* serverSock, *controlSock;</div>
<div class="line">  <span class="keywordtype">int</span> c, ret = -1;</div>
<div class="line"></div>
<div class="line">  poptContext optCon = poptGetContext(NULL, argc, argv, <a class="code" href="oml2-proxy-server_8c.html#a2e48d05a30e5baae3312f63532cd9c21">options</a>, 0);</div>
<div class="line">  poptSetOtherOptionHelp(optCon, <span class="stringliteral">&quot;configFile&quot;</span>);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">while</span> ((c = poptGetNextOpt(optCon)) &gt;= 0) {</div>
<div class="line">    <span class="keywordflow">switch</span> (c) {</div>
<div class="line">    <span class="keywordflow">case</span> <span class="charliteral">&#39;v&#39;</span>:</div>
<div class="line">      printf(<a class="code" href="oml2-proxy-server_8c.html#a343bac9aba102cbb8787eefba33dd873">V_STRING</a>, <a class="code" href="config_8h.html#a1c6d5de492ac61ad29aec7aa9a436bbf">VERSION</a>);</div>
<div class="line">      printf(<a class="code" href="oml2-proxy-server_8c.html#a6247bc79b0a606bddbf5a90fc3a03194">COPYRIGHT</a>);</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <a class="code" href="oml2-proxy-server_8c.html#a6bb68560564aadd06dfa334b3adb7092">setup_logging</a> (logfile_name, log_level);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (c &lt; -1) {</div>
<div class="line">    <span class="comment">/* an error occurred during option processing */</span></div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;%s: %s\n&quot;</span>,</div>
<div class="line">      poptBadOption(optCon, POPT_BADOPTION_NOALIAS),</div>
<div class="line">      poptStrerror(c));</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <a class="code" href="log_8c.html#aea4dca1a8e24794377ba1bf45fbbfce8">loginfo</a> (<a class="code" href="oml2-proxy-server_8c.html#a343bac9aba102cbb8787eefba33dd873">V_STRING</a>, <a class="code" href="config_8h.html#a1c6d5de492ac61ad29aec7aa9a436bbf">VERSION</a>);</div>
<div class="line">  <a class="code" href="log_8c.html#aea4dca1a8e24794377ba1bf45fbbfce8">loginfo</a> (<a class="code" href="oml2-proxy-server_8c.html#a6247bc79b0a606bddbf5a90fc3a03194">COPYRIGHT</a>);</div>
<div class="line"></div>
<div class="line">  <span class="keyword">struct </span>sigaction new_action, old_action;</div>
<div class="line">  new_action.sa_handler = <a class="code" href="oml2-proxy-server_8c.html#aceab8c76067d9fb567c8f5a94d79d2ab">sigpipe_handler</a>;</div>
<div class="line">  sigemptyset (&amp;new_action.sa_mask);</div>
<div class="line">  new_action.sa_flags = 0;</div>
<div class="line">  sigaction (SIGPIPE, NULL, &amp;old_action);</div>
<div class="line">  <span class="keywordflow">if</span> (old_action.sa_handler != SIG_IGN)</div>
<div class="line">    sigaction (SIGPIPE, &amp;new_action, NULL);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="oml2-proxy-server_8c.html#a17854ad7b1185ec8b3ff659e84c3fd43">prepare_stdin</a>(NULL);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="eventloop_8c.html#a45deede034510d863a4b474020000c50">eventloop_init</a>();</div>
<div class="line">  <a class="code" href="oml2-proxy-server_8c.html#a6b32f07deadd1d267d1b669bc819f4fe">session</a> = (<a class="code" href="struct__session.html">Session</a>*)<a class="code" href="omlc_8h.html#a8616cb714d6589098267bba8fc7b48c2">oml_malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="struct__session.html">Session</a>));</div>
<div class="line">  memset(<a class="code" href="oml2-proxy-server_8c.html#a6b32f07deadd1d267d1b669bc819f4fe">session</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct__session.html">Session</a>));</div>
<div class="line"></div>
<div class="line">  <a class="code" href="oml2-proxy-server_8c.html#a6b32f07deadd1d267d1b669bc819f4fe">session</a>-&gt;<a class="code" href="struct__session.html#a2085db2e358b0ad60c1412f0efd25473">state</a> = <a class="code" href="session_8h.html#a25e9a86878af66f124d069ff1ea8da5eaa38f3858b2e01da9917f5659d3d950ea">ProxyState_PAUSED</a>;</div>
<div class="line"></div>
<div class="line">  serverSock = <a class="code" href="o__socket_8h.html#a147759fb9e8c7fb90e7a793f9a03a625">socket_server_new</a>(<span class="stringliteral">&quot;proxy_server&quot;</span>, NULL, listen_service, <a class="code" href="oml2-proxy-server_8c.html#ab2f3e668cb06e8ae19e51c19db33867b">on_connect</a>, NULL);</div>
<div class="line">  controlSock = <a class="code" href="o__socket_8h.html#a147759fb9e8c7fb90e7a793f9a03a625">socket_server_new</a>(<span class="stringliteral">&quot;proxy_server_control&quot;</span>, NULL, control_service, <a class="code" href="oml2-proxy-server_8c.html#afae559d162109a3db6d4d845647a9cb3">on_control_connect</a>, NULL);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span>(!serverSock || !controlSock) {</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Unable to listen for either client and/or control connections&quot;</span>);</div>
<div class="line">    ret = -1;</div>
<div class="line"></div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <a class="code" href="eventloop_8c.html#a6537912ef0101ca297eedb9379f707b8">eventloop_on_stdin</a>(<a class="code" href="oml2-proxy-server_8c.html#af32816f7efaf256ba76c084cb7af378f">stdin_handler</a>, <a class="code" href="oml2-proxy-server_8c.html#a6b32f07deadd1d267d1b669bc819f4fe">session</a>);</div>
<div class="line">    <a class="code" href="eventloop_8c.html#a6710d8fae8055047ce8c73eb3b817c80">eventloop_run</a>();</div>
<div class="line">    ret = 0;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <a class="code" href="o__socket_8h.html#a1c0850933bb110c33fbdb774c0221904">socket_free</a>(serverSock);</div>
<div class="line">  <a class="code" href="o__socket_8h.html#a1c0850933bb110c33fbdb774c0221904">socket_free</a>(controlSock);</div>
<div class="line">  <a class="code" href="omlc_8h.html#aa191af748bdc144fc077967bdacaaf70">oml_free</a>(<a class="code" href="oml2-proxy-server_8c.html#a6b32f07deadd1d267d1b669bc819f4fe">session</a>);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ab2f3e668cb06e8ae19e51c19db33867b"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void on_connect </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSocket.html">Socket</a> *&#160;</td>
          <td class="paramname"><em>client_sock</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>handle</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Callback function called when a node connects via TCP </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">client_sock</td><td><a class="el" href="structSocket.html">Socket</a> of the client </td></tr>
    <tr><td class="paramname">handle</td><td>the client handler </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00143">143</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

<p>References <a class="el" href="oml2-proxy-server_8c_source.html#l00081">client_callback()</a>, <a class="el" href="session_8h_source.html#l00037">_session::client_count</a>, <a class="el" href="proxy__client_8c_source.html#l00045">client_new()</a>, <a class="el" href="sender_8c_source.html#l00147">client_send_thread()</a>, <a class="el" href="eventloop_8c_source.html#l00592">eventloop_on_read_in_channel()</a>, <a class="el" href="log_8c_source.html#l00333">logdebug()</a>, <a class="el" href="mstring_8c_source.html#l00222">mstring_buf()</a>, <a class="el" href="mstring_8c_source.html#l00073">mstring_create()</a>, <a class="el" href="mstring_8c_source.html#l00237">mstring_delete()</a>, <a class="el" href="mstring_8c_source.html#l00160">mstring_sprintf()</a>, <a class="el" href="proxy__client_8h_source.html#l00079">_client::recv_event</a>, <a class="el" href="oml2-proxy-server_8c_source.html#l00053">session</a>, <a class="el" href="proxy__client_8h_source.html#l00062">_client::session</a>, <a class="el" href="session_8c_source.html#l00017">session_add_client()</a>, <a class="el" href="oml2-proxy-server_8c_source.html#l00114">status_callback()</a>, and <a class="el" href="proxy__client_8h_source.html#l00095">_client::thread</a>.</p>

<p>Referenced by <a class="el" href="oml2-proxy-server_8c_source.html#l00307">main()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  (void)handle;  <span class="comment">// This parameter is unused</span></div>
<div class="line">  <a class="code" href="structMString.html">MString</a> *mstr = <a class="code" href="mstring_8c.html#a49f0faf4fe4e38a6d7b4f0ef09d5fd24">mstring_create</a> ();</div>
<div class="line"></div>
<div class="line">  <a class="code" href="mstring_8c.html#ad28234c6cddf0af9ad2c538885e70ebf">mstring_sprintf</a> (mstr,<span class="stringliteral">&quot;%s.%d&quot;</span>, resultfile_name, <a class="code" href="oml2-proxy-server_8c.html#a6b32f07deadd1d267d1b669bc819f4fe">session</a>-&gt;<a class="code" href="struct__session.html#a5f8907f898b8be867dee9fed2d09bd84">client_count</a>);</div>
<div class="line">  <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a>(<span class="stringliteral">&quot;New client (index %d) connected\n&quot;</span>, <a class="code" href="oml2-proxy-server_8c.html#a6b32f07deadd1d267d1b669bc819f4fe">session</a>-&gt;<a class="code" href="struct__session.html#a5f8907f898b8be867dee9fed2d09bd84">client_count</a>);</div>
<div class="line">  <a class="code" href="oml2-proxy-server_8c.html#a6b32f07deadd1d267d1b669bc819f4fe">session</a>-&gt;<a class="code" href="struct__session.html#a5f8907f898b8be867dee9fed2d09bd84">client_count</a>++;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="struct__client.html">Client</a>* client = <a class="code" href="proxy__client_8c.html#a3cabd294befa14a6cfe31776f9af01be">client_new</a>(client_sock, page_size, <a class="code" href="mstring_8c.html#ab18dbe1f8aa51964e0a15813991daf73">mstring_buf</a> (mstr),</div>
<div class="line">                              downstream_port, downstream_address);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="mstring_8c.html#a22eb366ee3317407b4233d6216b690a3">mstring_delete</a> (mstr);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="session_8c.html#a3e1246c729903e822991d19e93a306f0">session_add_client</a> (<a class="code" href="oml2-proxy-server_8c.html#a6b32f07deadd1d267d1b669bc819f4fe">session</a>, client);</div>
<div class="line">  client-&gt;<a class="code" href="struct__client.html#a97ab583f1fde5791522319fa02b19b47">session</a> = <a class="code" href="oml2-proxy-server_8c.html#a6b32f07deadd1d267d1b669bc819f4fe">session</a>;</div>
<div class="line"></div>
<div class="line">  client-&gt;<a class="code" href="struct__client.html#acae7f11fd01e970f118723409a5356a5">recv_event</a> = <a class="code" href="eventloop_8c.html#a38c2768f989f1c537db87db9d2fee016">eventloop_on_read_in_channel</a>(client_sock, <a class="code" href="oml2-proxy-server_8c.html#ad06be2215447c5882d6a2e65c5708368">client_callback</a>,</div>
<div class="line">                                                    <a class="code" href="oml2-proxy-server_8c.html#ab407b62e3136824fb73bbbb5839cea56">status_callback</a>, (<span class="keywordtype">void</span>*)client);</div>
<div class="line"></div>
<div class="line">  pthread_create (&amp;client-&gt;<a class="code" href="struct__client.html#a22dd92bbac40e690542603ea9783df09">thread</a>, NULL, <a class="code" href="oml2-proxy-server_8c.html#a08fc2e4060c8c78c7640519d9495bf9c">client_send_thread</a>, (<span class="keywordtype">void</span>*)client);</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="afae559d162109a3db6d4d845647a9cb3"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void on_control_connect </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSocket.html">Socket</a> *&#160;</td>
          <td class="paramname"><em>sock</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>handle</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00261">261</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

<p>References <a class="el" href="eventloop_8c_source.html#l00592">eventloop_on_read_in_channel()</a>, <a class="el" href="log_8c_source.html#l00333">logdebug()</a>, and <a class="el" href="oml2-proxy-server_8c_source.html#l00218">stdin_handler()</a>.</p>

<p>Referenced by <a class="el" href="oml2-proxy-server_8c_source.html#l00307">main()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  (void)handle; <span class="comment">// This parameter is unused</span></div>
<div class="line">  <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;New control connection\n&quot;</span>);</div>
<div class="line">  <a class="code" href="eventloop_8c.html#a38c2768f989f1c537db87db9d2fee016">eventloop_on_read_in_channel</a> (sock, <a class="code" href="oml2-proxy-server_8c.html#af32816f7efaf256ba76c084cb7af378f">stdin_handler</a>, NULL, (<span class="keywordtype">void</span>*)<a class="code" href="oml2-proxy-server_8c.html#a6b32f07deadd1d267d1b669bc819f4fe">session</a>);</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a17854ad7b1185ec8b3ff659e84c3fd43"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void* prepare_stdin </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>handle</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00177">177</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

<p>References <a class="el" href="stddev__0_8c_source.html#l00021">count</a>, and <a class="el" href="log_8c_source.html#l00297">logerror()</a>.</p>

<p>Referenced by <a class="el" href="oml2-proxy-server_8c_source.html#l00307">main()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  (void)handle;</div>
<div class="line"><span class="preprocessor">#ifdef __APPLE__</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keyword">static</span> <span class="keywordtype">int</span> thread_started = 0;</div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">int</span> stdin_dup;</div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">int</span> stdin_pipe[2];</div>
<div class="line">  <span class="keyword">static</span> pthread_t <span class="keyword">self</span>;</div>
<div class="line">  <span class="keywordflow">if</span> (!thread_started) {</div>
<div class="line">    <span class="keywordtype">int</span> result;</div>
<div class="line">    result = pipe (stdin_pipe);</div>
<div class="line">    <span class="keywordflow">if</span> (result) {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a> (<span class="stringliteral">&quot;Could not create pipe for stdin duplication: %s\n&quot;</span>, strerror(errno));</div>
<div class="line">      exit(EXIT_FAILURE);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    stdin_dup = dup(fileno(stdin));</div>
<div class="line">    dup2(stdin_pipe[0], fileno(stdin));</div>
<div class="line"></div>
<div class="line">    thread_started = 1;</div>
<div class="line">    result = pthread_create (&amp;<span class="keyword">self</span>, NULL, <a class="code" href="oml2-proxy-server_8c.html#a17854ad7b1185ec8b3ff659e84c3fd43">prepare_stdin</a>, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (result == -1) {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a> (<span class="stringliteral">&quot;Error creating thread for reading stdin: %s\n&quot;</span>, strerror (errno));</div>
<div class="line">      exit (EXIT_FAILURE);</div>
<div class="line">    }</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="keywordtype">char</span> buf [512];</div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line">      ssize_t <a class="code" href="stddev__0_8c.html#af16d1aad57793bdd673526c79ac6fbfe">count</a> = read (stdin_dup, buf, 512);</div>
<div class="line">      <span class="keywordflow">if</span> (count &lt; 0)</div>
<div class="line">        <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a> (<span class="stringliteral">&quot;Error reading from stdin: %s\n&quot;</span>, strerror(errno));</div>
<div class="line">      <span class="keywordflow">if</span> (count &lt;= 0)</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">      write (stdin_pipe[1], buf, count);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ad5cbe5e00caa71043883f331d1d05fd7"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void proxy_message_loop </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>client_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="proxy__client_8h.html#a3a773b70e1497bdce4b49dc601e97663">Client</a> *&#160;</td>
          <td class="paramname"><em>client</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="receiver_8c_source.html#l00145">145</a> of file <a class="el" href="receiver_8c_source.html">receiver.c</a>.</p>

<p>Referenced by <a class="el" href="oml2-proxy-server_8c_source.html#l00081">client_callback()</a>, and <a class="el" href="msgloop_8c_source.html#l00144">main()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="structMBuffer.html">MBuffer</a> *mbuf = client-&gt;<a class="code" href="struct__client.html#a783ee704d1d58b9540f35551ff8fbe2e">mbuf</a>;</div>
<div class="line">  <span class="keyword">struct </span><a class="code" href="structheader.html">header</a> *<a class="code" href="check__libshared__headers_8c.html#a41d770ad2f3cb946006035f9e550deca">header</a>;</div>
<div class="line">  <span class="keyword">struct </span><a class="code" href="structoml__message.html">oml_message</a> msg;</div>
<div class="line">  <span class="keywordtype">int</span> result;</div>
<div class="line">  <span class="keywordtype">size_t</span> message_length;</div>
<div class="line"></div>
<div class="line">  result = <a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a> (mbuf, buf, size);</div>
<div class="line">  <span class="keywordflow">if</span> (result == -1) {</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a> (<span class="stringliteral">&quot;&#39;%s&#39;: Failed to write message from client into message buffer. Data is being lost!\n&quot;</span>,</div>
<div class="line">              client_id);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line"> <a class="code" href="generator_8c.html#ad667f040f2932c8097435492fbd10d76">loop</a>:</div>
<div class="line">  <span class="keywordflow">switch</span> (client-&gt;<a class="code" href="struct__client.html#a42c195e1d36d935f56c87888e35cd3df">state</a>) {</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="proxy__client_8h.html#a8d4a6786d6193f0e6245c44e4a7bb4a0a56dc878997593e5c3e69f07676f6b1e3">C_HEADER</a>:</div>
<div class="line">    <span class="comment">/* Read headers until out of header data to read*/</span></div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="receiver_8c.html#ab418f1122904b249b4636966c6d10da8">read_header</a> (client, mbuf) == 1);</div>
<div class="line">    <span class="keywordflow">if</span> (client-&gt;<a class="code" href="struct__client.html#a42c195e1d36d935f56c87888e35cd3df">state</a> != <a class="code" href="proxy__client_8h.html#a8d4a6786d6193f0e6245c44e4a7bb4a0a56dc878997593e5c3e69f07676f6b1e3">C_HEADER</a>)</div>
<div class="line">      <span class="keywordflow">goto</span> <a class="code" href="generator_8c.html#ad667f040f2932c8097435492fbd10d76">loop</a>;</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="proxy__client_8h.html#a8d4a6786d6193f0e6245c44e4a7bb4a0a8b60b848d3f4e9f001a14ec0443d3dc8">C_CONFIGURE</a>:</div>
<div class="line">    <span class="keywordflow">if</span> (client-&gt;<a class="code" href="struct__client.html#a16b6787c585ac7c8cb16d851c23872fd">header_table</a>[<a class="code" href="headers_8h.html#ae31554efa3bd3b0ccd99751564fda0a3a17ea790e7531eb89995dcfd435b9bab3">H_DOMAIN</a>] == NULL ||</div>
<div class="line">        client-&gt;<a class="code" href="struct__client.html#a16b6787c585ac7c8cb16d851c23872fd">header_table</a>[<a class="code" href="headers_8h.html#ae31554efa3bd3b0ccd99751564fda0a3ac5d2d4a99591d9d4ce685eacc863c343">H_CONTENT</a>] == NULL ||</div>
<div class="line">        client-&gt;<a class="code" href="struct__client.html#a16b6787c585ac7c8cb16d851c23872fd">header_table</a>[<a class="code" href="headers_8h.html#ae31554efa3bd3b0ccd99751564fda0a3a17ea790e7531eb89995dcfd435b9bab3">H_DOMAIN</a>]-&gt;<a class="code" href="structheader.html#a2d27d52dac3b49d72a94e4f0037e1b19">tag</a> == <a class="code" href="headers_8h.html#ae31554efa3bd3b0ccd99751564fda0a3a85b35c8082d4f407528822de8ecca22b">H_NONE</a> ||</div>
<div class="line">        client-&gt;<a class="code" href="struct__client.html#a16b6787c585ac7c8cb16d851c23872fd">header_table</a>[<a class="code" href="headers_8h.html#ae31554efa3bd3b0ccd99751564fda0a3ac5d2d4a99591d9d4ce685eacc863c343">H_CONTENT</a>]-&gt;<a class="code" href="structheader.html#a2d27d52dac3b49d72a94e4f0037e1b19">tag</a> == <a class="code" href="headers_8h.html#ae31554efa3bd3b0ccd99751564fda0a3a85b35c8082d4f407528822de8ecca22b">H_NONE</a>) {</div>
<div class="line">      <span class="keywordflow">if</span> (client-&gt;<a class="code" href="struct__client.html#ac26950582d1b1f44bee860273abf20db">headers</a> == NULL) {</div>
<div class="line">        <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;Headers NULL!&quot;</span>);</div>
<div class="line">      }</div>
<div class="line">      client-&gt;<a class="code" href="struct__client.html#a42c195e1d36d935f56c87888e35cd3df">state</a> = <a class="code" href="proxy__client_8h.html#a8d4a6786d6193f0e6245c44e4a7bb4a0ae5948dea6f5f07cf3b03e786128dda68">C_PROTOCOL_ERROR</a>;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      client-&gt;<a class="code" href="struct__client.html#a6e6713aaa2f447cb41a3639f0b524050">domain</a> = client-&gt;<a class="code" href="struct__client.html#a16b6787c585ac7c8cb16d851c23872fd">header_table</a>[<a class="code" href="headers_8h.html#ae31554efa3bd3b0ccd99751564fda0a3a17ea790e7531eb89995dcfd435b9bab3">H_DOMAIN</a>]-&gt;<a class="code" href="structheader.html#aff7c052082e6af1ae4c152d27c1a5748">value</a>;</div>
<div class="line">      client-&gt;<a class="code" href="struct__client.html#aa4acb4be416225833618e19738be0d3f">content</a> = <a class="code" href="receiver_8c.html#afd6641ec2bddfdfbf62dbfc8dda1419b">content_from_string</a> (client-&gt;<a class="code" href="struct__client.html#a16b6787c585ac7c8cb16d851c23872fd">header_table</a>[<a class="code" href="headers_8h.html#ae31554efa3bd3b0ccd99751564fda0a3ac5d2d4a99591d9d4ce685eacc863c343">H_CONTENT</a>]-&gt;<a class="code" href="structheader.html#aff7c052082e6af1ae4c152d27c1a5748">value</a>);</div>
<div class="line">      <span class="keywordflow">if</span> (client-&gt;<a class="code" href="struct__client.html#aa4acb4be416225833618e19738be0d3f">content</a> == <a class="code" href="proxy__client_8h.html#a3ccd048df649c335df5a7f82673bbc79aa7cf82bf4e8a011a0cafa44718c1673d">CONTENT_NONE</a>)</div>
<div class="line">        client-&gt;<a class="code" href="struct__client.html#a42c195e1d36d935f56c87888e35cd3df">state</a> = <a class="code" href="proxy__client_8h.html#a8d4a6786d6193f0e6245c44e4a7bb4a0ae5948dea6f5f07cf3b03e786128dda68">C_PROTOCOL_ERROR</a>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (client-&gt;<a class="code" href="struct__client.html#a42c195e1d36d935f56c87888e35cd3df">state</a> != <a class="code" href="proxy__client_8h.html#a8d4a6786d6193f0e6245c44e4a7bb4a0ae5948dea6f5f07cf3b03e786128dda68">C_PROTOCOL_ERROR</a>) {</div>
<div class="line">      <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;%s\n&quot;</span>, client-&gt;<a class="code" href="struct__client.html#a6e6713aaa2f447cb41a3639f0b524050">domain</a>);</div>
<div class="line">      <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;%d\n&quot;</span>, client-&gt;<a class="code" href="struct__client.html#aa4acb4be416225833618e19738be0d3f">content</a>);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;Can&#39;t write out domain and content because of protocol error in input\n&quot;</span>);</div>
<div class="line">      <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;Input is: &#39;%s&#39;\n&quot;</span>, buf);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (header = client-&gt;<a class="code" href="struct__client.html#ac26950582d1b1f44bee860273abf20db">headers</a>; header != NULL; header = header-&gt;<a class="code" href="structheader.html#ad027bf8dacedb0375d53238be5d7903d">next</a>) {</div>
<div class="line">      <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;HEADER:  &#39;%s&#39; : &#39;%s&#39;\n&quot;</span>,</div>
<div class="line">                <a class="code" href="headers_8c.html#a17e29bf565071cbe1f93e1188174ac29">tag_to_string</a>(header-&gt;<a class="code" href="structheader.html#a2d27d52dac3b49d72a94e4f0037e1b19">tag</a>),</div>
<div class="line">                header-&gt;<a class="code" href="structheader.html#aff7c052082e6af1ae4c152d27c1a5748">value</a>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">switch</span> (client-&gt;<a class="code" href="struct__client.html#aa4acb4be416225833618e19738be0d3f">content</a>){</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="proxy__client_8h.html#a3ccd048df649c335df5a7f82673bbc79aa3df54a836cfbfa388b466f9f83a1fe3">CONTENT_TEXT</a>:</div>
<div class="line">      client-&gt;<a class="code" href="struct__client.html#ae9259ecdda0bba173efce8b3f14f5ccd">msg_start</a> = <a class="code" href="text_8c.html#a98abf6a004f767f446fac0ebe162a44c">text_read_msg_start</a>;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="proxy__client_8h.html#a3ccd048df649c335df5a7f82673bbc79a22a144acaabc59ff6471e83e5f1bb9b7">CONTENT_BINARY</a>:</div>
<div class="line">      client-&gt;<a class="code" href="struct__client.html#ae9259ecdda0bba173efce8b3f14f5ccd">msg_start</a> = <a class="code" href="binary_8c.html#a6fb6b57a139396ce83105f316a08e9ec">bin_read_msg_start</a>;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      <span class="comment">/* Default is set when client is created (client_new()) */</span></div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a> (<span class="stringliteral">&quot;Client content is not TEXT or BINARY\n&quot;</span>);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="mbuf_8c.html#a29740cb378aba1d1a0a2a654e6ed0052">mbuf_consume_message</a> (mbuf); <span class="comment">// Next message starts after the headers.</span></div>
<div class="line">    client-&gt;<a class="code" href="struct__client.html#a42c195e1d36d935f56c87888e35cd3df">state</a> = <a class="code" href="proxy__client_8h.html#a8d4a6786d6193f0e6245c44e4a7bb4a0a9b94a6631354c99d8c5c752b1022304e">C_DATA</a>;</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="proxy__client_8h.html#a8d4a6786d6193f0e6245c44e4a7bb4a0a9b94a6631354c99d8c5c752b1022304e">C_DATA</a>:</div>
<div class="line">    result = client-&gt;<a class="code" href="struct__client.html#ae9259ecdda0bba173efce8b3f14f5ccd">msg_start</a> (&amp;msg, mbuf);</div>
<div class="line">    <span class="keywordflow">if</span> (result == -1) {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a> (<span class="stringliteral">&quot;&#39;%s&#39;: protocol error in received message\n&quot;</span>, client_id);</div>
<div class="line">      client-&gt;<a class="code" href="struct__client.html#a42c195e1d36d935f56c87888e35cd3df">state</a> = <a class="code" href="proxy__client_8h.html#a8d4a6786d6193f0e6245c44e4a7bb4a0ae5948dea6f5f07cf3b03e786128dda68">C_PROTOCOL_ERROR</a>;</div>
<div class="line">      <span class="keywordflow">goto</span> <a class="code" href="generator_8c.html#ad667f040f2932c8097435492fbd10d76">loop</a>;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (result == 0) {</div>
<div class="line">      <span class="comment">// Try again when we get more data.</span></div>
<div class="line">      <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;&#39;%s&#39;: need more data\n&quot;</span>, client_id);</div>
<div class="line">      <a class="code" href="mbuf_8c.html#abf9a6c655d77bfc4f8d0299ce65a08c1">mbuf_reset_read</a> (mbuf);</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;&#39;%s&#39;: received message of length %d\n&quot;</span>, client_id, result);</div>
<div class="line">      message_length = result;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;Received [strm=%d seqno=%d ts=%f %d bytes]\n&quot;</span>,</div>
<div class="line">              msg.stream, msg.seqno, msg.timestamp, msg.length);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="mbuf_8c.html#abf9a6c655d77bfc4f8d0299ce65a08c1">mbuf_reset_read</a> (mbuf);</div>
<div class="line">    <a class="code" href="receiver_8c.html#a0c0ec1308829b0517ca035104db0966a">store_received_message</a> (client, &amp;msg, (<span class="keywordtype">char</span>*)<a class="code" href="mbuf_8c.html#ad1e104ade5f0bd7a063e5673349f64b6">mbuf_rdptr</a> (mbuf), message_length);</div>
<div class="line">    <a class="code" href="mbuf_8c.html#a906aa8bcabc6a81ad4a699bb021b959c">mbuf_read_skip</a> (mbuf, message_length);</div>
<div class="line">    <a class="code" href="mbuf_8c.html#a29740cb378aba1d1a0a2a654e6ed0052">mbuf_consume_message</a> (mbuf);</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="proxy__client_8h.html#a8d4a6786d6193f0e6245c44e4a7bb4a0ae5948dea6f5f07cf3b03e786128dda68">C_PROTOCOL_ERROR</a>:</div>
<div class="line">    <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;&#39;%s&#39;: protocol error!\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  <span class="keywordflow">default</span>:</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a> (<span class="stringliteral">&quot;&#39;%s&#39;: unknown client state &#39;%d&#39;\n&quot;</span>, client_id, client-&gt;<a class="code" href="struct__client.html#a42c195e1d36d935f56c87888e35cd3df">state</a>);</div>
<div class="line">    <a class="code" href="mbuf_8c.html#a395990abdadb69351e6f6aa284e8643a">mbuf_clear</a> (mbuf);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a6bb68560564aadd06dfa334b3adb7092"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void setup_logging </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>logfile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>level</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Set up the logging system.</p>
<p>This function sets up the server logging system to log to file logfile, with the given log verbosity level. All messages with severity less than or equal to level will be logged; all others will be discarded (lower levels are more important).</p>
<p>If logfile is not NULL then the named file is opened for logging. If logfile is NULL and the application's stderr stream is not attached to a tty, then the file DEF_LOG_FILE is opened for logging; otherwise, if logfile is NULL and stderr is attached to a tty then log messages will sent to stderr.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">logfile</td><td>the file to open </td></tr>
    <tr><td class="paramname">level</td><td>the severity level at which to log </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00292">292</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

<p>References <a class="el" href="oml2-proxy-server_8c_source.html#l00037">DEFAULT_LOG_FILE</a>, <a class="el" href="log_8c_source.html#l00057">o_set_log_file()</a>, <a class="el" href="log_8c_source.html#l00083">o_set_log_level()</a>, and <a class="el" href="log_8c_source.html#l00118">o_set_simplified_logging()</a>.</p>

<p>Referenced by <a class="el" href="oml2-proxy-server_8c_source.html#l00307">main()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (!logfile) {</div>
<div class="line">    <span class="keywordflow">if</span> (isatty (fileno (stderr)))</div>
<div class="line">      logfile = <span class="stringliteral">&quot;-&quot;</span>;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      logfile = <a class="code" href="oml2-proxy-server_8c.html#a2ecbb6b97620287d0a619efd366a2b46">DEFAULT_LOG_FILE</a>;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <a class="code" href="log_8c.html#a7bf16653217eb39ef83311178236705b">o_set_log_file</a>(logfile);</div>
<div class="line">  <a class="code" href="log_8c.html#add76efe2ed8cc1b5444092218e2ee6c6">o_set_log_level</a>(level);</div>
<div class="line">  <a class="code" href="log_8c.html#ab6ddd363af41806bf264a1b418839c25">o_set_simplified_logging</a> ();</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="aceab8c76067d9fb567c8f5a94d79d2ab"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void sigpipe_handler </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>signum</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00269">269</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

<p>References <a class="el" href="oml2-proxy-server_8c_source.html#l00051">sigpipe_flag</a>.</p>

<p>Referenced by <a class="el" href="oml2-proxy-server_8c_source.html#l00307">main()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (signum == SIGPIPE)</div>
<div class="line">    <a class="code" href="oml2-proxy-server_8c.html#aabe906df2e9b738fc184732415dc7f48">sigpipe_flag</a> = 1;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ab407b62e3136824fb73bbbb5839cea56"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void status_callback </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="o__eventloop_8h.html#ac2b8421423a2691d90489400dc948fb3">SockEvtSource</a> *&#160;</td>
          <td class="paramname"><em>source</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="o__eventloop_8h.html#a579723a800874d33587042781a60af86">SocketStatus</a>&#160;</td>
          <td class="paramname"><em>status</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>errcode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>handle</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Callback function when the status of the socket change </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">source</td><td>the socket event </td></tr>
    <tr><td class="paramname">status</td><td>the status of the socket </td></tr>
    <tr><td class="paramname">error</td><td>the value of the error if there is </td></tr>
    <tr><td class="paramname">handle</td><td>the Client handler structure</td></tr>
  </table>
  </dd>
</dl>
<p>Callback function called when the status of the socket change </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">source</td><td>the socket event </td></tr>
    <tr><td class="paramname">status</td><td>the status of the socket </td></tr>
    <tr><td class="paramname">errno</td><td>the value of the error if there is </td></tr>
    <tr><td class="paramname">handle</td><td>the Client handler structure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00114">114</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

<p>References <a class="el" href="proxy__client_8h_source.html#l00049">C_DISCONNECTED</a>, <a class="el" href="eventloop_8c_source.html#l00714">eventloop_socket_remove()</a>, <a class="el" href="log_8c_source.html#l00333">logdebug()</a>, <a class="el" href="o__eventloop_8h_source.html#l00058">_sockEvtSource::name</a>, <a class="el" href="o__eventloop_8h_source.html#l00061">_sockEvtSource::socket</a>, <a class="el" href="socket_8c_source.html#l00507">socket_close()</a>, and <a class="el" href="o__eventloop_8h_source.html#l00081">SOCKET_CONN_CLOSED</a>.</p>

<p>Referenced by <a class="el" href="client__handler_8c_source.html#l00206">client_handler_new()</a>, and <a class="el" href="oml2-proxy-server_8c_source.html#l00143">on_connect()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  (void)error;</div>
<div class="line">  <span class="keywordflow">switch</span> (status) {</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="o__eventloop_8h.html#ad4b72d4e70e1ef536d14bf0543890a29adc51a996c8067046c7bb75ff6591dc74">SOCKET_CONN_CLOSED</a>: {</div>
<div class="line">      <a class="code" href="struct__client.html">Client</a>* <span class="keyword">self</span> = (<a class="code" href="struct__client.html">Client</a>*)handle;</div>
<div class="line">      <span class="keywordflow">if</span> (self-&gt;recv_event != NULL) {</div>
<div class="line">        <a class="code" href="o__socket_8h.html#ab8e18bfbef40930e4e38a2e5b69801a2">socket_close</a> (source-&gt;<a class="code" href="struct__sockEvtSource.html#a7c0662e2a98e17ff6f163335d2bb0b87">socket</a>);</div>
<div class="line">        <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a>(<span class="stringliteral">&quot;socket &#39;%s&#39; closed\n&quot;</span>, source-&gt;<a class="code" href="struct__sockEvtSource.html#ae736ed058fdf889d84740d8d8be9fffa">name</a>);</div>
<div class="line">        <a class="code" href="eventloop_8c.html#a5a3644a8f05609def4e6c259ebc4d68b">eventloop_socket_remove</a> (source); <span class="comment">// Note:  this free()&#39;s source!</span></div>
<div class="line">      }</div>
<div class="line"></div>
<div class="line">      <span class="comment">/* Signal the sender thread for this client that the client disconnected */</span></div>
<div class="line">      pthread_mutex_lock (&amp;self-&gt;mutex);</div>
<div class="line">      <span class="keyword">self</span>-&gt;state = <a class="code" href="proxy__client_8h.html#a8d4a6786d6193f0e6245c44e4a7bb4a0a0f3ff8121e7e63d8e0b3bd1263f89b9c">C_DISCONNECTED</a>;</div>
<div class="line">      pthread_cond_signal (&amp;self-&gt;condvar);</div>
<div class="line">      pthread_mutex_unlock (&amp;self-&gt;mutex);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="af32816f7efaf256ba76c084cb7af378f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void stdin_handler </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="o__eventloop_8h.html#ac2b8421423a2691d90489400dc948fb3">SockEvtSource</a> *&#160;</td>
          <td class="paramname"><em>source</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>buf_size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00218">218</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

<p>References <a class="el" href="session_8h_source.html#l00038">_session::clients</a>, <a class="el" href="proxy__client_8h_source.html#l00097">_client::condvar</a>, <a class="el" href="log_8c_source.html#l00333">logdebug()</a>, <a class="el" href="proxy__client_8h_source.html#l00096">_client::mutex</a>, <a class="el" href="proxy__client_8h_source.html#l00099">_client::next</a>, <a class="el" href="session_8h_source.html#l00029">ProxyState_PAUSED</a>, <a class="el" href="session_8h_source.html#l00030">ProxyState_SENDING</a>, <a class="el" href="session_8h_source.html#l00031">ProxyState_STOPPED</a>, and <a class="el" href="session_8h_source.html#l00035">_session::state</a>.</p>

<p>Referenced by <a class="el" href="oml2-proxy-server_8c_source.html#l00307">main()</a>, and <a class="el" href="oml2-proxy-server_8c_source.html#l00261">on_control_connect()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="struct__session.html">Session</a> *proxy = (<a class="code" href="struct__session.html">Session</a>*)handle;</div>
<div class="line">  <span class="keywordtype">char</span> command[80];</div>
<div class="line">  (void)source;</div>
<div class="line">  strncpy (command, buf, 80);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (buf_size &lt; 80 &amp;&amp; command[buf_size-1] == <span class="charliteral">&#39;\n&#39;</span>)</div>
<div class="line">    command[buf_size-1] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"></div>
<div class="line">  printf (<span class="stringliteral">&quot;Received command: %s\n&quot;</span>, command);</div>
<div class="line">  <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;Received command: %s\n&quot;</span>, command);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> ((strcmp (command, <span class="stringliteral">&quot;OMLPROXY-RESUME&quot;</span>) == 0) ||</div>
<div class="line">      (strcmp (command, <span class="stringliteral">&quot;RESUME&quot;</span>) == 0)) {</div>
<div class="line">    proxy-&gt;<a class="code" href="struct__session.html#a2085db2e358b0ad60c1412f0efd25473">state</a> = <a class="code" href="session_8h.html#a25e9a86878af66f124d069ff1ea8da5ea7d1818a2209457b192befad3bc551957">ProxyState_SENDING</a>;</div>
<div class="line">  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp (command, <span class="stringliteral">&quot;OMLPROXY-STOP&quot;</span>) == 0 ||</div>
<div class="line">             strcmp (command, <span class="stringliteral">&quot;STOP&quot;</span>) == 0) {</div>
<div class="line">    proxy-&gt;<a class="code" href="struct__session.html#a2085db2e358b0ad60c1412f0efd25473">state</a> = <a class="code" href="session_8h.html#a25e9a86878af66f124d069ff1ea8da5ea197b1be9e43be12c8036d34666384b0c">ProxyState_STOPPED</a>;</div>
<div class="line">  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp (command, <span class="stringliteral">&quot;OMLPROXY-PAUSE&quot;</span>) == 0 ||</div>
<div class="line">             strcmp (command, <span class="stringliteral">&quot;PAUSE&quot;</span>) == 0) {</div>
<div class="line">    proxy-&gt;<a class="code" href="struct__session.html#a2085db2e358b0ad60c1412f0efd25473">state</a> = <a class="code" href="session_8h.html#a25e9a86878af66f124d069ff1ea8da5eaa38f3858b2e01da9917f5659d3d950ea">ProxyState_PAUSED</a>;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">   * If we&#39;re in sending state, wake up the client sender threads</span></div>
<div class="line"><span class="comment">   * so that they will start sending to the downstream server.  We do</span></div>
<div class="line"><span class="comment">   * this even if the state was already ProxyState_SENDING because</span></div>
<div class="line"><span class="comment">   * some of the clients might have dropped back to idle due to</span></div>
<div class="line"><span class="comment">   * disconnection from the upstream server.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="oml2-proxy-server_8c.html#a6b32f07deadd1d267d1b669bc819f4fe">session</a>-&gt;<a class="code" href="struct__session.html#a2085db2e358b0ad60c1412f0efd25473">state</a> == <a class="code" href="session_8h.html#a25e9a86878af66f124d069ff1ea8da5ea7d1818a2209457b192befad3bc551957">ProxyState_SENDING</a>) {</div>
<div class="line">    <a class="code" href="struct__client.html">Client</a> *current = <a class="code" href="oml2-proxy-server_8c.html#a6b32f07deadd1d267d1b669bc819f4fe">session</a>-&gt;<a class="code" href="struct__session.html#a0d067539fc86b2bb5ea51c81bb767481">clients</a>;</div>
<div class="line">    <span class="keywordflow">while</span> (current) {</div>
<div class="line">      pthread_mutex_lock (&amp;current-&gt;<a class="code" href="struct__client.html#aaf0a1fc03a0da21247122a080bf53da6">mutex</a>);</div>
<div class="line">      pthread_cond_signal (&amp;current-&gt;<a class="code" href="struct__client.html#aea55ded0a1ad83fcaf33eeb50e2e54b7">condvar</a>);</div>
<div class="line">      pthread_mutex_unlock (&amp;current-&gt;<a class="code" href="struct__client.html#aaf0a1fc03a0da21247122a080bf53da6">mutex</a>);</div>
<div class="line">      current = current-&gt;<a class="code" href="struct__client.html#a3de5d1e6525d18b373906c2259b86ebd">next</a>;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<h2>Variable Documentation</h2>
<a class="anchor" id="a2e48d05a30e5baae3312f63532cd9c21"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct poptOption options[]</td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Initial value:</b><div class="fragment"><div class="line"> {</div>
<div class="line">  POPT_AUTOHELP</div>
<div class="line">  { <span class="stringliteral">&quot;listen&quot;</span>,      <span class="charliteral">&#39;l&#39;</span>,  POPT_ARG_STRING, &amp;listen_service,  0,   <span class="stringliteral">&quot;Service to listen for TCP based clients&quot;</span>, <a class="code" href="oml2-proxy-server_8c.html#aaf17225f3a62e70bfb8b8194b376cfed">DEF_PORT_STR</a>},</div>
<div class="line">  { <span class="stringliteral">&quot;control&quot;</span>,     <span class="charliteral">&#39;c&#39;</span>,  POPT_ARG_STRING, &amp;control_service, 0,   <span class="stringliteral">&quot;Service to listen for commands&quot;</span>,       <a class="code" href="oml2-proxy-server_8c.html#aad0859aa9be15d99cd46a9ecfa9b3243">DEF_CTRL_PORT_STR</a>},</div>
<div class="line">  { <span class="stringliteral">&quot;debug-level&quot;</span>, <span class="charliteral">&#39;d&#39;</span>,  POPT_ARG_INT,    &amp;log_level,       0,   <span class="stringliteral">&quot;Debug level - error:1 .. debug:4&quot;</span>,     NULL},</div>
<div class="line">  { <span class="stringliteral">&quot;logfile&quot;</span>,     <span class="charliteral">&#39;\0&#39;</span>, POPT_ARG_STRING, &amp;logfile_name,    0,   <span class="stringliteral">&quot;File to log to&quot;</span>,                       <a class="code" href="oml2-proxy-server_8c.html#a2ecbb6b97620287d0a619efd366a2b46">DEFAULT_LOG_FILE</a> },</div>
<div class="line">  { <span class="stringliteral">&quot;version&quot;</span>,     <span class="charliteral">&#39;v&#39;</span>,  POPT_ARG_NONE,   NULL,             <span class="charliteral">&#39;v&#39;</span>, <span class="stringliteral">&quot;Print version information and exit&quot;</span>,   NULL},</div>
<div class="line">  { <span class="stringliteral">&quot;resultfile&quot;</span>,  <span class="charliteral">&#39;r&#39;</span>,  POPT_ARG_STRING, &amp;resultfile_name, 0,   <span class="stringliteral">&quot;File name for storing received data&quot;</span>,  <a class="code" href="oml2-proxy-server_8c.html#a2b5eaed088d936799b7a5f31526a5bf4">DEFAULT_RESULT_FILE</a>},</div>
<div class="line">  { <span class="stringliteral">&quot;size&quot;</span>,        <span class="charliteral">&#39;s&#39;</span>,  POPT_ARG_INT,    &amp;page_size,       0,   <span class="stringliteral">&quot;Page size for buffering measurements&quot;</span>, NULL},</div>
<div class="line">  { <span class="stringliteral">&quot;dstport&quot;</span>,     <span class="charliteral">&#39;p&#39;</span>,  POPT_ARG_INT,    &amp;downstream_port, 0,   <span class="stringliteral">&quot;Downstream OML server port&quot;</span>,       NULL},</div>
<div class="line">  { <span class="stringliteral">&quot;dstaddress&quot;</span>,  <span class="charliteral">&#39;a&#39;</span>,  POPT_ARG_STRING, &amp;downstream_address,  0,   <span class="stringliteral">&quot;Downstream OML server address&quot;</span>,    <a class="code" href="oml2-proxy-server_8c.html#a8d438dcdf6b178472503ea6398a019a7">DEFAULT_SERVER_ADDRESS</a> },</div>
<div class="line">  { NULL,          0,    0,               NULL,             0,   NULL,                                   NULL }</div>
<div class="line">}</div>
</div><!-- fragment -->
<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00057">57</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

<p>Referenced by <a class="el" href="blobgen_8c_source.html#l00216">main()</a>.</p>

</div>
</div>
<a class="anchor" id="a6b32f07deadd1d267d1b669bc819f4fe"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="session_8h.html#a906c903b07fa6fbe3a2f78d7ca0ca686">Session</a>* session = NULL</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00053">53</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

<p>Referenced by <a class="el" href="sender_8c_source.html#l00147">client_send_thread()</a>, and <a class="el" href="oml2-proxy-server_8c_source.html#l00143">on_connect()</a>.</p>

</div>
</div>
<a class="anchor" id="aabe906df2e9b738fc184732415dc7f48"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sigpipe_flag = 0</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="oml2-proxy-server_8c_source.html#l00051">51</a> of file <a class="el" href="oml2-proxy-server_8c_source.html">oml2-proxy-server.c</a>.</p>

<p>Referenced by <a class="el" href="sender_8c_source.html#l00147">client_send_thread()</a>, and <a class="el" href="oml2-proxy-server_8c_source.html#l00269">sigpipe_handler()</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_87445264790f4f26b324fd8301943703.html">proxy_server</a></li><li class="navelem"><a class="el" href="oml2-proxy-server_8c.html">oml2-proxy-server.c</a></li>
    <li class="footer">Generated on Thu Jun 25 2015 15:31:55 for oml2 by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.1.2 </li>
  </ul>
</div>
</body>
</html>
