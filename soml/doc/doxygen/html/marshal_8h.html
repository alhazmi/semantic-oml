<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>oml2: marshal.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="oml_logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">oml2
   &#160;<span id="projectnumber">2.12.0pre.79-58cf-dirty</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('marshal_8h.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#enum-members">Enumerations</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">marshal.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;stdint.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="omlc_8h_source.html">oml2/omlc.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="mbuf_8h_source.html">mbuf.h</a>&quot;</code><br/>
</div><div class="textblock"><div class="dynheader">
Include dependency graph for marshal.h:</div>
<div class="dyncontent">
<div class="center"><img src="marshal_8h__incl.png" border="0" usemap="#marshal_8h" alt=""/></div>
<map name="marshal_8h" id="marshal_8h">
<area shape="rect" id="node5" href="omlc_8h.html" title="Public API of the OML client library." alt="" coords="239,83,333,112"/><area shape="rect" id="node22" href="mbuf_8h.html" title="mbuf.h" alt="" coords="35,83,97,112"/><area shape="rect" id="node18" href="o__log_8h.html" title="ocomm/o_log.h" alt="" coords="397,160,506,189"/></map>
</div>
</div><div class="textblock"><div class="dynheader">
This graph shows which files directly or indirectly include this file:</div>
<div class="dyncontent">
<div class="center"><img src="marshal_8h__dep__incl.png" border="0" usemap="#marshal_8hdep" alt=""/></div>
<map name="marshal_8hdep" id="marshal_8hdep">
<area shape="rect" id="node3" href="bin__writer_8c.html" title="An implementation of the OmlWriter interface functions (see oml2/oml_writer.h) that writes messages u..." alt="" coords="5,83,93,112"/><area shape="rect" id="node5" href="binary_8c.html" title="Functions for reading oml_message objects from an MBuffer using the OML binary format (OMSP Binary Ma..." alt="" coords="117,83,184,112"/><area shape="rect" id="node7" href="marshal_8c.html" title="Binary mode OMSP (OML Measurement Stream Protocol (OMSP) OMSP Binary Marshalling) marhsalling and unm..." alt="" coords="208,83,285,112"/><area shape="rect" id="node9" href="marshal2_8c.html" title="marshal2.c" alt="" coords="309,83,395,112"/><area shape="rect" id="node11" href="text_8c.html" title="Text mode OMSP (OML Measurement Stream Protocol (OMSP) OMSP Text Protocol) serialisation of OML tuple..." alt="" coords="419,83,472,112"/><area shape="rect" id="node13" href="client__handler_8c.html" title="The client handler receives callbacks from the eventloop and processes messages in either OML&#39;s text ..." alt="" coords="496,83,608,112"/><area shape="rect" id="node15" href="check__libshared__marshal_8c.html" title="check_libshared_marshal.c" alt="" coords="632,83,811,112"/><area shape="rect" id="node17" href="check__binary__protocol_8c.html" title="check_binary_protocol.c" alt="" coords="835,83,997,112"/></map>
</div>
</div>
<p><a href="marshal_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structOmlBinaryHeader.html">OmlBinaryHeader</a></td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="enum-members"></a>
Enumerations</h2></td></tr>
<tr class="memitem:aae2cbd51c9149df19ecd8e790db4ab0a"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0a">OmlBinMsgType</a> { <a class="el" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0aa98d5a2a2fd99f1cea2d4f90ece79cf49">OMB_DATA_P</a> =  0x1, 
<a class="el" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0aaa3c47b159216a0127bcfea4f07c4a693">OMB_LDATA_P</a> =  0x2
 }</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a66202b0ff17fc0381752edbfe6fef312"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="marshal_8h.html#a66202b0ff17fc0381752edbfe6fef312">marshal_measurements</a> (<a class="el" href="structMBuffer.html">MBuffer</a> *mbuf, int stream, int <a class="el" href="msggen_8rb.html#a44c805e72fc65562203328da24d9014e">seqno</a>, double now)</td></tr>
<tr class="memitem:abf2845a176c08dbf690333177c8d2327"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="marshal_8h.html#abf2845a176c08dbf690333177c8d2327">marshal_init</a> (<a class="el" href="structMBuffer.html">MBuffer</a> *mbuf, <a class="el" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0a">OmlBinMsgType</a> msgtype)</td></tr>
<tr class="memitem:a4fa27e645c70df37087ccb1e7fd8ebb4"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="marshal_8h.html#a4fa27e645c70df37087ccb1e7fd8ebb4">marshal_values</a> (<a class="el" href="structMBuffer.html">MBuffer</a> *mbuffer, <a class="el" href="structOmlValue.html">OmlValue</a> *values, int value_count)</td></tr>
<tr class="memitem:ad6d9ad2684cedac88e911da72a19dc0c"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="marshal_8h.html#ad6d9ad2684cedac88e911da72a19dc0c">marshal_value</a> (<a class="el" href="structMBuffer.html">MBuffer</a> *mbuf, <a class="el" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012">OmlValueT</a> val_type, <a class="el" href="unionOmlValueU.html">OmlValueU</a> *val)</td></tr>
<tr class="memitem:a0c0615d0abcd3673b56b0c7f68076895"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="marshal_8h.html#a0c0615d0abcd3673b56b0c7f68076895">marshal_finalize</a> (<a class="el" href="structMBuffer.html">MBuffer</a> *mbuf)</td></tr>
<tr class="memitem:ac164377073de4c8790952cb884fc9b69"><td class="memItemLeft" align="right" valign="top"><a class="el" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0a">OmlBinMsgType</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="marshal_8h.html#ac164377073de4c8790952cb884fc9b69">marshal_get_msgtype</a> (<a class="el" href="structMBuffer.html">MBuffer</a> *mbuf)</td></tr>
<tr class="memitem:a50099442a78fa10193ffa16aaf06c6ab"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="marshal_8h.html#a50099442a78fa10193ffa16aaf06c6ab">unmarshal_init</a> (<a class="el" href="structMBuffer.html">MBuffer</a> *mbuf, <a class="el" href="structOmlBinaryHeader.html">OmlBinaryHeader</a> *<a class="el" href="structheader.html">header</a>)</td></tr>
<tr class="memitem:a7ad49adff0224add7e13e06a558eb4bd"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="marshal_8h.html#a7ad49adff0224add7e13e06a558eb4bd">unmarshal_measurements</a> (<a class="el" href="structMBuffer.html">MBuffer</a> *mbuf, <a class="el" href="structOmlBinaryHeader.html">OmlBinaryHeader</a> *<a class="el" href="structheader.html">header</a>, <a class="el" href="structOmlValue.html">OmlValue</a> *values, int max_value_count)</td></tr>
<tr class="memitem:a30649308038b6836ddb4d8945a374216"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="marshal_8h.html#a30649308038b6836ddb4d8945a374216">unmarshal_values</a> (<a class="el" href="structMBuffer.html">MBuffer</a> *mbuffer, <a class="el" href="structOmlBinaryHeader.html">OmlBinaryHeader</a> *<a class="el" href="structheader.html">header</a>, <a class="el" href="structOmlValue.html">OmlValue</a> *values, int max_value_count)</td></tr>
<tr class="memitem:aa8de004239cbf2b4910d003eab5dada0"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="marshal_8h.html#aa8de004239cbf2b4910d003eab5dada0">unmarshal_value</a> (<a class="el" href="structMBuffer.html">MBuffer</a> *mbuffer, <a class="el" href="structOmlValue.html">OmlValue</a> *value)</td></tr>
<tr class="memitem:afe75273760bb0a7a49d0d1f53ac649be"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="marshal_8h.html#afe75273760bb0a7a49d0d1f53ac649be">unmarshal_typed_value</a> (<a class="el" href="structMBuffer.html">MBuffer</a> *mbuf, const char *<a class="el" href="check__text__protocol_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <a class="el" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012">OmlValueT</a> <a class="el" href="check__libshared__headers_8c.html#a23506fc4821ab6d9671f3e6222591a96">type</a>, <a class="el" href="structOmlValue.html">OmlValue</a> *value)</td></tr>
<tr class="memitem:a68a99209ee18fb90be53465acab89b1a"><td class="memItemLeft" align="right" valign="top">uint8_t *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="marshal_8h.html#a68a99209ee18fb90be53465acab89b1a">find_sync</a> (const uint8_t *buf, int len)</td></tr>
</table>
<h2>Enumeration Type Documentation</h2>
<a class="anchor" id="aae2cbd51c9149df19ecd8e790db4ab0a"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0a">OmlBinMsgType</a></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Represent whether a marshalled packet is short or long </p>
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="aae2cbd51c9149df19ecd8e790db4ab0aa98d5a2a2fd99f1cea2d4f90ece79cf49"></a>OMB_DATA_P</em>&nbsp;</td><td>
<p>Short packet of size <a class="el" href="check__libshared__marshal_8c.html#a69bfb6e73bae0625ac56f441ccf542d1">PACKET_HEADER_SIZE</a> bytes </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aae2cbd51c9149df19ecd8e790db4ab0aaa3c47b159216a0127bcfea4f07c4a693"></a>OMB_LDATA_P</em>&nbsp;</td><td>
<p>Long packet of size <a class="el" href="check__libshared__marshal_8c.html#a69bfb6e73bae0625ac56f441ccf542d1">PACKET_HEADER_SIZE</a> + <a class="el" href="marshal2_8c.html#a3b585e315e695d71caa6d9a3d8bb7355">STREAM_HEADER_SIZE</a> bytes </p>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="marshal_8h_source.html#l00032">32</a> of file <a class="el" href="marshal_8h_source.html">marshal.h</a>.</p>
<div class="fragment"><div class="line">             {</div>
<div class="line">  <a class="code" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0aa98d5a2a2fd99f1cea2d4f90ece79cf49">OMB_DATA_P</a> = 0x1,</div>
<div class="line">  <a class="code" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0aaa3c47b159216a0127bcfea4f07c4a693">OMB_LDATA_P</a> = 0x2,</div>
<div class="line">} <a class="code" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0a">OmlBinMsgType</a>;</div>
</div><!-- fragment -->
</div>
</div>
<h2>Function Documentation</h2>
<a class="anchor" id="a68a99209ee18fb90be53465acab89b1a"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t* find_sync </td>
          <td>(</td>
          <td class="paramtype">const uint8_t *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>len</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Find two synchronisation bytes (SYNC_BYTE) back to back.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">buf</td><td>buffer to search for SYNC_BYTEs </td></tr>
    <tr><td class="paramname">len</td><td>length of buf </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>a pointer to the first of two subsequent SYNC_BYTEs, or NULL if not found </dd></dl>

<p>Definition at line <a class="el" href="marshal_8c_source.html#l00375">375</a> of file <a class="el" href="marshal_8c_source.html">marshal.c</a>.</p>

<p>References <a class="el" href="marshal_8c_source.html#l00220">SYNC_BYTE</a>.</p>

<p>Referenced by <a class="el" href="binary_8c_source.html#l00048">bin_find_sync()</a>, and <a class="el" href="check__binary__protocol_8c_source.html#l00059">START_TEST()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* We cannot use find_matching from oml_util here as buf is not a</span></div>
<div class="line"><span class="comment">   * nil-terminated string, and some bytes within might be nil */</span></div>
<div class="line">  <span class="keywordflow">for</span> (i = 1; i &lt; len; i++)</div>
<div class="line">      <span class="keywordflow">if</span> (buf[i] == <a class="code" href="marshal_8c.html#adb06558fc1b7d94db791ac81ac7749d1">SYNC_BYTE</a> &amp;&amp; buf[i-1] == <a class="code" href="marshal_8c.html#adb06558fc1b7d94db791ac81ac7749d1">SYNC_BYTE</a>)</div>
<div class="line">        <span class="keywordflow">return</span> (uint8_t*)&amp;buf[i-1];</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a0c0615d0abcd3673b56b0c7f68076895"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int marshal_finalize </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structMBuffer.html">MBuffer</a> *&#160;</td>
          <td class="paramname"><em>mbuf</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Finalise a marshalled message.</p>
<p>Depending on the number of values packed, change the type of message, and write the actual size in the right location of the header, in network byte order.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mbuf</td><td><a class="el" href="structMBuffer.html">MBuffer</a> where marshalled data is </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>1 </dd></dl>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="marshal2_8c.html#abf2845a176c08dbf690333177c8d2327">marshal_init</a>, <a class="el" href="marshal2_8c.html#a66202b0ff17fc0381752edbfe6fef312">marshal_measurements</a>, <a class="el" href="marshal2_8c.html#a8ed4743985ce5ef8d39b45a8155e2555">marshal_values</a> </dd></dl>

<p>Definition at line <a class="el" href="marshal_8c_source.html#l00897">897</a> of file <a class="el" href="marshal_8c_source.html">marshal.c</a>.</p>

<p>References <a class="el" href="log_8c_source.html#l00309">logwarn()</a>, <a class="el" href="marshal_8c_source.html#l00420">marshal_get_msgtype()</a>, <a class="el" href="mbuf_8c_source.html#l00262">mbuf_message()</a>, <a class="el" href="mbuf_8c_source.html#l00236">mbuf_message_length()</a>, <a class="el" href="mbuf_8c_source.html#l00381">mbuf_write()</a>, <a class="el" href="marshal_8h_source.html#l00034">OMB_DATA_P</a>, <a class="el" href="marshal_8h_source.html#l00036">OMB_LDATA_P</a>, <a class="el" href="marshal_8c_source.html#l00223">PACKET_HEADER_SIZE</a>, and <a class="el" href="oml__value_8c_source.html#l00042">type</a>.</p>

<p>Referenced by <a class="el" href="check__binary__protocol_8c_source.html#l00093">START_TEST()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  uint8_t* buf = <a class="code" href="mbuf_8c.html#a64f532f1d7946c6969320cc4313bc687">mbuf_message</a> (mbuf);</div>
<div class="line">  <a class="code" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0a">OmlBinMsgType</a> <a class="code" href="oml__value_8c.html#ae1087eeb503fb7b11a810d93605c97df">type</a> = <a class="code" href="marshal_8c.html#ac164377073de4c8790952cb884fc9b69">marshal_get_msgtype</a> (mbuf);</div>
<div class="line">  <span class="keywordtype">size_t</span> len = <a class="code" href="mbuf_8c.html#a1afcdf8eb3312a3006b1ed5cc8e8843e">mbuf_message_length</a> (mbuf);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (len &gt; UINT32_MAX) {</div>
<div class="line">    <a class="code" href="log_8c.html#ac65b3f90d3228474368b2b48a488cd44">logwarn</a>(<span class="stringliteral">&quot;Message length %d longer than maximum packet length (%d); &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;packet will be truncated\n&quot;</span>,</div>
<div class="line">            len, UINT32_MAX);</div>
<div class="line">    len = UINT32_MAX;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (type == <a class="code" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0aa98d5a2a2fd99f1cea2d4f90ece79cf49">OMB_DATA_P</a> &amp;&amp; len &gt; UINT16_MAX) {</div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * We assumed a short packet, but there is too much data, so we</span></div>
<div class="line"><span class="comment">     * have to shift the whole buffer down by 2 bytes and convert to a</span></div>
<div class="line"><span class="comment">     * long packet.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    uint8_t s[2] = {0};</div>
<div class="line">    <span class="comment">/* Put some padding in the buffer to make sure it has room, and maintains its invariants */</span></div>
<div class="line">    <a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a> (mbuf, s, <span class="keyword">sizeof</span> (s));</div>
<div class="line">    memmove (&amp;buf[<a class="code" href="marshal_8c.html#a69bfb6e73bae0625ac56f441ccf542d1">PACKET_HEADER_SIZE</a>+2], &amp;buf[<a class="code" href="marshal_8c.html#a69bfb6e73bae0625ac56f441ccf542d1">PACKET_HEADER_SIZE</a>],</div>
<div class="line">             len - PACKET_HEADER_SIZE);</div>
<div class="line">    len += 2;</div>
<div class="line">    buf[2] = type = <a class="code" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0aaa3c47b159216a0127bcfea4f07c4a693">OMB_LDATA_P</a>;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">switch</span> (type) {</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0aa98d5a2a2fd99f1cea2d4f90ece79cf49">OMB_DATA_P</a>:</div>
<div class="line">    len -= <a class="code" href="marshal_8c.html#a69bfb6e73bae0625ac56f441ccf542d1">PACKET_HEADER_SIZE</a>; <span class="comment">// Data length minus header</span></div>
<div class="line">    uint16_t nlen16 = htons (len);</div>
<div class="line">    memcpy (&amp;buf[3], &amp;nlen16, <span class="keyword">sizeof</span> (nlen16));</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0aaa3c47b159216a0127bcfea4f07c4a693">OMB_LDATA_P</a>:</div>
<div class="line">    len -= <a class="code" href="marshal_8c.html#a69bfb6e73bae0625ac56f441ccf542d1">PACKET_HEADER_SIZE</a> + 2; <span class="comment">// Data length minus header</span></div>
<div class="line">    uint32_t nlen32 = htonl (len); <span class="comment">// pure data length</span></div>
<div class="line">    memcpy (&amp;buf[3], &amp;nlen32, <span class="keyword">sizeof</span> (nlen32));</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ac164377073de4c8790952cb884fc9b69"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0a">OmlBinMsgType</a> marshal_get_msgtype </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structMBuffer.html">MBuffer</a> *&#160;</td>
          <td class="paramname"><em>mbuf</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Retrieve the message type from an <a class="el" href="structMBuffer.html">MBuffer</a> containing a marshalling packet.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mbuf</td><td><a class="el" href="structMBuffer.html">MBuffer</a> to read the mbuf marshalling header frow </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the OmlBinMsgType of the packet </dd></dl>

<p>Definition at line <a class="el" href="marshal_8c_source.html#l00420">420</a> of file <a class="el" href="marshal_8c_source.html">marshal.c</a>.</p>

<p>References <a class="el" href="mbuf_8c_source.html#l00262">mbuf_message()</a>.</p>

<p>Referenced by <a class="el" href="marshal_8c_source.html#l00897">marshal_finalize()</a>, and <a class="el" href="marshal_8c_source.html#l00545">marshal_values()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> (<a class="code" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0a">OmlBinMsgType</a>)(<a class="code" href="mbuf_8c.html#a64f532f1d7946c6969320cc4313bc687">mbuf_message</a> (mbuf))[2];</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="abf2845a176c08dbf690333177c8d2327"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int marshal_init </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structMBuffer.html">MBuffer</a> *&#160;</td>
          <td class="paramname"><em>mbuf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0a">OmlBinMsgType</a>&#160;</td>
          <td class="paramname"><em>msgtype</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Initialise the <a class="el" href="structMBuffer.html">MBuffer</a> to serialise a new measurement packet, starting at the current write pointer.</p>
<p>Two basic types (OmlBinMsgType) of packets are available, short and long. Short packets (OMB_DATA_P) can contain up to UINT16_MAX, whislt long packets (OMB_LDATA_P) extend this to UINT32_MAX.</p>
<p>Packets headers start with two SYNC_BYTEs (0xAA), then the packet type (OMB_DATA_P or OMB_LDATA_P).</p>
<ul>
<li>OMB_DATA_P headers are 5 bytes long, the last two bytes containing the size of the message (including headers) as a 16-bit integer.</li>
<li>OMB_LDATA_P headers are 7 bytes long, the last four bytes containing the size of the message (including headers) as a 32-bit integer.</li>
</ul>
<p>Metadata about the stream can then be packed in with <a class="el" href="marshal_8c.html#a66202b0ff17fc0381752edbfe6fef312">marshal_measurements()</a>.</p>
<p>This function can fail if there is a memory allocation failure or if the buffer is misconfigured.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mbuf</td><td><a class="el" href="structMBuffer.html">MBuffer</a> to serialize into </td></tr>
    <tr><td class="paramname">msgtype</td><td>OmlBinMsgType of packet to build </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success, -1 on failure </dd></dl>
<dl class="section see"><dt>See Also</dt><dd>marshal_header_short, marshal_header_long, <a class="el" href="marshal2_8c.html#a66202b0ff17fc0381752edbfe6fef312">marshal_measurements</a> </dd></dl>

<p>Definition at line <a class="el" href="marshal_8c_source.html#l00450">450</a> of file <a class="el" href="marshal_8c_source.html">marshal.c</a>.</p>

<p>References <a class="el" href="log_8c_source.html#l00297">logerror()</a>, <a class="el" href="mbuf_8c_source.html#l00614">mbuf_begin_write()</a>, <a class="el" href="marshal_8h_source.html#l00034">OMB_DATA_P</a>, and <a class="el" href="marshal_8h_source.html#l00036">OMB_LDATA_P</a>.</p>

<p>Referenced by <a class="el" href="check__binary__protocol_8c_source.html#l00093">START_TEST()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> result;</div>
<div class="line">  <span class="keywordflow">if</span> (mbuf == NULL) <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">  result = <a class="code" href="mbuf_8c.html#a0b154f7d6f90e0c1fae4dc360c28f8eb">mbuf_begin_write</a> (mbuf);</div>
<div class="line">  <span class="keywordflow">if</span> (result == -1) {</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Couldn&#39;t start marshalling packet (mbuf_begin_write())\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">switch</span> (msgtype) {</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0aa98d5a2a2fd99f1cea2d4f90ece79cf49">OMB_DATA_P</a>:  result = marshal_header_short (mbuf); <span class="keywordflow">break</span>;</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0aaa3c47b159216a0127bcfea4f07c4a693">OMB_LDATA_P</a>: result = marshal_header_long (mbuf); <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (result == -1) {</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Error when trying to marshal packet header\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a66202b0ff17fc0381752edbfe6fef312"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int marshal_measurements </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structMBuffer.html">MBuffer</a> *&#160;</td>
          <td class="paramname"><em>mbuf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>stream</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>seqno</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>now</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Marshal meta-data for an OML measurement stream's sample</p>
<p>An OML measurement stream is written as two bytes; the first one is the counter for the number of elements in the message, and therefore starts at 0, and the second one is the stream's index. This is followed by a marshalled int32 value containing the sequence number, and a double value containing the timestamp.</p>
<p>A marshalling message should have been prepared in the <a class="el" href="structMBuffer.html">MBuffer</a> first with <a class="el" href="marshal_8c.html#abf2845a176c08dbf690333177c8d2327">marshal_init()</a>. Actual data can then be marshalled into the message with <a class="el" href="marshal_8c.html#a8ed4743985ce5ef8d39b45a8155e2555">marshal_values()</a>.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mbuf</td><td><a class="el" href="structMBuffer.html">MBuffer</a> to write marshalled data to </td></tr>
    <tr><td class="paramname">stream</td><td>Measurement Stream's index </td></tr>
    <tr><td class="paramname">seqno</td><td>message sequence number </td></tr>
    <tr><td class="paramname">now</td><td>message time </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>1 if successful, -1 otherwise </dd></dl>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="marshal2_8c.html#abf2845a176c08dbf690333177c8d2327">marshal_init</a>, <a class="el" href="marshal2_8c.html#a8ed4743985ce5ef8d39b45a8155e2555">marshal_values</a>, <a class="el" href="marshal2_8c.html#a0c0615d0abcd3673b56b0c7f68076895">marshal_finalize</a> </dd></dl>

<p>Definition at line <a class="el" href="marshal_8c_source.html#l00495">495</a> of file <a class="el" href="marshal_8c_source.html">marshal.c</a>.</p>

<p>References <a class="el" href="oml__util_8h_source.html#l00027">LENGTH</a>, <a class="el" href="log_8c_source.html#l00333">logdebug()</a>, <a class="el" href="log_8c_source.html#l00297">logerror()</a>, <a class="el" href="marshal_8c_source.html#l00577">marshal_value()</a>, <a class="el" href="mbuf_8c_source.html#l00675">mbuf_reset_write()</a>, <a class="el" href="mbuf_8c_source.html#l00381">mbuf_write()</a>, <a class="el" href="omlc_8h_source.html#l00036">OML_DOUBLE_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00040">OML_INT32_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00293">omlc_set_double</a>, <a class="el" href="omlc_8h_source.html#l00281">omlc_set_int32</a>, and <a class="el" href="omlc_8h_source.html#l00209">omlc_zero</a>.</p>

<p>Referenced by <a class="el" href="check__binary__protocol_8c_source.html#l00093">START_TEST()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="unionOmlValueU.html">OmlValueU</a> v;</div>
<div class="line">  uint8_t s[2] = { 0, (uint8_t)stream };</div>
<div class="line">  <span class="comment">/* Write num-meas (0, for now), and the stream index */</span></div>
<div class="line">  <span class="keywordtype">int</span> result = <a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a> (mbuf, s, <a class="code" href="oml__util_8h.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a> (s));</div>
<div class="line"></div>
<div class="line">  <a class="code" href="omlc_8h.html#a5cd79ce130e86f27ce8bae31400beffe">omlc_zero</a>(v);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (result == -1) {</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Unable to marshal table number and measurement count (mbuf_write())\n&quot;</span>);</div>
<div class="line">    <a class="code" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a> (mbuf);</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a>(<span class="stringliteral">&quot;Marshalling sample %d for stream %d\n&quot;</span>, <a class="code" href="msggen_8rb.html#a44c805e72fc65562203328da24d9014e">seqno</a>, stream);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="omlc_8h.html#aa8a1827db1559f247bf8a4023e466873">omlc_set_int32</a>(v, <a class="code" href="msggen_8rb.html#a44c805e72fc65562203328da24d9014e">seqno</a>);</div>
<div class="line">  <a class="code" href="marshal_8c.html#ad6d9ad2684cedac88e911da72a19dc0c">marshal_value</a>(mbuf, <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012aab24deeb6fcd36f47779e12dca2c38b9">OML_INT32_VALUE</a>, &amp;v);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="omlc_8h.html#a6a342646d654733d01aff00bf9a308da">omlc_set_double</a>(v, now);</div>
<div class="line">  <a class="code" href="marshal_8c.html#ad6d9ad2684cedac88e911da72a19dc0c">marshal_value</a>(mbuf, <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012adf6df4b257026d03f661cfb85dc7d1c3">OML_DOUBLE_VALUE</a>, &amp;v);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ad6d9ad2684cedac88e911da72a19dc0c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int marshal_value </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structMBuffer.html">MBuffer</a> *&#160;</td>
          <td class="paramname"><em>mbuf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012">OmlValueT</a>&#160;</td>
          <td class="paramname"><em>val_type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="unionOmlValueU.html">OmlValueU</a> *&#160;</td>
          <td class="paramname"><em>val</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Marshal a single <a class="el" href="unionOmlValueU.html">OmlValueU</a> of type OmlValueT into mbuf.</p>
<p>Usually called by <a class="el" href="marshal_8c.html#a8ed4743985ce5ef8d39b45a8155e2555">marshal_values()</a>. On failure, the whole message writing is reset using <a class="el" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write()</a>, and marshalling should restart with <a class="el" href="marshal_8c.html#abf2845a176c08dbf690333177c8d2327">marshal_init()</a>, after the <a class="el" href="structMBuffer.html">MBuffer</a> has been adequately resized or repacked.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mbuf</td><td><a class="el" href="structMBuffer.html">MBuffer</a> to write marshalled data to </td></tr>
    <tr><td class="paramname">val_type</td><td>OmlValueT representing the type of val </td></tr>
    <tr><td class="paramname">val</td><td>pointer to <a class="el" href="unionOmlValueU.html">OmlValueU</a>, of type val_type, to marshall </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>1 on success, or 0 otherwise (marshalling should then restart from <a class="el" href="marshal_8c.html#abf2845a176c08dbf690333177c8d2327">marshal_init()</a>) </dd></dl>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="marshal2_8c.html#a8ed4743985ce5ef8d39b45a8155e2555">marshal_values</a>, <a class="el" href="marshal2_8c.html#abf2845a176c08dbf690333177c8d2327">marshal_init</a>, <a class="el" href="mbuf_8h.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a>, <a class="el" href="mbuf_8h.html#a6197418fb3ef89250ac51be751e7805c">mbuf_repack_message</a>, <a class="el" href="mbuf_8h.html#ae5a8aa8cdfed676885ffda0499810985">mbuf_repack_message2</a>, <a class="el" href="mbuf_8h.html#a2ee5265b405f90d567f5291c636ed185">mbuf_resize</a> </dd></dl>

<p>Definition at line <a class="el" href="marshal_8c_source.html#l00577">577</a> of file <a class="el" href="marshal_8c_source.html">marshal.c</a>.</p>

<p>References <a class="el" href="marshal_8c_source.html#l00184">BIG_L</a>, <a class="el" href="marshal_8c_source.html#l00203">BLOB_T</a>, <a class="el" href="marshal_8c_source.html#l00207">BOOL_FALSE_T</a>, <a class="el" href="marshal_8c_source.html#l00209">BOOL_TRUE_T</a>, <a class="el" href="marshal_8c_source.html#l00217">DATETIME_T</a>, <a class="el" href="marshal_8c_source.html#l00230">DATETIME_T_MAX_SIZE</a>, <a class="el" href="marshal_8c_source.html#l00191">DOUBLE_NAN</a>, <a class="el" href="marshal_8c_source.html#l00189">DOUBLE_T</a>, <a class="el" href="check__text__protocol_8c_source.html#l00139">exp</a>, <a class="el" href="marshal_8c_source.html#l00205">GUID_T</a>, <a class="el" href="marshal_8c_source.html#l00236">GUID_T_SIZE</a>, <a class="el" href="htonll_8h_source.html#l00037">htonll</a>, <a class="el" href="oml__util_8h_source.html#l00027">LENGTH</a>, <a class="el" href="log_8c_source.html#l00333">logdebug()</a>, <a class="el" href="log_8c_source.html#l00357">logdebug3()</a>, <a class="el" href="log_8c_source.html#l00297">logerror()</a>, <a class="el" href="marshal_8c_source.html#l00187">LONG_T</a>, <a class="el" href="marshal_8c_source.html#l00226">LONG_T_SIZE</a>, <a class="el" href="mbuf_8c_source.html#l00675">mbuf_reset_write()</a>, <a class="el" href="mbuf_8c_source.html#l00381">mbuf_write()</a>, <a class="el" href="omlc_8h_source.html#l00044">OML_BLOB_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00046">OML_BOOL_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00048">OML_DATETIME_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00036">OML_DOUBLE_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00045">OML_GUID_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00040">OML_INT32_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00042">OML_INT64_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00037">OML_LONG_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00039">OML_STRING_VALUE</a>, <a class="el" href="oml__value_8c_source.html#l00298">oml_type_to_s()</a>, <a class="el" href="omlc_8h_source.html#l00041">OML_UINT32_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00043">OML_UINT64_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00056">OML_VECTOR_BOOL_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00051">OML_VECTOR_DOUBLE_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00052">OML_VECTOR_INT32_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00054">OML_VECTOR_INT64_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00053">OML_VECTOR_UINT32_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00055">OML_VECTOR_UINT64_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00371">omlc_get_blob_length</a>, <a class="el" href="omlc_8h_source.html#l00368">omlc_get_blob_ptr</a>, <a class="el" href="omlc_8h_source.html#l00273">omlc_get_bool</a>, <a class="el" href="omlc_8h_source.html#l00264">omlc_get_double</a>, <a class="el" href="omlc_8h_source.html#l00270">omlc_get_guid</a>, <a class="el" href="omlc_8h_source.html#l00267">omlc_get_long</a>, <a class="el" href="omlc_8h_source.html#l00340">omlc_get_string_ptr</a>, <a class="el" href="omlc_8h_source.html#l00255">omlc_get_uint32</a>, <a class="el" href="omlc_8h_source.html#l00261">omlc_get_uint64</a>, <a class="el" href="omlc_8h_source.html#l00568">omlc_get_vector_nof_elts</a>, <a class="el" href="omlc_8h_source.html#l00556">omlc_get_vector_ptr</a>, <a class="el" href="check__liboml2__omlvalue_8c_source.html#l00406">str</a>, <a class="el" href="marshal_8c_source.html#l00193">STRING_T</a>, <a class="el" href="marshal_8c_source.html#l00229">STRING_T_MAX_SIZE</a>, <a class="el" href="oml__value_8c_source.html#l00042">type</a>, <a class="el" href="marshal_8c_source.html#l00234">UINT64_T_SIZE</a>, <a class="el" href="marshal_8c_source.html#l00211">VECTOR_T</a>, and <a class="el" href="marshal_8c_source.html#l00237">VECTOR_T_SIZE</a>.</p>

<p>Referenced by <a class="el" href="marshal_8c_source.html#l00495">marshal_measurements()</a>, <a class="el" href="marshal_8c_source.html#l00545">marshal_values()</a>, and <a class="el" href="check__libshared__marshal_8c_source.html#l00350">START_TEST()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="keywordflow">switch</span> (val_type) {</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012a22fda4d714f29db7df49a3574986e67c">OML_LONG_VALUE</a>: {</div>
<div class="line">    <span class="keywordtype">long</span> v = oml_value_clamp_long (<a class="code" href="omlc_8h.html#afea91bd71720ebe6f606841d2347473a">omlc_get_long</a>(*val));</div>
<div class="line">    uint32_t uv = (uint32_t)v;</div>
<div class="line">    uint32_t nv = htonl(uv);</div>
<div class="line">    uint8_t buf[<a class="code" href="marshal_8c.html#a42b9ba4580933f67b8b2757f9dfda087">LONG_T_SIZE</a>+1];</div>
<div class="line"></div>
<div class="line">    buf[0] = <a class="code" href="marshal_8c.html#a95f0d5df544261dab0fd0dcc5063de1f">LONG_T</a>;</div>
<div class="line">    memcpy(&amp;buf[1], &amp;nv, <span class="keyword">sizeof</span> (nv));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Marshalling long %ld\n&quot;</span>, nv);</div>
<div class="line">    <span class="keywordtype">int</span> result = <a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a> (mbuf, buf, <a class="code" href="oml__util_8h.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a> (buf));</div>
<div class="line">    <span class="keywordflow">if</span> (result == -1) {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Failed to marshal OML_LONG_VALUE (mbuf_write())\n&quot;</span>);</div>
<div class="line">      <a class="code" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a> (mbuf);</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012aab24deeb6fcd36f47779e12dca2c38b9">OML_INT32_VALUE</a>:</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012aad8721fa7d76e62c5885222061fa7827">OML_UINT32_VALUE</a>:</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012af4f2a3a1e0887652fb41bab6b6bb96ee">OML_INT64_VALUE</a>:</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012aa0ecc1e475955c44a641c75e841ca2fc">OML_UINT64_VALUE</a>: {</div>
<div class="line">    uint8_t buf[<a class="code" href="marshal_8c.html#a562a5c60d362d082de937e7cc1f4da48">UINT64_T_SIZE</a>+1]; <span class="comment">// Max integer size</span></div>
<div class="line">    uint32_t uv32;</div>
<div class="line">    uint32_t nv32;</div>
<div class="line">    uint64_t uv64;</div>
<div class="line">    uint64_t nv64;</div>
<div class="line">    uint8_t *p_nv;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (oml_size_map[val_type] == 4)</div>
<div class="line">    {</div>
<div class="line">      uv32 = <a class="code" href="omlc_8h.html#a1493babcfc9c69f6aa7efebf049c7a22">omlc_get_uint32</a>(*val);</div>
<div class="line">      nv32 = htonl(uv32);</div>
<div class="line">      p_nv = (uint8_t*)&amp;nv32;</div>
<div class="line">      <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Marshalling %s %&quot;</span> PRIu32 <span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="oml__value_8c.html#a7599e6fb79e38eda3ed88a6ead2d2caf">oml_type_to_s</a>(val_type), uv32);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      uv64 = <a class="code" href="omlc_8h.html#a37958a949ce7353bd25dee96810e2cd6">omlc_get_uint64</a>(*val);</div>
<div class="line">      nv64 = <a class="code" href="htonll_8h.html#a527dbf1e76c80cbbbac47e043cb0747c">htonll</a>(uv64);</div>
<div class="line">      p_nv = (uint8_t*)&amp;nv64;</div>
<div class="line">      <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Marshalling %s %&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="oml__value_8c.html#a7599e6fb79e38eda3ed88a6ead2d2caf">oml_type_to_s</a>(val_type), uv64);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    buf[0] = oml_type_map[val_type];</div>
<div class="line">    memcpy(&amp;buf[1], p_nv, oml_size_map[val_type]);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> result = <a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a> (mbuf, buf, oml_size_map[val_type] + 1);</div>
<div class="line">    <span class="keywordflow">if</span> (result == -1)</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Failed to marshal %s value (mbuf_write())\n&quot;</span>,</div>
<div class="line">               <a class="code" href="oml__value_8c.html#a7599e6fb79e38eda3ed88a6ead2d2caf">oml_type_to_s</a> (val_type));</div>
<div class="line">        <a class="code" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a> (mbuf);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012adf6df4b257026d03f661cfb85dc7d1c3">OML_DOUBLE_VALUE</a>: {</div>
<div class="line">    uint8_t <a class="code" href="oml__value_8c.html#ae1087eeb503fb7b11a810d93605c97df">type</a> = <a class="code" href="marshal_8c.html#a9290324f1f88b0f007de36d523d8cf3a">DOUBLE_T</a>;</div>
<div class="line">    <span class="keywordtype">double</span> v = <a class="code" href="omlc_8h.html#adb34b291e3acb9b9a52c544c34c6568c">omlc_get_double</a>(*val);</div>
<div class="line">    <span class="keywordtype">int</span> <a class="code" href="check__text__protocol_8c.html#afc541abe000a672ebe850f1448b25306">exp</a>;</div>
<div class="line">    <span class="keywordtype">double</span> mant = frexp(v, &amp;exp);</div>
<div class="line">    int8_t nexp = (int8_t)exp;</div>
<div class="line">    <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Marshalling double %f\n&quot;</span>, v);</div>
<div class="line">    <span class="keywordflow">if</span> (isnan(v)) {</div>
<div class="line">      type = <a class="code" href="marshal_8c.html#a05c4e15b9701b28975effde191bc9bf6">DOUBLE_NAN</a>;</div>
<div class="line">      nexp = 0;</div>
<div class="line">      mant = 0;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nexp != exp) {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Double number &#39;%lf&#39; is out of bounds, sending NaN\n&quot;</span>, v);</div>
<div class="line">      type = <a class="code" href="marshal_8c.html#a05c4e15b9701b28975effde191bc9bf6">DOUBLE_NAN</a>;</div>
<div class="line">      nexp = 0;</div>
<div class="line">      mant = 0;</div>
<div class="line">   }</div>
<div class="line">   int32_t imant = (int32_t)(mant * (1 &lt;&lt; <a class="code" href="marshal_8c.html#af6f8ed1dac346fb91d21a4ce56c9d160">BIG_L</a>));</div>
<div class="line">   uint32_t nmant = htonl(imant);</div>
<div class="line"></div>
<div class="line">   uint8_t buf[6] = { <a class="code" href="oml__value_8c.html#ae1087eeb503fb7b11a810d93605c97df">type</a>, 0, 0, 0, 0, nexp };</div>
<div class="line"></div>
<div class="line">   memcpy(&amp;buf[1], &amp;nmant, <span class="keyword">sizeof</span> (nmant));</div>
<div class="line"></div>
<div class="line">   <span class="keywordtype">int</span> result = <a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a> (mbuf, buf, <a class="code" href="oml__util_8h.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a> (buf));</div>
<div class="line"></div>
<div class="line">   <span class="keywordflow">if</span> (result == -1)</div>
<div class="line">     {</div>
<div class="line">       <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Failed to marshal OML_DOUBLE_VALUE (mbuf_write())\n&quot;</span>);</div>
<div class="line">       <a class="code" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a> (mbuf);</div>
<div class="line">       <span class="keywordflow">return</span> 0;</div>
<div class="line">     }</div>
<div class="line">   <span class="keywordflow">break</span>;</div>
<div class="line"> }</div>
<div class="line"> <span class="keywordflow">case</span> <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012a42b33eb7c21f79727a894a530a05b559">OML_STRING_VALUE</a>: {</div>
<div class="line">   <span class="keywordtype">char</span>* <a class="code" href="check__liboml2__omlvalue_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a> = <a class="code" href="omlc_8h.html#ae5077b9404ef5c4c2f66a1a654430512">omlc_get_string_ptr</a>(*val);</div>
<div class="line"></div>
<div class="line">   <span class="keywordflow">if</span> (str == NULL) {</div>
<div class="line">     str = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line">     <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a>(<span class="stringliteral">&quot;Attempting to send a NULL string; sending empty string instead\n&quot;</span>);</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   <span class="keywordtype">size_t</span> len = strlen(str);</div>
<div class="line">   <span class="keywordflow">if</span> (len &gt; <a class="code" href="marshal_8c.html#a819d5a9d27da69526498471b39ae19d9">STRING_T_MAX_SIZE</a>) {</div>
<div class="line">     <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Truncated string &#39;%s&#39;\n&quot;</span>, str);</div>
<div class="line">     len = <a class="code" href="marshal_8c.html#a819d5a9d27da69526498471b39ae19d9">STRING_T_MAX_SIZE</a>;</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Marshalling string &#39;%s&#39; of length %d\n&quot;</span>, str, len);</div>
<div class="line">   uint8_t buf[2] = { <a class="code" href="marshal_8c.html#a64b41f937ac6a39ee0c32adecfa606dd">STRING_T</a>, (uint8_t)(len &amp; 0xff) };</div>
<div class="line">   <span class="keywordtype">int</span> result = <a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a> (mbuf, buf, <a class="code" href="oml__util_8h.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a> (buf));</div>
<div class="line">   <span class="keywordflow">if</span> (result == -1) {</div>
<div class="line">     <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Failed to marshal OML_STRING_VALUE type and length (mbuf_write())\n&quot;</span>);</div>
<div class="line">     <a class="code" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a> (mbuf);</div>
<div class="line">     <span class="keywordflow">return</span> 0;</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   result = <a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a> (mbuf, (uint8_t*)str, len);</div>
<div class="line"></div>
<div class="line">   <span class="keywordflow">if</span> (result == -1)</div>
<div class="line">     {</div>
<div class="line">       <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Failed to marshal OML_STRING_VALUE (mbuf_write())\n&quot;</span>);</div>
<div class="line">       <a class="code" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a> (mbuf);</div>
<div class="line">       <span class="keywordflow">return</span> 0;</div>
<div class="line">     }</div>
<div class="line">   <span class="keywordflow">break</span>;</div>
<div class="line"> }</div>
<div class="line"><span class="keywordflow">case</span> <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012a757bfe5ea9a3b418e9d2ca243c843c59">OML_DATETIME_VALUE</a>: {</div>
<div class="line">   <span class="keywordtype">char</span>* str = <a class="code" href="omlc_8h.html#ae5077b9404ef5c4c2f66a1a654430512">omlc_get_string_ptr</a>(*val);</div>
<div class="line"></div>
<div class="line">   <span class="keywordflow">if</span> (str == NULL) {</div>
<div class="line">     str = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line">     <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a>(<span class="stringliteral">&quot;Attempting to send a NULL string; sending empty string instead\n&quot;</span>);</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   <span class="keywordtype">size_t</span> len = strlen(str);</div>
<div class="line">   <span class="keywordflow">if</span> (len &gt; <a class="code" href="marshal_8c.html#ab5ef0349bcf5b7dc6324720d1e482227">DATETIME_T_MAX_SIZE</a>) {</div>
<div class="line">     <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Truncated string &#39;%s&#39;\n&quot;</span>, str);</div>
<div class="line">     len = <a class="code" href="marshal_8c.html#ab5ef0349bcf5b7dc6324720d1e482227">DATETIME_T_MAX_SIZE</a>;</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Marshalling string &#39;%s&#39; of length %d\n&quot;</span>, str, len);</div>
<div class="line">   uint8_t buf[2] = { <a class="code" href="marshal_8c.html#a9a9ca3cedd4166caa9f599511a8659e3">DATETIME_T</a>, (uint8_t)(len &amp; 0xff) };</div>
<div class="line">   <span class="keywordtype">int</span> result = <a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a> (mbuf, buf, <a class="code" href="oml__util_8h.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a> (buf));</div>
<div class="line">   <span class="keywordflow">if</span> (result == -1) {</div>
<div class="line">     <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Failed to marshal OML_DATETIME_VALUE type and length (mbuf_write())\n&quot;</span>);</div>
<div class="line">     <a class="code" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a> (mbuf);</div>
<div class="line">     <span class="keywordflow">return</span> 0;</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   result = <a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a> (mbuf, (uint8_t*)str, len);</div>
<div class="line"></div>
<div class="line">   <span class="keywordflow">if</span> (result == -1)</div>
<div class="line">     {</div>
<div class="line">       <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Failed to marshal OML_DATETIME_VALUE (mbuf_write())\n&quot;</span>);</div>
<div class="line">       <a class="code" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a> (mbuf);</div>
<div class="line">       <span class="keywordflow">return</span> 0;</div>
<div class="line">     }</div>
<div class="line">   <span class="keywordflow">break</span>;</div>
<div class="line"> }</div>
<div class="line"></div>
<div class="line"> <span class="keywordflow">case</span> <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012aea7273ecb417f61976d2089a31e75037">OML_BLOB_VALUE</a>: {</div>
<div class="line">   <span class="keywordtype">int</span> result = 0;</div>
<div class="line">   <span class="keywordtype">void</span> *blob = <a class="code" href="omlc_8h.html#ab27d41701e48bc5ebd9e41e21e771cf6">omlc_get_blob_ptr</a>(*val);</div>
<div class="line">   <span class="keywordtype">size_t</span> length = <a class="code" href="omlc_8h.html#a8889e12c16c598b5d1f633ab07680010">omlc_get_blob_length</a>(*val);</div>
<div class="line">   <span class="keywordflow">if</span> (blob == NULL || length == 0) {</div>
<div class="line">     <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a> (<span class="stringliteral">&quot;Attempting to send NULL or empty blob; blob of length 0 will be sent\n&quot;</span>);</div>
<div class="line">     length = 0;</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   uint8_t buf[5] = { <a class="code" href="marshal_8c.html#a2be536a5a6e8f0b613f766f04743581d">BLOB_T</a>, 0, 0, 0, 0 };</div>
<div class="line">   <span class="keywordtype">size_t</span> n_length = htonl (length);</div>
<div class="line">   memcpy (&amp;buf[1], &amp;n_length, 4);</div>
<div class="line"></div>
<div class="line">   <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Marshalling blob of size %d\n&quot;</span>, length);</div>
<div class="line">   result = <a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a> (mbuf, buf, <span class="keyword">sizeof</span> (buf));</div>
<div class="line"></div>
<div class="line">   <span class="keywordflow">if</span> (result == -1) {</div>
<div class="line">     <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a> (<span class="stringliteral">&quot;Failed to marshall OML_BLOB_VALUE type and length (mbuf_write())\n&quot;</span>);</div>
<div class="line">     <a class="code" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a> (mbuf);</div>
<div class="line">     <span class="keywordflow">return</span> 0;</div>
<div class="line">   }</div>
<div class="line"></div>
<div class="line">   result = <a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a> (mbuf, blob, length);</div>
<div class="line"></div>
<div class="line">   <span class="keywordflow">if</span> (result == -1) {</div>
<div class="line">     <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a> (<span class="stringliteral">&quot;Failed to marshall %d bytes of OML_BLOB_VALUE data\n&quot;</span>, length);</div>
<div class="line">     <a class="code" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a> (mbuf);</div>
<div class="line">     <span class="keywordflow">return</span> 0;</div>
<div class="line">   }</div>
<div class="line">   <span class="keywordflow">break</span>;</div>
<div class="line"> }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012a8f383c792a4697dbf4db99ef2514853f">OML_GUID_VALUE</a>: {</div>
<div class="line">    <span class="comment">/* FIXME: Wrap with UINT64 marshalling, just change the type */</span></div>
<div class="line">    uint64_t nv64;</div>
<div class="line">    uint8_t buf[<a class="code" href="marshal_8c.html#a02d9571c55f4499fe06a581523398665">GUID_T_SIZE</a>+1];</div>
<div class="line">    buf[0] = <a class="code" href="marshal_8c.html#a06c2c3d86fd6e81c65fa34777944f495">GUID_T</a>;</div>
<div class="line">    nv64 = <a class="code" href="htonll_8h.html#a527dbf1e76c80cbbbac47e043cb0747c">htonll</a>(<a class="code" href="omlc_8h.html#a2ef9e64d176c33c11c98d11fae69a5ea">omlc_get_guid</a>(*val));</div>
<div class="line">    memcpy(&amp;buf[1], &amp;nv64, <span class="keyword">sizeof</span>(nv64));</div>
<div class="line">    <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Marshalling GUID %&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span>, nv64);</div>
<div class="line">    <span class="keywordflow">if</span> (-1 == <a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a>(mbuf, buf, <a class="code" href="oml__util_8h.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a>(buf))) {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Failed to marshal OML_GUID_VALUE (mbuf_write())\n&quot;</span>);</div>
<div class="line">      <a class="code" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a>(mbuf);</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012ac12a596e1ea36e0a6f0c58d2b63c8046">OML_BOOL_VALUE</a>: {</div>
<div class="line">    uint8_t buf;</div>
<div class="line">    <span class="keywordflow">if</span> (!<a class="code" href="omlc_8h.html#ad5e34e372b65dec9ccfc9fc61c3fbc6c">omlc_get_bool</a>(*val)) {</div>
<div class="line">      buf = <a class="code" href="marshal_8c.html#a7e5ce4a4afe3c8c5e6a166a98c73bf49">BOOL_FALSE_T</a>;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      buf = <a class="code" href="marshal_8c.html#aaaece6ec7d7273c485301e9b4a88c27e">BOOL_TRUE_T</a>;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Marshalling boolean %d\n&quot;</span>, <a class="code" href="marshal_8c.html#aaaece6ec7d7273c485301e9b4a88c27e">BOOL_TRUE_T</a> == buf);</div>
<div class="line">    <span class="keywordflow">if</span> (-1 == <a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a>(mbuf, &amp;buf, 1)) {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Failed to marshal OML_BOOL_VALUE (mbuf_write())\n&quot;</span>);</div>
<div class="line">      <a class="code" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a>(mbuf);</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012aed6846ecc2ffcc8aadce26c11162a620">OML_VECTOR_INT32_VALUE</a>:</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012a885a525604de2b2891df51668d7b578f">OML_VECTOR_UINT32_VALUE</a>: {</div>
<div class="line">    <span class="keywordtype">size_t</span> i;</div>
<div class="line">    uint8_t buf[<a class="code" href="marshal_8c.html#ad713d820027e8ce73087565d4efe5772">VECTOR_T_SIZE</a>] = { <a class="code" href="marshal_8c.html#a1f6327298a81a863946fc71c15f75c1d">VECTOR_T</a>, 0, 0, 0 };</div>
<div class="line">    uint16_t hn = <a class="code" href="omlc_8h.html#a00a0a1d69982669384babad1ceff630e">omlc_get_vector_nof_elts</a>(*val);</div>
<div class="line">    uint16_t nn = htons(hn);</div>
<div class="line">    buf[1] = vector_protocol_map[val_type];</div>
<div class="line">    memcpy(&amp;buf[2], &amp;nn, <span class="keyword">sizeof</span>(nn));</div>
<div class="line">    <span class="keywordflow">if</span>(<a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a>(mbuf, buf, <a class="code" href="marshal_8c.html#ad713d820027e8ce73087565d4efe5772">VECTOR_T_SIZE</a>) == 0) {</div>
<div class="line">      uint32_t elts[hn];</div>
<div class="line">      uint32_t *v = <a class="code" href="omlc_8h.html#a3e6ebac117f490c57b65321c4753c0a1">omlc_get_vector_ptr</a>(*val);</div>
<div class="line">      <span class="keywordflow">for</span>(i = 0; i &lt; hn; i++)</div>
<div class="line">        elts[i] = htonl(*((uint32_t*)(v+i)));</div>
<div class="line">      <span class="keywordflow">if</span>(<a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a>(mbuf, (<span class="keyword">const</span> uint8_t*)(elts), <span class="keyword">sizeof</span>(elts)) == -1) {</div>
<div class="line">        <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;%s(): failed to marshal %s of size %&quot;</span> PRIu16 <span class="stringliteral">&quot; (mbuf_write())\n&quot;</span>, __func__, <a class="code" href="oml__value_8c.html#a7599e6fb79e38eda3ed88a6ead2d2caf">oml_type_to_s</a>(val_type), hn);</div>
<div class="line">        <a class="code" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a>(mbuf);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">      }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;%s(): failed to marshal %s length (mbuf_write())\n&quot;</span>, __func__, <a class="code" href="oml__value_8c.html#a7599e6fb79e38eda3ed88a6ead2d2caf">oml_type_to_s</a>(val_type));</div>
<div class="line">      <a class="code" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a>(mbuf);</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012a0b98a39a835deadf7a27de784acd8a93">OML_VECTOR_INT64_VALUE</a>:</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012a505a02b4218554c975af8d42571d2dd7">OML_VECTOR_UINT64_VALUE</a>:</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012acb2346135dde2824348712d936f03353">OML_VECTOR_DOUBLE_VALUE</a>: {</div>
<div class="line">    <span class="keywordtype">size_t</span> i;</div>
<div class="line">    uint8_t buf[<a class="code" href="marshal_8c.html#ad713d820027e8ce73087565d4efe5772">VECTOR_T_SIZE</a>] = { <a class="code" href="marshal_8c.html#a1f6327298a81a863946fc71c15f75c1d">VECTOR_T</a>, 0, 0, 0 };</div>
<div class="line">    uint16_t hn = <a class="code" href="omlc_8h.html#a00a0a1d69982669384babad1ceff630e">omlc_get_vector_nof_elts</a>(*val);</div>
<div class="line">    uint16_t nn = htons(hn);</div>
<div class="line">    buf[1] = vector_protocol_map[val_type];</div>
<div class="line">    memcpy(&amp;buf[2], &amp;nn, <span class="keyword">sizeof</span>(nn));</div>
<div class="line">    <span class="keywordflow">if</span>(<a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a>(mbuf, buf, <a class="code" href="marshal_8c.html#ad713d820027e8ce73087565d4efe5772">VECTOR_T_SIZE</a>) == 0) {</div>
<div class="line">      uint64_t elts[hn];</div>
<div class="line">      uint64_t *v = <a class="code" href="omlc_8h.html#a3e6ebac117f490c57b65321c4753c0a1">omlc_get_vector_ptr</a>(*val);</div>
<div class="line">      <span class="keywordflow">for</span>(i = 0; i &lt; hn; i++)</div>
<div class="line">        elts[i] = <a class="code" href="htonll_8h.html#a527dbf1e76c80cbbbac47e043cb0747c">htonll</a>(*((uint64_t*)(v+i)));</div>
<div class="line">      <span class="keywordflow">if</span>(<a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a>(mbuf, (<span class="keyword">const</span> uint8_t*)(elts), <span class="keyword">sizeof</span>(elts)) == -1) {</div>
<div class="line">        <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;%s(): failed to marshal %s of size %&quot;</span> PRIu16 <span class="stringliteral">&quot; (mbuf_write())\n&quot;</span>, __func__, <a class="code" href="oml__value_8c.html#a7599e6fb79e38eda3ed88a6ead2d2caf">oml_type_to_s</a>(val_type), hn);</div>
<div class="line">        <a class="code" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a>(mbuf);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">      }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;%s(): failed to marshal %s length (mbuf_write())\n&quot;</span>, __func__, <a class="code" href="oml__value_8c.html#a7599e6fb79e38eda3ed88a6ead2d2caf">oml_type_to_s</a>(val_type));</div>
<div class="line">      <a class="code" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a>(mbuf);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012aebca95966d074921730a23e95b5d9dd6">OML_VECTOR_BOOL_VALUE</a>: {</div>
<div class="line">    <span class="keywordtype">size_t</span> i;</div>
<div class="line">    uint8_t buf[<a class="code" href="marshal_8c.html#ad713d820027e8ce73087565d4efe5772">VECTOR_T_SIZE</a>] = { <a class="code" href="marshal_8c.html#a1f6327298a81a863946fc71c15f75c1d">VECTOR_T</a>, 0, 0, 0 };</div>
<div class="line">    uint16_t hn = <a class="code" href="omlc_8h.html#a00a0a1d69982669384babad1ceff630e">omlc_get_vector_nof_elts</a>(*val);</div>
<div class="line">    uint16_t nn = htons(hn);</div>
<div class="line">    buf[1] = vector_protocol_map[val_type];</div>
<div class="line">    memcpy(&amp;buf[2], &amp;nn, <span class="keyword">sizeof</span>(nn));</div>
<div class="line">    <span class="keywordflow">if</span>(<a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a>(mbuf, buf, <a class="code" href="marshal_8c.html#ad713d820027e8ce73087565d4efe5772">VECTOR_T_SIZE</a>) == 0) {</div>
<div class="line">      uint8_t elts[hn];</div>
<div class="line">      <span class="keywordtype">bool</span> *v = <a class="code" href="omlc_8h.html#a3e6ebac117f490c57b65321c4753c0a1">omlc_get_vector_ptr</a>(*val);</div>
<div class="line">      <span class="keywordflow">for</span>(i = 0; i &lt; hn; i++)</div>
<div class="line">        elts[i] = v[i] ? <a class="code" href="marshal_8c.html#aaaece6ec7d7273c485301e9b4a88c27e">BOOL_TRUE_T</a> : <a class="code" href="marshal_8c.html#a7e5ce4a4afe3c8c5e6a166a98c73bf49">BOOL_FALSE_T</a>;</div>
<div class="line">      <span class="keywordflow">if</span>(<a class="code" href="mbuf_8c.html#acb5cd36b259b0df7a3173259835dbba0">mbuf_write</a>(mbuf, (<span class="keyword">const</span> uint8_t*)(elts), hn) == -1) {</div>
<div class="line">        <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;%s(): failed to marshal %s of size %&quot;</span> PRIu16 <span class="stringliteral">&quot; (mbuf_write())\n&quot;</span>, __func__, <a class="code" href="oml__value_8c.html#a7599e6fb79e38eda3ed88a6ead2d2caf">oml_type_to_s</a>(val_type), hn);</div>
<div class="line">        <a class="code" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a>(mbuf);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">      }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;%s(): failed to marshal %s length (mbuf_write())\n&quot;</span>, __func__, <a class="code" href="oml__value_8c.html#a7599e6fb79e38eda3ed88a6ead2d2caf">oml_type_to_s</a>(val_type));</div>
<div class="line">      <a class="code" href="mbuf_8c.html#ac4ddd843a465364728d9b113cc2e63d8">mbuf_reset_write</a>(mbuf);</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">default</span>:</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;%s(): Unsupported value type &#39;%d&#39;\n&quot;</span>, __func__, val_type);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a4fa27e645c70df37087ccb1e7fd8ebb4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int marshal_values </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structMBuffer.html">MBuffer</a> *&#160;</td>
          <td class="paramname"><em>mbuf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structOmlValue.html">OmlValue</a> *&#160;</td>
          <td class="paramname"><em>values</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>value_count</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Marshal the array of values into an <a class="el" href="structMBuffer.html">MBuffer</a>.</p>
<p>Metadata of the measurement stream should already have been written with <a class="el" href="marshal_8c.html#a66202b0ff17fc0381752edbfe6fef312">marshal_measurements()</a>. Each element of values is written with <a class="el" href="marshal_8c.html#ad6d9ad2684cedac88e911da72a19dc0c">marshal_value()</a>. Finally, the number of elements in the message is updated in its header, by incrementing the relevant field (depending on its OmlBinMsgType) by value_count.</p>
<p>If the returned number is negative, marshalling didn't finish as the provided buffer was short of the number of bytes returned (when multiplied by -1); the entire message has been reset (by <a class="el" href="marshal_8c.html#ad6d9ad2684cedac88e911da72a19dc0c">marshal_value()</a>), and marshalling should restart with <a class="el" href="marshal_8c.html#abf2845a176c08dbf690333177c8d2327">marshal_init()</a>, after the <a class="el" href="structMBuffer.html">MBuffer</a> has been adequately resized or repacked.</p>
<p>Once all data has been marshalled, <a class="el" href="marshal_8c.html#a0c0615d0abcd3673b56b0c7f68076895">marshal_finalize()</a> should be called to finish preparing the message.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mbuf</td><td><a class="el" href="structMBuffer.html">MBuffer</a> to write marshalled data to </td></tr>
    <tr><td class="paramname">values</td><td>array of <a class="el" href="structOmlValue.html">OmlValue</a> of length value_count </td></tr>
    <tr><td class="paramname">value_count</td><td>length the values array </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>1 on success, or -1 otherwise (marshalling should then restart from <a class="el" href="marshal_8c.html#abf2845a176c08dbf690333177c8d2327">marshal_init()</a>) </dd></dl>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="marshal2_8c.html#abf2845a176c08dbf690333177c8d2327">marshal_init</a>, <a class="el" href="marshal2_8c.html#a66202b0ff17fc0381752edbfe6fef312">marshal_measurements</a>, <a class="el" href="marshal2_8c.html#ad6d9ad2684cedac88e911da72a19dc0c">marshal_value</a>, <a class="el" href="marshal2_8c.html#a0c0615d0abcd3673b56b0c7f68076895">marshal_finalize</a>, <a class="el" href="mbuf_8h.html#a6197418fb3ef89250ac51be751e7805c">mbuf_repack_message</a>, <a class="el" href="mbuf_8h.html#ae5a8aa8cdfed676885ffda0499810985">mbuf_repack_message2</a>, <a class="el" href="mbuf_8h.html#a2ee5265b405f90d567f5291c636ed185">mbuf_resize</a> </dd></dl>

<p>Definition at line <a class="el" href="marshal_8c_source.html#l00545">545</a> of file <a class="el" href="marshal_8c_source.html">marshal.c</a>.</p>

<p>References <a class="el" href="marshal_8c_source.html#l00420">marshal_get_msgtype()</a>, <a class="el" href="marshal_8c_source.html#l00577">marshal_value()</a>, <a class="el" href="mbuf_8c_source.html#l00262">mbuf_message()</a>, <a class="el" href="marshal_8h_source.html#l00034">OMB_DATA_P</a>, <a class="el" href="marshal_8h_source.html#l00036">OMB_LDATA_P</a>, <a class="el" href="oml__value_8h_source.html#l00060">oml_value_get_type</a>, <a class="el" href="oml__value_8h_source.html#l00051">oml_value_get_value</a>, and <a class="el" href="oml__value_8c_source.html#l00042">type</a>.</p>

<p>Referenced by <a class="el" href="check__binary__protocol_8c_source.html#l00093">START_TEST()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="structOmlValue.html">OmlValue</a>* val = values;</div>
<div class="line">  <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; value_count; i++, val++) {</div>
<div class="line">    <span class="keywordflow">if</span>(!<a class="code" href="marshal_8c.html#ad6d9ad2684cedac88e911da72a19dc0c">marshal_value</a>(mbuf, <a class="code" href="oml__value_8h.html#aa1e9629b4e4c34fe9d24ab381ad4550c">oml_value_get_type</a>(val), <a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(val)))</div>
<div class="line">      <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  uint8_t* buf = <a class="code" href="mbuf_8c.html#a64f532f1d7946c6969320cc4313bc687">mbuf_message</a> (mbuf);</div>
<div class="line">  <a class="code" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0a">OmlBinMsgType</a> <a class="code" href="oml__value_8c.html#ae1087eeb503fb7b11a810d93605c97df">type</a> = <a class="code" href="marshal_8c.html#ac164377073de4c8790952cb884fc9b69">marshal_get_msgtype</a> (mbuf);</div>
<div class="line">  <span class="keywordflow">switch</span> (type) {</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0aa98d5a2a2fd99f1cea2d4f90ece79cf49">OMB_DATA_P</a>: buf[5] += value_count; <span class="keywordflow">break</span>;</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0aaa3c47b159216a0127bcfea4f07c4a693">OMB_LDATA_P</a>: buf[7] += value_count; <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a50099442a78fa10193ffa16aaf06c6ab"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int unmarshal_init </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structMBuffer.html">MBuffer</a> *&#160;</td>
          <td class="paramname"><em>mbuf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structOmlBinaryHeader.html">OmlBinaryHeader</a> *&#160;</td>
          <td class="paramname"><em>header</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Read the marshalling header information contained in an <a class="el" href="structMBuffer.html">MBuffer</a>.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mbuf</td><td><a class="el" href="structMBuffer.html">MBuffer</a> to read from </td></tr>
    <tr><td class="paramname">header</td><td>pointer to an <a class="el" href="structOmlBinaryHeader.html">OmlBinaryHeader</a> into which the data from the mbuf should be unmarshalled </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>1 on success, the size of the missing section as a negative number if the buffer is too short, or 0 if something failed </dd></dl>

<p>Definition at line <a class="el" href="marshal_8c_source.html#l00951">951</a> of file <a class="el" href="marshal_8c_source.html">marshal.c</a>.</p>

<p>References <a class="el" href="oml__util_8h_source.html#l00027">LENGTH</a>, <a class="el" href="marshal_8h_source.html#l00042">OmlBinaryHeader::length</a>, <a class="el" href="log_8c_source.html#l00333">logdebug()</a>, <a class="el" href="log_8c_source.html#l00297">logerror()</a>, <a class="el" href="log_8c_source.html#l00309">logwarn()</a>, <a class="el" href="mbuf_8c_source.html#l00592">mbuf_begin_read()</a>, <a class="el" href="mbuf_8c_source.html#l00142">mbuf_rd_remaining()</a>, <a class="el" href="mbuf_8c_source.html#l00466">mbuf_read()</a>, <a class="el" href="mbuf_8c_source.html#l00703">mbuf_reset_read()</a>, <a class="el" href="marshal_8h_source.html#l00034">OMB_DATA_P</a>, <a class="el" href="marshal_8h_source.html#l00036">OMB_LDATA_P</a>, <a class="el" href="omlc_8h_source.html#l00036">OML_DOUBLE_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00040">OML_INT32_VALUE</a>, <a class="el" href="oml__value_8h_source.html#l00051">oml_value_get_value</a>, <a class="el" href="oml__value_8c_source.html#l00081">oml_value_init()</a>, <a class="el" href="oml__value_8c_source.html#l00217">oml_value_reset()</a>, <a class="el" href="omlc_8h_source.html#l00264">omlc_get_double</a>, <a class="el" href="omlc_8h_source.html#l00252">omlc_get_int32</a>, <a class="el" href="marshal_8c_source.html#l00223">PACKET_HEADER_SIZE</a>, <a class="el" href="marshal_8h_source.html#l00045">OmlBinaryHeader::seqno</a>, <a class="el" href="msggen_8rb_source.html#l00206">seqno</a>, <a class="el" href="marshal_8h_source.html#l00044">OmlBinaryHeader::stream</a>, <a class="el" href="marshal_8c_source.html#l00224">STREAM_HEADER_SIZE</a>, <a class="el" href="marshal_8c_source.html#l00220">SYNC_BYTE</a>, <a class="el" href="marshal_8h_source.html#l00046">OmlBinaryHeader::timestamp</a>, <a class="el" href="marshal_8h_source.html#l00041">OmlBinaryHeader::type</a>, <a class="el" href="marshal_8c_source.html#l01375">unmarshal_typed_value()</a>, and <a class="el" href="marshal_8h_source.html#l00043">OmlBinaryHeader::values</a>.</p>

<p>Referenced by <a class="el" href="check__libshared__marshal_8c_source.html#l00602">START_TEST()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  uint8_t header_str[<a class="code" href="marshal_8c.html#a69bfb6e73bae0625ac56f441ccf542d1">PACKET_HEADER_SIZE</a> + 2];</div>
<div class="line">  uint8_t stream_header_str[<a class="code" href="marshal_8c.html#a3b585e315e695d71caa6d9a3d8bb7355">STREAM_HEADER_SIZE</a>];</div>
<div class="line">  <span class="keywordtype">int</span> result, n;</div>
<div class="line">  <a class="code" href="structOmlValue.html">OmlValue</a> <a class="code" href="msggen_8rb.html#a44c805e72fc65562203328da24d9014e">seqno</a>;</div>
<div class="line">  <a class="code" href="structOmlValue.html">OmlValue</a> timestamp;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="oml__value_8c.html#aecf953b9ce05c582c030eec0e962c69c">oml_value_init</a>(&amp;seqno);</div>
<div class="line">  <a class="code" href="oml__value_8c.html#aecf953b9ce05c582c030eec0e962c69c">oml_value_init</a>(&amp;timestamp);</div>
<div class="line"></div>
<div class="line">  result = <a class="code" href="mbuf_8c.html#a15b039c1f8b9f4e0d5fdffdc5f554192">mbuf_begin_read</a> (mbuf);</div>
<div class="line">  <span class="keywordflow">if</span> (result == -1) {</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Couldn&#39;t start unmarshalling packet (mbuf_begin_read())\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  result = <a class="code" href="mbuf_8c.html#a7217f65b708944e4f3f5d2f45e436a99">mbuf_read</a> (mbuf, header_str, 3);</div>
<div class="line">  <span class="keywordflow">if</span> (result == -1) {</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="mbuf_8c.html#acf28b4348adeea5087141f795c71bd7a">mbuf_rd_remaining</a> (mbuf) - 3;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (! (header_str[0] == <a class="code" href="marshal_8c.html#adb06558fc1b7d94db791ac81ac7749d1">SYNC_BYTE</a> &amp;&amp; header_str[1] == <a class="code" href="marshal_8c.html#adb06558fc1b7d94db791ac81ac7749d1">SYNC_BYTE</a>)) {</div>
<div class="line">    <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a>(<span class="stringliteral">&quot;Cannot find sync bytes in binary stream, out of sync; first 3 bytes: %#0x %#0x %#0x\n&quot;</span>,</div>
<div class="line">        header_str[0], header_str[1], header_str[2]);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  header-&gt;<a class="code" href="structOmlBinaryHeader.html#aa74b1de7e6a71da225764bd1dd417914">type</a> = (<a class="code" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0a">OmlBinMsgType</a>)header_str[2];</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (header-&gt;<a class="code" href="structOmlBinaryHeader.html#aa74b1de7e6a71da225764bd1dd417914">type</a> == <a class="code" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0aa98d5a2a2fd99f1cea2d4f90ece79cf49">OMB_DATA_P</a>) {</div>
<div class="line">    <span class="comment">// Read 2 more bytes of the length field</span></div>
<div class="line">    uint16_t nv16 = 0;</div>
<div class="line">    result = <a class="code" href="mbuf_8c.html#a7217f65b708944e4f3f5d2f45e436a99">mbuf_read</a> (mbuf, (uint8_t*)&amp;nv16, <span class="keyword">sizeof</span> (uint16_t));</div>
<div class="line">    <span class="keywordflow">if</span> (result == -1) {</div>
<div class="line">      n = <a class="code" href="mbuf_8c.html#acf28b4348adeea5087141f795c71bd7a">mbuf_rd_remaining</a> (mbuf) - 2;</div>
<div class="line">      <a class="code" href="mbuf_8c.html#abf9a6c655d77bfc4f8d0299ce65a08c1">mbuf_reset_read</a> (mbuf);</div>
<div class="line">      <span class="keywordflow">return</span> n;</div>
<div class="line">    }</div>
<div class="line">    header-&gt;<a class="code" href="structOmlBinaryHeader.html#a2417e0ee3d2094711a98f92ea00d0608">length</a> = (int)ntohs (nv16);</div>
<div class="line">  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (header-&gt;<a class="code" href="structOmlBinaryHeader.html#aa74b1de7e6a71da225764bd1dd417914">type</a> == <a class="code" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0aaa3c47b159216a0127bcfea4f07c4a693">OMB_LDATA_P</a>) {</div>
<div class="line">    <span class="comment">// Read 4 more bytes of the length field</span></div>
<div class="line">    uint32_t nv32 = 0;</div>
<div class="line">    result = <a class="code" href="mbuf_8c.html#a7217f65b708944e4f3f5d2f45e436a99">mbuf_read</a> (mbuf, (uint8_t*)&amp;nv32, <span class="keyword">sizeof</span> (uint32_t));</div>
<div class="line">    <span class="keywordflow">if</span> (result == -1) {</div>
<div class="line">      n = <a class="code" href="mbuf_8c.html#acf28b4348adeea5087141f795c71bd7a">mbuf_rd_remaining</a> (mbuf) - 4;</div>
<div class="line">      <a class="code" href="mbuf_8c.html#abf9a6c655d77bfc4f8d0299ce65a08c1">mbuf_reset_read</a> (mbuf);</div>
<div class="line">      <span class="keywordflow">return</span> n;</div>
<div class="line">    }</div>
<div class="line">    header-&gt;<a class="code" href="structOmlBinaryHeader.html#a2417e0ee3d2094711a98f92ea00d0608">length</a> = (int)ntohl (nv32);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <a class="code" href="log_8c.html#ac65b3f90d3228474368b2b48a488cd44">logwarn</a> (<span class="stringliteral">&quot;Unknown packet type %d\n&quot;</span>, (<span class="keywordtype">int</span>)header-&gt;<a class="code" href="structOmlBinaryHeader.html#aa74b1de7e6a71da225764bd1dd417914">type</a>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">int</span> extra = <a class="code" href="mbuf_8c.html#acf28b4348adeea5087141f795c71bd7a">mbuf_rd_remaining</a> (mbuf) - header-&gt;<a class="code" href="structOmlBinaryHeader.html#a2417e0ee3d2094711a98f92ea00d0608">length</a>;</div>
<div class="line">  <span class="keywordflow">if</span> (extra &lt; 0) {</div>
<div class="line">    <a class="code" href="mbuf_8c.html#abf9a6c655d77bfc4f8d0299ce65a08c1">mbuf_reset_read</a> (mbuf);</div>
<div class="line">    <span class="keywordflow">return</span> extra;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  result = <a class="code" href="mbuf_8c.html#a7217f65b708944e4f3f5d2f45e436a99">mbuf_read</a> (mbuf, stream_header_str, <a class="code" href="oml__util_8h.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a> (stream_header_str));</div>
<div class="line">  <span class="keywordflow">if</span> (result == -1) {</div>
<div class="line">      n = <a class="code" href="mbuf_8c.html#acf28b4348adeea5087141f795c71bd7a">mbuf_rd_remaining</a> (mbuf) - <a class="code" href="oml__util_8h.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a> (stream_header_str);</div>
<div class="line">      <a class="code" href="mbuf_8c.html#abf9a6c655d77bfc4f8d0299ce65a08c1">mbuf_reset_read</a> (mbuf);</div>
<div class="line">      <span class="keywordflow">return</span> n;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  header-&gt;<a class="code" href="structOmlBinaryHeader.html#a3d0aea253e7297a378da0ae9931bf3f7">values</a> = (int)stream_header_str[0];</div>
<div class="line">  header-&gt;<a class="code" href="structOmlBinaryHeader.html#a7307c8a8c7e51271dcac40fb068d5bc4">stream</a> = (int)stream_header_str[1];</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="marshal_8c.html#afe75273760bb0a7a49d0d1f53ac649be">unmarshal_typed_value</a> (mbuf, <span class="stringliteral">&quot;seq-no&quot;</span>, <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012aab24deeb6fcd36f47779e12dca2c38b9">OML_INT32_VALUE</a>, &amp;seqno) == -1)</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="marshal_8c.html#afe75273760bb0a7a49d0d1f53ac649be">unmarshal_typed_value</a> (mbuf, <span class="stringliteral">&quot;timestamp&quot;</span>, <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012adf6df4b257026d03f661cfb85dc7d1c3">OML_DOUBLE_VALUE</a>, &amp;timestamp) == -1)</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">  header-&gt;<a class="code" href="structOmlBinaryHeader.html#afbd06e85da03463c78d51f06c97a384d">seqno</a> = <a class="code" href="omlc_8h.html#a6314fe3dc202a16edcd064d8504a24d5">omlc_get_int32</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(&amp;seqno));</div>
<div class="line">  header-&gt;<a class="code" href="structOmlBinaryHeader.html#ae2557729ebf8397128b88077c465edd6">timestamp</a> = <a class="code" href="omlc_8h.html#adb34b291e3acb9b9a52c544c34c6568c">omlc_get_double</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(&amp;timestamp));</div>
<div class="line"></div>
<div class="line">  <a class="code" href="oml__value_8c.html#ad73bf2617858cdc9c70722e1ca91eea3">oml_value_reset</a>(&amp;seqno);</div>
<div class="line">  <a class="code" href="oml__value_8c.html#ad73bf2617858cdc9c70722e1ca91eea3">oml_value_reset</a>(&amp;timestamp);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a7ad49adff0224add7e13e06a558eb4bd"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">int unmarshal_measurements </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structMBuffer.html">MBuffer</a> *&#160;</td>
          <td class="paramname"><em>mbuf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structOmlBinaryHeader.html">OmlBinaryHeader</a> *&#160;</td>
          <td class="paramname"><em>header</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structOmlValue.html">OmlValue</a> *&#160;</td>
          <td class="paramname"><em>values</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>max_value_count</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="marshal2_8c.html#a5398fde39990827c7e2070af9ea94145">unmarshal_values</a> </dd></dl>

<p>Definition at line <a class="el" href="marshal_8c_source.html#l01040">1040</a> of file <a class="el" href="marshal_8c_source.html">marshal.c</a>.</p>

<p>References <a class="el" href="marshal_8c_source.html#l01062">unmarshal_values()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="marshal_8c.html#a5398fde39990827c7e2070af9ea94145">unmarshal_values</a>(mbuf, header, values, max_value_count);</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="afe75273760bb0a7a49d0d1f53ac649be"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int unmarshal_typed_value </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structMBuffer.html">MBuffer</a> *&#160;</td>
          <td class="paramname"><em>mbuf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012">OmlValueT</a>&#160;</td>
          <td class="paramname"><em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structOmlValue.html">OmlValue</a> *&#160;</td>
          <td class="paramname"><em>value</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Unmarshals the next content of an <a class="el" href="structMBuffer.html">MBuffer</a> into an <a class="el" href="structOmlValue.html">OmlValue</a> with type-checking.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mbuf</td><td><a class="el" href="structMBuffer.html">MBuffer</a> to read from </td></tr>
    <tr><td class="paramname">type</td><td>OmlValueT specifying the type to unmarshall </td></tr>
    <tr><td class="paramname">value</td><td>pointer to <a class="el" href="structOmlValue.html">OmlValue</a> to unmarshall the read data into </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>1 if successful, 0 otherwise (e.g., type mismatch) </dd></dl>

<p>Definition at line <a class="el" href="marshal_8c_source.html#l01375">1375</a> of file <a class="el" href="marshal_8c_source.html">marshal.c</a>.</p>

<p>References <a class="el" href="log_8c_source.html#l00297">logerror()</a>, <a class="el" href="oml__value_8c_source.html#l00298">oml_type_to_s()</a>, <a class="el" href="oml__value_8h_source.html#l00060">oml_value_get_type</a>, and <a class="el" href="marshal_8c_source.html#l01101">unmarshal_value()</a>.</p>

<p>Referenced by <a class="el" href="marshal_8c_source.html#l00951">unmarshal_init()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="marshal_8c.html#a000380a8534653b3027ec98e04e270c0">unmarshal_value</a> (mbuf, value) != 1) {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Error reading %s from binary packet\n&quot;</span>, <a class="code" href="init_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);</div>
<div class="line">      <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="oml__value_8h.html#aa1e9629b4e4c34fe9d24ab381ad4550c">oml_value_get_type</a>(value) != <a class="code" href="oml__value_8c.html#ae1087eeb503fb7b11a810d93605c97df">type</a>) {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Expected type &#39;%s&#39; for %s, but got type &#39;%s&#39; instead\n&quot;</span>,</div>
<div class="line">             <a class="code" href="oml__value_8c.html#a7599e6fb79e38eda3ed88a6ead2d2caf">oml_type_to_s</a> (<a class="code" href="oml__value_8c.html#ae1087eeb503fb7b11a810d93605c97df">type</a>), <a class="code" href="init_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <a class="code" href="oml__value_8c.html#a7599e6fb79e38eda3ed88a6ead2d2caf">oml_type_to_s</a> (<a class="code" href="oml__value_8h.html#aa1e9629b4e4c34fe9d24ab381ad4550c">oml_value_get_type</a>(value)));</div>
<div class="line">      <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="aa8de004239cbf2b4910d003eab5dada0"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int unmarshal_value </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structMBuffer.html">MBuffer</a> *&#160;</td>
          <td class="paramname"><em>mbuf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structOmlValue.html">OmlValue</a> *&#160;</td>
          <td class="paramname"><em>value</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Unmarshals the next content of an <a class="el" href="structMBuffer.html">MBuffer</a> into a <a class="el" href="structOmlValue.html">OmlValue</a></p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mbuf</td><td><a class="el" href="structMBuffer.html">MBuffer</a> to read from </td></tr>
    <tr><td class="paramname">value</td><td>pointer to <a class="el" href="structOmlValue.html">OmlValue</a> to unmarshall the read data into </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>1 if successful, 0 otherwise </dd></dl>

<p>Definition at line <a class="el" href="marshal_8c_source.html#l01101">1101</a> of file <a class="el" href="marshal_8c_source.html">marshal.c</a>.</p>

<p>References <a class="el" href="marshal_8c_source.html#l00184">BIG_L</a>, <a class="el" href="marshal_8c_source.html#l00203">BLOB_T</a>, <a class="el" href="marshal_8c_source.html#l00207">BOOL_FALSE_T</a>, <a class="el" href="marshal_8c_source.html#l00213">BOOL_T</a>, <a class="el" href="marshal_8c_source.html#l00209">BOOL_TRUE_T</a>, <a class="el" href="marshal_8c_source.html#l00217">DATETIME_T</a>, <a class="el" href="marshal_8c_source.html#l00230">DATETIME_T_MAX_SIZE</a>, <a class="el" href="marshal_8c_source.html#l00215">DOUBLE64_T</a>, <a class="el" href="marshal_8c_source.html#l00191">DOUBLE_NAN</a>, <a class="el" href="marshal_8c_source.html#l00189">DOUBLE_T</a>, <a class="el" href="marshal_8c_source.html#l00227">DOUBLE_T_SIZE</a>, <a class="el" href="check__text__protocol_8c_source.html#l00139">exp</a>, <a class="el" href="marshal_8c_source.html#l00205">GUID_T</a>, <a class="el" href="marshal_8c_source.html#l00236">GUID_T_SIZE</a>, <a class="el" href="marshal_8c_source.html#l00195">INT32_T</a>, <a class="el" href="marshal_8c_source.html#l00199">INT64_T</a>, <a class="el" href="oml__util_8h_source.html#l00027">LENGTH</a>, <a class="el" href="log_8c_source.html#l00333">logdebug()</a>, <a class="el" href="log_8c_source.html#l00357">logdebug3()</a>, <a class="el" href="log_8c_source.html#l00297">logerror()</a>, <a class="el" href="marshal_8c_source.html#l00187">LONG_T</a>, <a class="el" href="marshal_8c_source.html#l00226">LONG_T_SIZE</a>, <a class="el" href="mbuf_8c_source.html#l00142">mbuf_rd_remaining()</a>, <a class="el" href="mbuf_8c_source.html#l00273">mbuf_rdptr()</a>, <a class="el" href="mbuf_8c_source.html#l00466">mbuf_read()</a>, <a class="el" href="mbuf_8c_source.html#l00515">mbuf_read_byte()</a>, <a class="el" href="mbuf_8c_source.html#l00493">mbuf_read_skip()</a>, <a class="el" href="htonll_8h_source.html#l00038">ntohll</a>, <a class="el" href="omlc_8h_source.html#l00044">OML_BLOB_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00046">OML_BOOL_VALUE</a>, <a class="el" href="mem_8c_source.html#l00177">oml_calloc()</a>, <a class="el" href="omlc_8h_source.html#l00048">OML_DATETIME_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00045">OML_GUID_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00040">OML_INT32_VALUE</a>, <a class="el" href="omlc_8h_source.html#l00039">OML_STRING_VALUE</a>, <a class="el" href="oml__value_8c_source.html#l00298">oml_type_to_s()</a>, <a class="el" href="oml__value_8h_source.html#l00051">oml_value_get_value</a>, <a class="el" href="oml__value_8c_source.html#l00109">oml_value_set_type()</a>, <a class="el" href="omlc_8h_source.html#l00167">OMLC_BOOL_FALSE</a>, <a class="el" href="omlc_8h_source.html#l00168">OMLC_BOOL_TRUE</a>, <a class="el" href="omlc_8h_source.html#l00273">omlc_get_bool</a>, <a class="el" href="omlc_8h_source.html#l00264">omlc_get_double</a>, <a class="el" href="omlc_8h_source.html#l00270">omlc_get_guid</a>, <a class="el" href="omlc_8h_source.html#l00252">omlc_get_int32</a>, <a class="el" href="omlc_8h_source.html#l00258">omlc_get_int64</a>, <a class="el" href="omlc_8h_source.html#l00340">omlc_get_string_ptr</a>, <a class="el" href="omlc_8h_source.html#l00255">omlc_get_uint32</a>, <a class="el" href="omlc_8h_source.html#l00261">omlc_get_uint64</a>, <a class="el" href="omlc_8h_source.html#l00538">omlc_set_blob</a>, <a class="el" href="omlc_8h_source.html#l00302">omlc_set_bool</a>, <a class="el" href="omlc_8h_source.html#l00293">omlc_set_double</a>, <a class="el" href="omlc_8h_source.html#l00299">omlc_set_guid</a>, <a class="el" href="omlc_8h_source.html#l00281">omlc_set_int32</a>, <a class="el" href="omlc_8h_source.html#l00287">omlc_set_int64</a>, <a class="el" href="omlc_8h_source.html#l00476">omlc_set_string_copy</a>, <a class="el" href="omlc_8h_source.html#l00284">omlc_set_uint32</a>, <a class="el" href="omlc_8h_source.html#l00290">omlc_set_uint64</a>, <a class="el" href="omlc_8h_source.html#l00581">omlc_set_vector_elt_size</a>, <a class="el" href="omlc_8h_source.html#l00575">omlc_set_vector_length</a>, <a class="el" href="omlc_8h_source.html#l00584">omlc_set_vector_nof_elts</a>, <a class="el" href="omlc_8h_source.html#l00572">omlc_set_vector_ptr</a>, <a class="el" href="omlc_8h_source.html#l00578">omlc_set_vector_size</a>, <a class="el" href="marshal_8c_source.html#l00193">STRING_T</a>, <a class="el" href="marshal_8c_source.html#l00229">STRING_T_MAX_SIZE</a>, <a class="el" href="oml__value_8c_source.html#l00042">type</a>, <a class="el" href="marshal_8c_source.html#l00197">UINT32_T</a>, <a class="el" href="marshal_8c_source.html#l00201">UINT64_T</a>, <a class="el" href="marshal_8c_source.html#l00234">UINT64_T_SIZE</a>, and <a class="el" href="marshal_8c_source.html#l00211">VECTOR_T</a>.</p>

<p>Referenced by <a class="el" href="check__libshared__marshal_8c_source.html#l00602">START_TEST()</a>, <a class="el" href="marshal_8c_source.html#l01375">unmarshal_typed_value()</a>, and <a class="el" href="marshal_8c_source.html#l01062">unmarshal_values()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="mbuf_8c.html#acf28b4348adeea5087141f795c71bd7a">mbuf_rd_remaining</a>(mbuf) == 0) {</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Tried to unmarshal a value from the buffer, but didn&#39;t receive enough data to do that\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">int</span> <a class="code" href="oml__value_8c.html#ae1087eeb503fb7b11a810d93605c97df">type</a> = <a class="code" href="mbuf_8c.html#a2b5ff5e389e38561d10aee1be2c511f2">mbuf_read_byte</a> (mbuf);</div>
<div class="line">  <span class="keywordflow">if</span> (type == -1) <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">switch</span> (type) {</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a95f0d5df544261dab0fd0dcc5063de1f">LONG_T</a>: {</div>
<div class="line">    uint8_t buf [<a class="code" href="marshal_8c.html#a42b9ba4580933f67b8b2757f9dfda087">LONG_T_SIZE</a>];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="mbuf_8c.html#a7217f65b708944e4f3f5d2f45e436a99">mbuf_read</a> (mbuf, buf, <a class="code" href="oml__util_8h.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a> (buf)) == -1)</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Failed to unmarshal OML_LONG_VALUE; not enough data?\n&quot;</span>);</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    uint32_t hv = ntohl(*((uint32_t*)buf));</div>
<div class="line">    int32_t v = (int32_t)(hv);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * The server no longer needs to know about OML_LONG_VALUE, as the</span></div>
<div class="line"><span class="comment">     * marshalling process now maps OML_LONG_VALUE into OML_INT32_VALUE</span></div>
<div class="line"><span class="comment">     * (by truncating to [INT_MIN, INT_MAX].  Therefore, unmarshall a</span></div>
<div class="line"><span class="comment">     * LONG_T value into an OML_INT32_VALUE object.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <a class="code" href="oml__value_8c.html#a7213e167ca9eb81228f8b7952e99f8c9">oml_value_set_type</a>(value, <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012aab24deeb6fcd36f47779e12dca2c38b9">OML_INT32_VALUE</a>);</div>
<div class="line">    <a class="code" href="omlc_8h.html#aa8a1827db1559f247bf8a4023e466873">omlc_set_int32</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value), v);</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a2251891f2e0a2db27ca4c6507d3f4040">INT32_T</a>:</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a6bcb89102f0baaa6be3d8d140b2dc866">UINT32_T</a>:</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#afb3891492b67fa5ded53824df675ae9b">INT64_T</a>:</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a8065a16ba5bd6bb2bd861936a87b31c3">UINT64_T</a>: {</div>
<div class="line">    uint8_t buf [<a class="code" href="marshal_8c.html#a562a5c60d362d082de937e7cc1f4da48">UINT64_T_SIZE</a>]; <span class="comment">// Maximum integer size</span></div>
<div class="line">    <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012">OmlValueT</a> oml_type = protocol_type_map[<a class="code" href="oml__value_8c.html#ae1087eeb503fb7b11a810d93605c97df">type</a>];</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="mbuf_8c.html#a7217f65b708944e4f3f5d2f45e436a99">mbuf_read</a> (mbuf, buf, protocol_size_map[type]) == -1) {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Failed to unmarshall %d value; not enough data?\n&quot;</span>, type);</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="oml__value_8c.html#a7213e167ca9eb81228f8b7952e99f8c9">oml_value_set_type</a>(value, oml_type);</div>
<div class="line">    <span class="keywordflow">switch</span> (type) {</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a2251891f2e0a2db27ca4c6507d3f4040">INT32_T</a>:</div>
<div class="line">      <a class="code" href="omlc_8h.html#aa8a1827db1559f247bf8a4023e466873">omlc_set_int32</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value), ntohl(*((int32_t*)buf)));</div>
<div class="line">      <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Unmarshalled %s %&quot;</span> PRId32 <span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="oml__value_8c.html#a7599e6fb79e38eda3ed88a6ead2d2caf">oml_type_to_s</a>(oml_type), <a class="code" href="omlc_8h.html#a6314fe3dc202a16edcd064d8504a24d5">omlc_get_int32</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value)));</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a6bcb89102f0baaa6be3d8d140b2dc866">UINT32_T</a>:</div>
<div class="line">      <a class="code" href="omlc_8h.html#a1e481b1b79bdf517a3507ce8113169b2">omlc_set_uint32</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value), ntohl(*((uint32_t*)buf)));</div>
<div class="line">      <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Unmarshalled %s %&quot;</span> PRIu32 <span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="oml__value_8c.html#a7599e6fb79e38eda3ed88a6ead2d2caf">oml_type_to_s</a>(oml_type), <a class="code" href="omlc_8h.html#a1493babcfc9c69f6aa7efebf049c7a22">omlc_get_uint32</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value)));</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#afb3891492b67fa5ded53824df675ae9b">INT64_T</a>:</div>
<div class="line">      <a class="code" href="omlc_8h.html#ae05c1e9d59d47fac7ce71b2136533958">omlc_set_int64</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value), <a class="code" href="htonll_8h.html#a47f5c12368dfdf98a92bb0a8175c006f">ntohll</a>(*((int64_t*)buf)));</div>
<div class="line">      <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Unmarshalled %s %&quot;</span> PRId64 <span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="oml__value_8c.html#a7599e6fb79e38eda3ed88a6ead2d2caf">oml_type_to_s</a>(oml_type), <a class="code" href="omlc_8h.html#aeb1480723c7d9b86609a6dea4440a52d">omlc_get_int64</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value)));</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a8065a16ba5bd6bb2bd861936a87b31c3">UINT64_T</a>:</div>
<div class="line">      <a class="code" href="omlc_8h.html#a873792518d05507bf5d0b1a96524b091">omlc_set_uint64</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value), <a class="code" href="htonll_8h.html#a47f5c12368dfdf98a92bb0a8175c006f">ntohll</a>(*((uint64_t*)buf)));</div>
<div class="line">      <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Unmarshalled %s %&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="oml__value_8c.html#a7599e6fb79e38eda3ed88a6ead2d2caf">oml_type_to_s</a>(oml_type), <a class="code" href="omlc_8h.html#a37958a949ce7353bd25dee96810e2cd6">omlc_get_uint64</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value)));</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Integer morphed, something magic has just happened\n&quot;</span>);</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a9290324f1f88b0f007de36d523d8cf3a">DOUBLE_T</a>: {</div>
<div class="line">    uint8_t buf [<a class="code" href="marshal_8c.html#aff09aa348dfe724228c67255678e74d7">DOUBLE_T_SIZE</a>];</div>
<div class="line">    <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012">OmlValueT</a> oml_type = protocol_type_map[<a class="code" href="oml__value_8c.html#ae1087eeb503fb7b11a810d93605c97df">type</a>];</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="mbuf_8c.html#a7217f65b708944e4f3f5d2f45e436a99">mbuf_read</a> (mbuf, buf, <a class="code" href="oml__util_8h.html#ad0e13d94164219be2d5bbd4d65e71d1e">LENGTH</a> (buf)) == -1)</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Failed to unmarshal OML_DOUBLE_VALUE; not enough data?\n&quot;</span>);</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> hmant = (int)ntohl(*((uint32_t*)buf));</div>
<div class="line">    <span class="keywordtype">double</span> mant = hmant * 1.0 / (1 &lt;&lt; <a class="code" href="marshal_8c.html#af6f8ed1dac346fb91d21a4ce56c9d160">BIG_L</a>);</div>
<div class="line">    <span class="keywordtype">int</span> <a class="code" href="check__text__protocol_8c.html#afc541abe000a672ebe850f1448b25306">exp</a> = (int8_t) buf[4];</div>
<div class="line">    <span class="keywordtype">double</span> v = ldexp(mant, exp);</div>
<div class="line">    <a class="code" href="oml__value_8c.html#a7213e167ca9eb81228f8b7952e99f8c9">oml_value_set_type</a>(value, oml_type);</div>
<div class="line">    <a class="code" href="omlc_8h.html#a6a342646d654733d01aff00bf9a308da">omlc_set_double</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value), v);</div>
<div class="line">    <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Unmarshalled double %f\n&quot;</span>, <a class="code" href="omlc_8h.html#adb34b291e3acb9b9a52c544c34c6568c">omlc_get_double</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value)));</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a05c4e15b9701b28975effde191bc9bf6">DOUBLE_NAN</a>: {</div>
<div class="line">    <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012">OmlValueT</a> oml_type = protocol_type_map[<a class="code" href="oml__value_8c.html#ae1087eeb503fb7b11a810d93605c97df">type</a>];</div>
<div class="line">    <a class="code" href="mbuf_8c.html#a906aa8bcabc6a81ad4a699bb021b959c">mbuf_read_skip</a>(mbuf, <a class="code" href="marshal_8c.html#aff09aa348dfe724228c67255678e74d7">DOUBLE_T_SIZE</a>); <span class="comment">/* The data is irrelevant */</span></div>
<div class="line">    <a class="code" href="oml__value_8c.html#a7213e167ca9eb81228f8b7952e99f8c9">oml_value_set_type</a>(value, oml_type);</div>
<div class="line">    <a class="code" href="omlc_8h.html#a6a342646d654733d01aff00bf9a308da">omlc_set_double</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value), NAN);</div>
<div class="line">    <a class="code" href="log_8c.html#a1db1902215b0897e1ec8c2a8766465b2">logdebug</a>(<span class="stringliteral">&quot;Received NaN\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a64b41f937ac6a39ee0c32adecfa606dd">STRING_T</a>: {</div>
<div class="line">    <span class="keywordtype">int</span> len = 0;</div>
<div class="line">    uint8_t buf [<a class="code" href="marshal_8c.html#a819d5a9d27da69526498471b39ae19d9">STRING_T_MAX_SIZE</a>];</div>
<div class="line"></div>
<div class="line">    len = <a class="code" href="mbuf_8c.html#a2b5ff5e389e38561d10aee1be2c511f2">mbuf_read_byte</a> (mbuf);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (len == -1 || <a class="code" href="mbuf_8c.html#a7217f65b708944e4f3f5d2f45e436a99">mbuf_read</a> (mbuf, buf, len) == -1)</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Failed to unmarshal OML_STRING_VALUE; not enough data?\n&quot;</span>);</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="oml__value_8c.html#a7213e167ca9eb81228f8b7952e99f8c9">oml_value_set_type</a>(value, <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012a42b33eb7c21f79727a894a530a05b559">OML_STRING_VALUE</a>);</div>
<div class="line">    <a class="code" href="omlc_8h.html#a4eed1605fcf935e2bb7f9944066dd62c">omlc_set_string_copy</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value), buf, len);</div>
<div class="line">    <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Unmarshalled string &#39;%s&#39; of length %d\n&quot;</span>, <a class="code" href="omlc_8h.html#ae5077b9404ef5c4c2f66a1a654430512">omlc_get_string_ptr</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value)), len);</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a9a9ca3cedd4166caa9f599511a8659e3">DATETIME_T</a>: {</div>
<div class="line">    <span class="keywordtype">int</span> len = 0;</div>
<div class="line">    uint8_t buf [<a class="code" href="marshal_8c.html#ab5ef0349bcf5b7dc6324720d1e482227">DATETIME_T_MAX_SIZE</a>];</div>
<div class="line"></div>
<div class="line">    len = <a class="code" href="mbuf_8c.html#a2b5ff5e389e38561d10aee1be2c511f2">mbuf_read_byte</a> (mbuf);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (len == -1 || <a class="code" href="mbuf_8c.html#a7217f65b708944e4f3f5d2f45e436a99">mbuf_read</a> (mbuf, buf, len) == -1)</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Failed to unmarshal OML_DATETIME_VALUE; not enough data?\n&quot;</span>);</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="oml__value_8c.html#a7213e167ca9eb81228f8b7952e99f8c9">oml_value_set_type</a>(value, <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012a757bfe5ea9a3b418e9d2ca243c843c59">OML_DATETIME_VALUE</a>);</div>
<div class="line">    <a class="code" href="omlc_8h.html#a4eed1605fcf935e2bb7f9944066dd62c">omlc_set_string_copy</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value), buf, len);</div>
<div class="line">    <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Unmarshalled string &#39;%s&#39; of length %d\n&quot;</span>, <a class="code" href="omlc_8h.html#ae5077b9404ef5c4c2f66a1a654430512">omlc_get_string_ptr</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value)), len);</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a2be536a5a6e8f0b613f766f04743581d">BLOB_T</a>: {</div>
<div class="line">    uint32_t n_len;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="mbuf_8c.html#a7217f65b708944e4f3f5d2f45e436a99">mbuf_read</a> (mbuf, (uint8_t*)&amp;n_len, 4) == -1) {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a> (<span class="stringliteral">&quot;Failed to unmarshal OML_BLOB_VALUE length field; not enough data?\n&quot;</span>);</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">size_t</span> len = ntohl (n_len);</div>
<div class="line">    <span class="keywordtype">size_t</span> remaining = <a class="code" href="mbuf_8c.html#acf28b4348adeea5087141f795c71bd7a">mbuf_rd_remaining</a> (mbuf);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (len &gt; remaining) {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a> (<span class="stringliteral">&quot;Failed to unmarshal OML_BLOB_VALUE data:  not enough data available &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;(wanted %d, but only have %d bytes\n&quot;</span>,</div>
<div class="line">                len, remaining);</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> *ptr = <a class="code" href="mbuf_8c.html#ad1e104ade5f0bd7a063e5673349f64b6">mbuf_rdptr</a> (mbuf);</div>
<div class="line">    <a class="code" href="oml__value_8c.html#a7213e167ca9eb81228f8b7952e99f8c9">oml_value_set_type</a>(value, <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012aea7273ecb417f61976d2089a31e75037">OML_BLOB_VALUE</a>);</div>
<div class="line">    <a class="code" href="omlc_8h.html#af59728cba3c4fd80c107c58fa9a1179c">omlc_set_blob</a> (*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value), ptr, len); <span class="comment">/*XXX*/</span></div>
<div class="line">    <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Unmarshalled blob of size %d\n&quot;</span>, len);</div>
<div class="line">    <a class="code" href="mbuf_8c.html#a906aa8bcabc6a81ad4a699bb021b959c">mbuf_read_skip</a> (mbuf, len);</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a06c2c3d86fd6e81c65fa34777944f495">GUID_T</a>: {</div>
<div class="line">    uint64_t nv64;</div>
<div class="line">    uint8_t buf[<a class="code" href="marshal_8c.html#a02d9571c55f4499fe06a581523398665">GUID_T_SIZE</a>];</div>
<div class="line">    <span class="keywordflow">if</span>(<a class="code" href="mbuf_8c.html#a7217f65b708944e4f3f5d2f45e436a99">mbuf_read</a>(mbuf, buf, <a class="code" href="marshal_8c.html#a02d9571c55f4499fe06a581523398665">GUID_T_SIZE</a>) == -1) {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;Failed to unmarshall OML_GUID_VALUE data; not enough data?\n&quot;</span>);</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    memcpy(&amp;nv64, buf, <span class="keyword">sizeof</span>(nv64));</div>
<div class="line">    <a class="code" href="oml__value_8c.html#a7213e167ca9eb81228f8b7952e99f8c9">oml_value_set_type</a>(value, <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012a8f383c792a4697dbf4db99ef2514853f">OML_GUID_VALUE</a>);</div>
<div class="line">    <a class="code" href="omlc_8h.html#a836a2fe9346677384bf5dd8dee7eb0ed">omlc_set_guid</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value), <a class="code" href="htonll_8h.html#a47f5c12368dfdf98a92bb0a8175c006f">ntohll</a>(nv64));</div>
<div class="line">    <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Unmarshalled GUID %&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="omlc_8h.html#a2ef9e64d176c33c11c98d11fae69a5ea">omlc_get_guid</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value)));</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a7e5ce4a4afe3c8c5e6a166a98c73bf49">BOOL_FALSE_T</a>:</div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#aaaece6ec7d7273c485301e9b4a88c27e">BOOL_TRUE_T</a>:</div>
<div class="line">    <a class="code" href="oml__value_8c.html#a7213e167ca9eb81228f8b7952e99f8c9">oml_value_set_type</a>(value, <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012ac12a596e1ea36e0a6f0c58d2b63c8046">OML_BOOL_VALUE</a>);</div>
<div class="line">    <a class="code" href="omlc_8h.html#a8d84dc9e74c5e2c6fe319a6e1d9f8776">omlc_set_bool</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value),</div>
<div class="line">                  (type == <a class="code" href="marshal_8c.html#aaaece6ec7d7273c485301e9b4a88c27e">BOOL_TRUE_T</a>)?<a class="code" href="omlc_8h.html#adb144d30b19909691a929afe2511d257">OMLC_BOOL_TRUE</a>:<a class="code" href="omlc_8h.html#a33ea04fbefee8fb9eabe9b0f0e2f2087">OMLC_BOOL_FALSE</a>);</div>
<div class="line">    <a class="code" href="log_8c.html#ab03b768efda444efeb2a65c85ec66515">logdebug3</a>(<span class="stringliteral">&quot;Unmarshalled boolean %d\n&quot;</span>, <a class="code" href="omlc_8h.html#adb144d30b19909691a929afe2511d257">OMLC_BOOL_TRUE</a> == <a class="code" href="omlc_8h.html#ad5e34e372b65dec9ccfc9fc61c3fbc6c">omlc_get_bool</a>(*<a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value)));</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a1f6327298a81a863946fc71c15f75c1d">VECTOR_T</a>: {</div>
<div class="line">    uint16_t i, nof_elts;</div>
<div class="line">    <span class="keywordtype">int</span> type = <a class="code" href="mbuf_8c.html#a2b5ff5e389e38561d10aee1be2c511f2">mbuf_read_byte</a>(mbuf);</div>
<div class="line">    <span class="keywordflow">if</span>(-1 == type) {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;%s(): failed to unmarshall VECTOR_T length\n&quot;</span>, __func__);</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span>(<a class="code" href="mbuf_8c.html#a7217f65b708944e4f3f5d2f45e436a99">mbuf_read</a>(mbuf,(uint8_t*)(&amp;nof_elts), <span class="keyword">sizeof</span>(nof_elts)) == -1) {</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;%s(): failed to unmarshall VECTOR_T length\n&quot;</span>, __func__);</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    nof_elts = ntohs(nof_elts);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="omlc_8h.html#ab15565231ebb9d8d8550c14e0aaa3012">OmlValueT</a> oml_type = vector_type_map[<a class="code" href="oml__value_8c.html#ae1087eeb503fb7b11a810d93605c97df">type</a>];</div>
<div class="line">    <a class="code" href="unionOmlValueU.html">OmlValueU</a> *v = <a class="code" href="oml__value_8h.html#a4f590bee663b713f2afeee50ca06260b">oml_value_get_value</a>(value);</div>
<div class="line">    <span class="keywordflow">switch</span>(type) {</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a2251891f2e0a2db27ca4c6507d3f4040">INT32_T</a>:</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a6bcb89102f0baaa6be3d8d140b2dc866">UINT32_T</a>: {</div>
<div class="line">      <span class="keywordtype">size_t</span> bytes = nof_elts * <span class="keyword">sizeof</span>(uint32_t);</div>
<div class="line">      uint32_t *elts = <a class="code" href="mem_8c.html#a27b2165022c4da06f3ce5367d5989789">oml_calloc</a>(nof_elts, <span class="keyword">sizeof</span>(uint32_t));</div>
<div class="line">      <span class="keywordflow">if</span>(<a class="code" href="mbuf_8c.html#a7217f65b708944e4f3f5d2f45e436a99">mbuf_read</a>(mbuf, (uint8_t*)(elts), nof_elts * <span class="keyword">sizeof</span>(uint32_t)) == -1) {</div>
<div class="line">        <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;%s(): failed to unmarshall OML_VECTOR_(U)INT32_VALUE\n&quot;</span>, __func__);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">for</span>(i = 0; i &lt; nof_elts; i++)</div>
<div class="line">        elts[i] = ntohl(elts[i]);</div>
<div class="line">      <a class="code" href="oml__value_8c.html#a7213e167ca9eb81228f8b7952e99f8c9">oml_value_set_type</a>(value, oml_type);</div>
<div class="line">      <a class="code" href="omlc_8h.html#a5906c5508ed2d8717502bc7ffb30bcdf">omlc_set_vector_ptr</a>(*v, elts);</div>
<div class="line">      <a class="code" href="omlc_8h.html#a09191fe39d15da52ac2233ff03bd96a1">omlc_set_vector_length</a>(*v, bytes);</div>
<div class="line">      <a class="code" href="omlc_8h.html#a12c50071780988544b5d6d5cffbb7186">omlc_set_vector_size</a>(*v, bytes);</div>
<div class="line">      <a class="code" href="omlc_8h.html#ae6677bb30eee8487ad07d02e7de01a27">omlc_set_vector_nof_elts</a>(*v, nof_elts);</div>
<div class="line">      <a class="code" href="omlc_8h.html#ac69d7e1ea25ae3b088ce96e013ff7910">omlc_set_vector_elt_size</a>(*v, <span class="keyword">sizeof</span>(uint32_t));</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#afb3891492b67fa5ded53824df675ae9b">INT64_T</a>:</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a8065a16ba5bd6bb2bd861936a87b31c3">UINT64_T</a>:</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#a581a09495b0830f03098e721cd253054">DOUBLE64_T</a>: {</div>
<div class="line">      <span class="keywordtype">size_t</span> bytes = nof_elts * <span class="keyword">sizeof</span>(uint64_t);</div>
<div class="line">      uint64_t *elts = <a class="code" href="mem_8c.html#a27b2165022c4da06f3ce5367d5989789">oml_calloc</a>(nof_elts, <span class="keyword">sizeof</span>(uint64_t));</div>
<div class="line">      <span class="keywordflow">if</span>(<a class="code" href="mbuf_8c.html#a7217f65b708944e4f3f5d2f45e436a99">mbuf_read</a>(mbuf, (uint8_t*)(elts), nof_elts * <span class="keyword">sizeof</span>(uint64_t)) == -1) {</div>
<div class="line">        <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;%s(): failed to unmarshall OML_VECTOR_(U)INT64_VALUE\n&quot;</span>, __func__);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">for</span>(i = 0; i &lt; nof_elts; i++)</div>
<div class="line">        elts[i] = <a class="code" href="htonll_8h.html#a47f5c12368dfdf98a92bb0a8175c006f">ntohll</a>(elts[i]);</div>
<div class="line">      <a class="code" href="oml__value_8c.html#a7213e167ca9eb81228f8b7952e99f8c9">oml_value_set_type</a>(value, oml_type);</div>
<div class="line">      <a class="code" href="omlc_8h.html#a5906c5508ed2d8717502bc7ffb30bcdf">omlc_set_vector_ptr</a>(*v, elts);</div>
<div class="line">      <a class="code" href="omlc_8h.html#a09191fe39d15da52ac2233ff03bd96a1">omlc_set_vector_length</a>(*v, bytes);</div>
<div class="line">      <a class="code" href="omlc_8h.html#a12c50071780988544b5d6d5cffbb7186">omlc_set_vector_size</a>(*v, bytes);</div>
<div class="line">      <a class="code" href="omlc_8h.html#ae6677bb30eee8487ad07d02e7de01a27">omlc_set_vector_nof_elts</a>(*v, nof_elts);</div>
<div class="line">      <a class="code" href="omlc_8h.html#ac69d7e1ea25ae3b088ce96e013ff7910">omlc_set_vector_elt_size</a>(*v, <span class="keyword">sizeof</span>(uint64_t));</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="marshal_8c.html#ad9632df94491fbec00c478801a80283b">BOOL_T</a>: {</div>
<div class="line">      uint8_t y[nof_elts];</div>
<div class="line">      <span class="keywordtype">size_t</span> bytes = nof_elts * <span class="keyword">sizeof</span>(bool);</div>
<div class="line">      <span class="keywordtype">bool</span> *elts = <a class="code" href="mem_8c.html#a27b2165022c4da06f3ce5367d5989789">oml_calloc</a>(nof_elts, <span class="keyword">sizeof</span>(<span class="keywordtype">bool</span>));</div>
<div class="line">      <span class="keywordflow">if</span>(<a class="code" href="mbuf_8c.html#a7217f65b708944e4f3f5d2f45e436a99">mbuf_read</a>(mbuf, y, nof_elts) == -1) {</div>
<div class="line">        <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;%s(): failed to unmarshall OML_VECTOR_BOOL_VALUE\n&quot;</span>, __func__);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">for</span>(i = 0; i &lt; nof_elts; i++)</div>
<div class="line">        elts[i] = ((<a class="code" href="marshal_8c.html#aaaece6ec7d7273c485301e9b4a88c27e">BOOL_TRUE_T</a> == y[i]) ? <span class="keyword">true</span> : <span class="keyword">false</span>);</div>
<div class="line">      <a class="code" href="oml__value_8c.html#a7213e167ca9eb81228f8b7952e99f8c9">oml_value_set_type</a>(value, oml_type);</div>
<div class="line">      <a class="code" href="omlc_8h.html#a5906c5508ed2d8717502bc7ffb30bcdf">omlc_set_vector_ptr</a>(*v, elts);</div>
<div class="line">      <a class="code" href="omlc_8h.html#a09191fe39d15da52ac2233ff03bd96a1">omlc_set_vector_length</a>(*v, bytes);</div>
<div class="line">      <a class="code" href="omlc_8h.html#a12c50071780988544b5d6d5cffbb7186">omlc_set_vector_size</a>(*v, bytes);</div>
<div class="line">      <a class="code" href="omlc_8h.html#ae6677bb30eee8487ad07d02e7de01a27">omlc_set_vector_nof_elts</a>(*v, nof_elts);</div>
<div class="line">      <a class="code" href="omlc_8h.html#ac69d7e1ea25ae3b088ce96e013ff7910">omlc_set_vector_elt_size</a>(*v, <span class="keyword">sizeof</span>(<span class="keywordtype">bool</span>));</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;%s(): bad type for array (t=%d)\n&quot;</span>, __func__, type);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">default</span>:</div>
<div class="line">    <a class="code" href="log_8c.html#a0548af6117bef6d5c78d45a36ab7013b">logerror</a>(<span class="stringliteral">&quot;%s: Unsupported value type &#39;%d&#39;\n&quot;</span>, __FUNCTION__, type);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a30649308038b6836ddb4d8945a374216"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int unmarshal_values </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structMBuffer.html">MBuffer</a> *&#160;</td>
          <td class="paramname"><em>mbuf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structOmlBinaryHeader.html">OmlBinaryHeader</a> *&#160;</td>
          <td class="paramname"><em>header</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structOmlValue.html">OmlValue</a> *&#160;</td>
          <td class="paramname"><em>values</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>max_value_count</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Unmarshals the content of buffer into an array of values of size value_count.</p>
<p>If the returned number is negative, there were more values than could fit in the array in the buffer, and some were skipped. This number (when multiplied by -1) indicates by how much the values array should be extended. If the number is less than -100, it indicates an error.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mbuf</td><td><a class="el" href="structMBuffer.html">MBuffer</a> to read from </td></tr>
    <tr><td class="paramname">header</td><td>pointer to an <a class="el" href="structOmlBinaryHeader.html">OmlBinaryHeader</a> corresponding to this message </td></tr>
    <tr><td class="paramname">values</td><td>array of <a class="el" href="structOmlValue.html">OmlValue</a> to be filled </td></tr>
    <tr><td class="paramname">max_value_count</td><td>length of the array (XXX: Should be &lt; 100, otherwise confusion may happen with error returns) </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the number of values found (positive), or the number of values that didn't fit in the array (negative; multiplied by -1), &lt;-100 in case of error </dd></dl>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="marshal2_8c.html#a50099442a78fa10193ffa16aaf06c6ab">unmarshal_init</a> </dd></dl>

<p>Definition at line <a class="el" href="marshal_8c_source.html#l01062">1062</a> of file <a class="el" href="marshal_8c_source.html">marshal.c</a>.</p>

<p>References <a class="el" href="marshal_8h_source.html#l00042">OmlBinaryHeader::length</a>, <a class="el" href="log_8c_source.html#l00309">logwarn()</a>, <a class="el" href="mbuf_8c_source.html#l00592">mbuf_begin_read()</a>, <a class="el" href="mbuf_8c_source.html#l00493">mbuf_read_skip()</a>, <a class="el" href="marshal_8c_source.html#l00223">PACKET_HEADER_SIZE</a>, <a class="el" href="marshal_8c_source.html#l01101">unmarshal_value()</a>, and <a class="el" href="marshal_8h_source.html#l00043">OmlBinaryHeader::values</a>.</p>

<p>Referenced by <a class="el" href="check__libshared__marshal_8c_source.html#l01374">START_TEST()</a>, and <a class="el" href="marshal_8c_source.html#l01040">unmarshal_measurements()</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> value_count = header-&gt;<a class="code" href="structOmlBinaryHeader.html#a3d0aea253e7297a378da0ae9931bf3f7">values</a>;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (0 == value_count) {</div>
<div class="line">    <a class="code" href="log_8c.html#ac65b3f90d3228474368b2b48a488cd44">logwarn</a>(<span class="stringliteral">&quot;No value to unmarshall\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -102;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (value_count &gt; max_value_count) {</div>
<div class="line">    <a class="code" href="log_8c.html#ac65b3f90d3228474368b2b48a488cd44">logwarn</a>(<span class="stringliteral">&quot;Measurement packet contained %d too many values for internal storage (max %d, actual %d); skipping packet\n&quot;</span>,</div>
<div class="line">           (value_count - max_value_count), max_value_count, value_count);</div>
<div class="line">    <a class="code" href="log_8c.html#ac65b3f90d3228474368b2b48a488cd44">logwarn</a>(<span class="stringliteral">&quot;Message length appears to be %d + 5\n&quot;</span>, header-&gt;<a class="code" href="structOmlBinaryHeader.html#a2417e0ee3d2094711a98f92ea00d0608">length</a>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="mbuf_8c.html#a906aa8bcabc6a81ad4a699bb021b959c">mbuf_read_skip</a> (mbuf, header-&gt;<a class="code" href="structOmlBinaryHeader.html#a2417e0ee3d2094711a98f92ea00d0608">length</a> + <a class="code" href="marshal_8c.html#a69bfb6e73bae0625ac56f441ccf542d1">PACKET_HEADER_SIZE</a>);</div>
<div class="line">    <a class="code" href="mbuf_8c.html#a15b039c1f8b9f4e0d5fdffdc5f554192">mbuf_begin_read</a> (mbuf);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// FIXME:  Check for sync</span></div>
<div class="line">    <span class="keywordflow">return</span> max_value_count - value_count;  <span class="comment">// value array is too small</span></div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">int</span> i;</div>
<div class="line">  <a class="code" href="structOmlValue.html">OmlValue</a>* val = values;</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; value_count; i++) {</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="marshal_8c.html#a000380a8534653b3027ec98e04e270c0">unmarshal_value</a>(mbuf, &amp;val[i]) == 0) {</div>
<div class="line">      <a class="code" href="log_8c.html#ac65b3f90d3228474368b2b48a488cd44">logwarn</a>(<span class="stringliteral">&quot;Could not unmarshal values %d of %d\n&quot;</span>, i, value_count);</div>
<div class="line">      <span class="keywordflow">return</span> -101;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> value_count;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_97aefd0d527b934f1d99a682da8fe6a9.html">lib</a></li><li class="navelem"><a class="el" href="dir_0ce1951afc5b1d55c9adea1f4ae57fb4.html">shared</a></li><li class="navelem"><a class="el" href="marshal_8h.html">marshal.h</a></li>
    <li class="footer">Generated on Thu Jun 25 2015 15:31:55 for oml2 by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.1.2 </li>
  </ul>
</div>
</body>
</html>
