<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>oml2: OML Measurement Stream Protocol (OMSP)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="oml_logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">oml2
   &#160;<span id="projectnumber">2.12.0pre.79-58cf-dirty</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('omsp.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">OML Measurement Stream Protocol (OMSP) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The OML Measurement Stream Protocol is used to describe and transport measurement tuples between Injection Points and Processing/Collection Points. All data injected in a Measurement Point (MP) (with <a class="el" href="omlc_8h.html#ac714a82b22dfcc34a6b6130e047f2ab7">omlc_inject</a>) is timestamped and sent to the destination as a Measurement Stream (MS).</p>
<p>The liboml2 provides an <a class="el" href="api.html">API</a> allowing to generate this MSs using this protocol and send them to a remote host, or store them in a local file.</p>
<p>Upon connection to a collection point, a set of <a class="el" href="headers_8c.html#omspheaders">headers</a> is first sent, describing the injection point (protocol version, name, application, local timestamp), along with the <a class="el" href="omsp.html#omspschema">schemata of</a>the transported MSs".</p>
<p>Once done, timestamped measurement data is serialised, either using a <a class="el" href="omsp.html#omspbin">binary encoding</a>, or a <a class="el" href="omsp.html#omsptext">text encoding</a>.</p>
<h1><a class="anchor" id="Generalities"></a>
Generalities</h1>
<p>There are 5 versions of the OML protocol.</p>
<ul>
<li>OMSP V1 was the initial protocol, inherited from OML (version 1!);</li>
<li>OMSP V2 introduced more precise types (<a href="http://git.mytestbed.net/?p=oml.git;a=shortlog;h=28daef3f">commit:28daef3f</a>), and was released with OML 2.4.0;</li>
<li>OMSP V3 introduced changes to the binary protocol to support blobs and, incidentally, longer marshalled packets (<a href="http://git.mytestbed.net/?p=oml.git;a=shortlog;h=6d8f0597">commit:6d8f0597</a>), and was released with OML 2.5.0;</li>
<li>OMSP V4 was introduced with OML 2.10.0; its main additions are the support for the definition of new Measurement Points (and Measurement Stream Schemas) at any time, and the ability to inject metadata.</li>
<li>OMSP V5 which is the current, most recent and implemented version (since OML 2.11); its main advantages are the support for vectors, and the introduction of a DOUBLE64_T IEEE 754 binary64 for more precision in representing doubles in binary mode (vectors only).</li>
</ul>
<p>The protocol is loosely modelled after HTTP. The client first start with a few <a class="el" href="headers_8c.html#omspheaders">textual headers</a>, then switches into either the <a class="el" href="omsp.html#omsptext">text</a> or <a class="el" href="omsp.html#omspbin">binary</a> protocol for the serialisation of tuples, following a previously advertised <a class="el" href="omsp.html#omspschema">schema</a>. Both modes include contextual information with each tuple. There is no feedback communication from the server.</p>
<p>The client first opens a connection to an OML server and sends a header followed by a sequence of measurement tuples. The header consists of a sequence of key/value pairs representing parameters valid for the whole connection, each terminated by a new line. The headers are also used to declare the schema following which measurement tuples will be streamed. The end of the header section is identified by an empty line. Each measurement tuple is then serialised following the mode selected in the headers. For the <a class="el" href="omsp.html#omsptext">text mode</a>, this is a series of newline-terminated strings containing tab-separated text-based serialisations of each element, while the <a class="el" href="omsp.html#omspbin">binary mode</a> encodes the data following a specific marshalling. Clients end the session by simply closing the TCP connection.</p>
<h2><a class="anchor" id="kv"></a>
Key/Value Parameters</h2>
<p>The connection is initially configured through setting the value of a few property, using a key/value model. The properties (and their keys) are the following.</p>
<ul>
<li><code>protocol</code>: OMSP version, as specified in this document. The <a class="el" href="oml2-server.html">oml2-server</a> currently supports 1&ndash;4;</li>
<li><code>domain</code> (<code>experiment-id</code> in V&lt;4): string identifying the experimental domain (should match <code>/[-_A-Za-z0-9]+/</code>);</li>
<li><code>start-time</code>: local UNIX time in seconds taken at the time the header is being sent (see <a href="http://linux.die.net/man/3/gettimeofday">gettimeofday(3)</a>), <a class="el" href="timestamps.html">the server uses this information to rebase timestamps within its own timeline</a>;</li>
<li><code>sender-id</code>: (<code>start_time</code> in V&lt;4): string identifying the source of this stream (should match <code>/[_A-Za-z0-9]+/</code>);</li>
<li><code>app-name</code>: string identifying the application producing the a measurements (should match <code>/[_A-Za-z0-9]+/</code>), in the storage backend, this may be used to identify specific measurements collections (e.g., tables in SQL);</li>
<li><code>content</code>: encoding of forthcoming tuples, can be either <code>binary</code> for the <a class="el" href="omsp.html#omspbin">binary protocol</a> or <code>text</code> for the <a class="el" href="omsp.html#omsptext">text protocol</a>.</li>
<li><code>schema</code>: describes the <a class="el" href="omsp.html#omspschema">schema of each measurement stream</a>.</li>
</ul>
<p>These parameters can only be set as part of the <a class="el" href="headers_8c.html#omspheaders">headers</a>, and are not valid once the server expects serialised measurements (V&lt;4).</p>
<p>Since V&gt;=4, key/value metadata can be sent along with tuples using the <a class="el" href="omsp.html#schema0">schema 0</a>, the rest of the key/value parameters presented here are all invalid in schema 0, and will be rejected by the server, <em>except</em> for key <code>schema</code> itself, allowing to (re)define schemata (<em>XXX</em> not including schema 0?).</p>
<h2><a class="anchor" id="timestamping"></a>
Time-stamping and book-keeping</h2>
<p>Regardless of the mode (<a class="el" href="omsp.html#omspbin">binary</a> or <a class="el" href="omsp.html#omsptext">text</a>), each measurement tuple is prefixed with some per-sample metadata.</p>
<p>Prior to serialising tuples according to their schema, three elements are inserted.</p>
<ul>
<li><code>timestamp</code>: a <em>double</em> timestamp in seconds relative to the <code>start-time</code> sent in the headers, <a class="el" href="timestamps.html">the server uses this information to rebase timestamps within its own timeline</a>;</li>
<li><code>stream_id:</code> an <em>integer</em> (marshalled specifically as a <code>uint8_t</code> in <a class="el" href="omsp.html#omspbin">binary mode</a>) indicating which previously defined schema this tuple follows;</li>
<li><code>seq_no:</code> an <em>int32</em> monotonically increasing sequence number in the context of this measurement stream.</li>
</ul>
<p>The order of these fields varies depending on the mode (<a class="el" href="omsp.html#omsptext">text</a> or <a class="el" href="omsp.html#omspbin">binary</a>).</p>
<h1><a class="anchor" id="omspbin"></a>
OMSP Binary Marshalling</h1>
<p>Marshalling is done directly into Mbuffers. A marshalled packet is structured as follows.</p>
<p>A header is first populated using <a class="el" href="marshal_8c.html#abf2845a176c08dbf690333177c8d2327">marshal_init()</a>, depending on the expected length. Both headers start with a double <a class="el" href="marshal2_8c.html#adb06558fc1b7d94db791ac81ac7749d1">SYNC_BYTE</a>.</p>
<p>A short header (<a class="el" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0aa98d5a2a2fd99f1cea2d4f90ece79cf49">OMB_DATA_P</a>), created by marshal_header_short(), is 5 bytes long. </p>
<pre class="fragment">0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+---------------+---------------+---------------+---------------+
|   SYNC_BYTE   |   SYNC_BYTE   |  OMB_DATA_P   |   msg-len-H   |
+---------------+---------------+---------------+---------------+
|   msg-len-L   |
+-------+-------+--
</pre><p>A long header (<a class="el" href="marshal_8h.html#aae2cbd51c9149df19ecd8e790db4ab0aaa3c47b159216a0127bcfea4f07c4a693">OMB_LDATA_P</a>), created by marshal_header_long(), allows two more bytes for the length. </p>
<pre class="fragment">0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+---------------+---------------+---------------+---------------+
|   SYNC_BYTE   |   SYNC_BYTE   |  OMB_LDATA_P  |   msg-len-HH  |
+---------------+---------------+---------------+---------------+
|   msg-len-HL  |   msg-len-LH  |   msg-len-LL  |
+---------------+---------------+---------------+--
</pre><p>This header is followed by metadata about its content, in the form of one byte indicating the number of measuments, and one the MS number (identifying the schema). The former is is updated at the end, by <a class="el" href="marshal_8c.html#a0c0615d0abcd3673b56b0c7f68076895">marshal_finalize()</a>, that function also takes care of promoting a short header to a long one if too much data was written into the packet. </p>
<pre class="fragment">             --+---------------+---------------+-
               |   num-meas    |   ms-index    |
             --+---------------+---------------+-
</pre><p>Then, num-meas marshalled values follow, respecting the schema defined by ms-index. The values are marshalled after a one-byte header identifying their type (OmlValueT).</p>
<p>The first two values are always a 32-bit integer representing the message sequence number, and a double representing the injection timestamp. <a class="el" href="marshal_8c.html#a66202b0ff17fc0381752edbfe6fef312">marshal_measurements()</a> should be called to add these two elements. Then, <a class="el" href="marshal_8c.html#a8ed4743985ce5ef8d39b45a8155e2555">marshal_values()</a> is used to marshall the array of <a class="el" href="structOmlValue.html">OmlValue</a>; it marshalls each of the with <a class="el" href="marshal_8c.html#ad6d9ad2684cedac88e911da72a19dc0c">marshal_value()</a>.</p>
<p>32-bit integers (<a class="el" href="marshal2_8c.html#a2251891f2e0a2db27ca4c6507d3f4040">INT32_T</a> and <a class="el" href="marshal2_8c.html#a6bcb89102f0baaa6be3d8d140b2dc866">UINT32_T</a>; and longs, <a class="el" href="marshal2_8c.html#a95f0d5df544261dab0fd0dcc5063de1f">LONG_T</a>) are put on the wire verbatim, in network byte order. </p>
<pre class="fragment">--+---------------+---------------+---------------+---------------+
  |  (U)INT32_T   |  int-byte-HH  |  int-byte-HL  |  int-byte-LH  |
--+---------------+---------------+---------------+---------------+
  |  int-byte-LL  |
  +---------------+--
</pre><p>The same goes for 64-bit integers (<a class="el" href="marshal2_8c.html#afb3891492b67fa5ded53824df675ae9b">INT64_T</a> and <a class="el" href="marshal2_8c.html#a8065a16ba5bd6bb2bd861936a87b31c3">UINT64_T</a>). GUIDs, introduced with OMSPv4, are marshalled in the same way, but use the <a class="el" href="marshal2_8c.html#a06c2c3d86fd6e81c65fa34777944f495">GUID_T</a> type. </p>
<pre class="fragment">--+---------------+---------------+---------------+---------------+
  |  (U)INT64_T   |  int-byte-HHH |  int-byte-HHL |  int-byte-HLH |
--+---------------+---------------+---------------+---------------+
  |  int-byte-HLL |  int-byte-LHH |  int-byte-LHL |  int-byte-LLH |
  +---------------+---------------+---------------+---------------+
  |  int-byte-LLL |
  +---------------+--
</pre><p>Doubles (<a class="el" href="marshal2_8c.html#a9290324f1f88b0f007de36d523d8cf3a">DOUBLE_T</a>) are represented with a 4-byte mantissa <img class="formulaInl" alt="$M$" src="form_7.png"/> and a one-byte exponent <img class="formulaInl" alt="$x$" src="form_8.png"/>, so that <img class="formulaInl" alt="$v=\frac{2^xM}{2^{30}}$" src="form_9.png"/>. In case the conversion fails, <a class="el" href="marshal2_8c.html#a05c4e15b9701b28975effde191bc9bf6">DOUBLE_NAN</a> is used as a type instead of <a class="el" href="marshal2_8c.html#a9290324f1f88b0f007de36d523d8cf3a">DOUBLE_T</a>. </p>
<pre class="fragment">--+---------------+---------------+---------------+---------------+
  |   DOUBLE_T    |  mant-byte-HH |  mant-byte-HL |  mant-byte-LH |
--+---------------+---------------+---------------+---------------+
  |  mant-byte-LL |   exponent    |
  +---------------+---------------+--
</pre><p>Strings (<a class="el" href="marshal2_8c.html#a64b41f937ac6a39ee0c32adecfa606dd">STRING_T</a>) and blobs (<a class="el" href="marshal2_8c.html#a2be536a5a6e8f0b613f766f04743581d">BLOB_T</a>) are serialised as bytes, with the second byte (i.e., first after the type), being their length. </p>
<pre class="fragment">--+---------------+---------------+---------------+---------------+
  |STRING_T|BLOB_T|       n       |   1st byte    |               |
--+---------------+---------------+---------------+---------------+
  |               |              ...              |               |
  +---------------+---------------+---------------+---------------+
  |              ...              |   nth byte    |
  +---------------+---------------+---------------+--
</pre><p>Boolean values are only encoded as one byte, with a different type depending on there truth value (<a class="el" href="marshal2_8c.html#a7e5ce4a4afe3c8c5e6a166a98c73bf49">BOOL_FALSE_T</a> or <a class="el" href="marshal2_8c.html#aaaece6ec7d7273c485301e9b4a88c27e">BOOL_TRUE_T</a>). They were introduced with OMSPv4. </p>
<pre class="fragment">--+---------------+--
  |  BOOL_xxx_T   |
--+---------------+--
</pre><p>Vectors (<a class="el" href="marshal2_8c.html#a1f6327298a81a863946fc71c15f75c1d">VECTOR_T</a>) are represented by specifying the type of the vector elements and then the size of the vector (a sixteen bit unsigned integer in network byte order) and followed by the vector of values themselves. Vectors were introduced in OMSPv5.</p>
<p>The vector elements are marshalled depending on the their type. For vectors of integers of INT32_T or (U)INT32_T the elements are packed in network-byte order as shown below: </p>
<pre class="fragment">--+---------------+-----------------+---------------+---------------+
  |   VECTOR_T    |   (U)INT32_T    |      n-H      |      n-L      |
--+---------------+-----------------+---------------+---------------+
  |int[0]-byte-HH |int[0]-byte-HL   |int[0]-byte-LH |int[0]-byte-LL |
  +---------------+-----------------+---------------+---------------+--
  |int[1]-byte-HH |int[1]-byte-HL   |int[1]-byte-LH |int[1]-byte-LL |
  +---------------+-----------------+---------------+---------------+--
</pre><p>Similarly for the <a class="el" href="marshal2_8c.html#afb3891492b67fa5ded53824df675ae9b">INT64_T</a> and <a class="el" href="marshal2_8c.html#a8065a16ba5bd6bb2bd861936a87b31c3">UINT64_T</a> the elements are packed in network byte order (i.e., with the most significant octet first).</p>
<p>For vectors of boolean values the vector elements are represented by a one-octet values which must be either <a class="el" href="marshal2_8c.html#aaaece6ec7d7273c485301e9b4a88c27e">BOOL_TRUE_T</a> or <a class="el" href="marshal2_8c.html#a7e5ce4a4afe3c8c5e6a166a98c73bf49">BOOL_FALSE_T</a>. </p>
<pre class="fragment">--+---------------+-----------------+---------------+---------------+
  |   VECTOR_T    |     BOOL_T      |      n-H      |      n-L      |
--+---------------+-----------------+---------------+---------------+
  |    bool[0]    |     bool[1]     |    bool[2]    |    bool[3]    |
  +---------------+-----------------+---------------+---------------+
  |    bool[4]    |
  +---------------+--
</pre><p>For vectors of double an IEEE 754 binary64 value is transferred and we require that the byte ordering within that value is in network byte order (IEEE 754 does not specify byte ordering but <a href="https://en.wikipedia.org/wiki/Endianness#Floating-point_and_endianness">the Wikipedia suggests that it is reasonable to assume that</a>, for a given host, the endian-ness of doubles is the same as for integers). </p>
<pre class="fragment">--+---------------+-----------------+---------------+---------------+
  |   VECTOR_T    |   DOUBLE64_T    |      n-H      |      n-L      |
--+---------------+-----------------+---------------+---------------+
  |dbl[0]-MS-byte |  dbl[0]-byte-7  | dbl[0]-byte-6 | dbl[0]-byte-5 |
  +---------------+-----------------+---------------+---------------+--
  | dbl[0]-byte-4 |  dbl[0]-byte-3  | dbl[0]-byte-2 |dbl[0]-LS-byte |
  +---------------+-----------------+---------------+---------------+--
</pre><dl class="section see"><dt>See Also</dt><dd><a class="el" href="marshal2_8c.html#abf2845a176c08dbf690333177c8d2327">marshal_init</a>, marshal_header_short, marshal_header_long, <a class="el" href="marshal2_8c.html#a66202b0ff17fc0381752edbfe6fef312">marshal_measurements</a>, <a class="el" href="marshal2_8c.html#a8ed4743985ce5ef8d39b45a8155e2555">marshal_values</a>, <a class="el" href="marshal2_8c.html#a0c0615d0abcd3673b56b0c7f68076895">marshal_finalize</a></dd></dl>
<h1><a class="anchor" id="omspschema"></a>
OMSP Schema Specification</h1>
<p>Schemas describe the name, type and order of the values defining a sample in a measurement stream.</p>
<p>Schema declarations are a space-delimited concatenation sequence of name/type pairs. The name and type in each pair are separated by a colon <code>:</code>.</p>
<p>Valid types in OMSP the following.</p>
<ul>
<li><code>int32</code> (V&gt;=1)</li>
<li><code>uint32</code> (V&gt;=2)</li>
<li><code>int64</code> (V&gt;=2)</li>
<li><code>uint64</code> (V&gt;=2)</li>
<li><code>double</code> (V&gt;=2)</li>
<li><code>string</code> (V&gt;=1)</li>
<li><code>blob</code> (V&gt;=3)</li>
<li><code>guid</code> (V&gt;=4)</li>
<li><code>bool</code> (V&gt;=4)</li>
<li><code>guid</code> (V&gt;=4)</li>
</ul>
<p>OMSP also supports vector types (V&gt;=5), in the form <code>[t]</code> where t is any valid type except for string, blob, or guid.</p>
<p>Additionally, some deprecated values are kept for backwards compatibility, and interpreted in the latest version as indicated. They should not be used in new implementations.</p>
<ul>
<li><code>int</code> (V&lt;2, mapped to <code>int32</code> in V&gt;=3)</li>
<li><code>integer</code> (V&lt;2, mapped to <code>int32</code> in V&gt;=3)</li>
<li><code>long</code> (V&lt;2, clamped and mapped to <code>int32</code> in V&gt;=3)</li>
<li><code>float</code> and <code>real</code> (V&lt;2, mapped to <code>double</code> in V&gt;=3)</li>
</ul>
<p>A full schema also has a name, prepended to its definition and separated by a space. This must consist of only alpha-numeric characters and underscores and must start with a letter or an underscore, i.e., matching <code>/[_A-Za-z][_A-Za-z0-9]/</code>. The same rule applies to the names of the elements of the schema. Each schema is also associated with a numeric MS identifier, which is used to link it to all associated measurement tuples later sent. In <a href="https://en.wikipedia.org/wiki/Augmented_Backus%E2%80%93Naur_Form">ABNF</a>, a schema is defined as follows. </p>
<pre class="fragment">schema = ms-id ws schema-name ws field-definition 0*63(ws field-definition)

ms-id = integer
schema-name = 1*letter-or-decimal-or-underscore
field-definition = field-name ":" oml-type

field-name = 1*letter-or-decimal-or-underscore
oml-type = current-oml-type / vector-type / deprecated-oml-type

current-oml-type = vectorisable-oml-type / "string" / "blob" / "guid"
vectorisable-oml-type = "int32" / "uint32" / "int64" / "uint64" / "double" / "bool" / "guid"
vector-type = "[" vectorisable-oml-type "]"
deprecated-oml-type = "int" / "integer" / "long" / "float"

integer = 1*decimal
letter-or-decimal-or-underscore = letter / decimal / "_"

decimal = "0"-"9"
letter = "a"-"z" / "A"-"Z"
ws = " "
</pre><p>Each client should number its measurement streams sequentially starting from 1 (not 0), and prepend that number to their schema definition. It will later be used to label tuples following this schema, and allow to group them together in the storage backend.</p>
<h2><a class="anchor" id="omspschemaexample"></a>
Example</h2>
<p>1 generator_sin label:string phase:double value:double 2 generator_lin label:string counter:uint64 3 generator_spectrum label:string distribution:[uint64]</p>
<h2><a class="anchor" id="schema0"></a>
Schema 0 (OMSP V&gt;=4)</h2>
<p>Schema 0 is a specific hard-coded stream for metadata. Its core elements are two fields, named <code>key</code> and <code>value</code>. Data from this stream is stored in the same way as any other data, but its semantic is different in that it only describes and adds information about other measurement streams. Metadata follows an Subject-Key-Value model where the key/value pair is an attribute of a specific subject. Subjects are expressed in dotted notation. The default subject, <code>.</code>, is the experiment itself. At the second level are schemas, and their fields at the third level (e.g., <code>.a</code> refers to all of schema <code>a</code>, while <code>.a.f</code> refers only to its field <code>f</code>).</p>
<p>To support this, schema 0 is therefore: </p>
<pre class="fragment">0 _experiment_metadata subject:string key:string value:string
</pre><p>On the <a class="el" href="oml2-server.html">server side</a>, everything gets stored in the <code>_experiment_metadata</code> table. However, additional processing might happen. For example, if key <code>schema</code> is defined for subject <code>.</code> (the experiment root), a new schema is defined at the collection point so new MSs can be sent.</p>
<p>In case of reconnection, it is up to the client MUST re-send the headers headers, as well as all schema0 metadata with key <code>schema</code> (see <a class="el" href="api.html">OML User-visible API</a>). Other metadata MAY be restransmitted as well. The server MAY store duplicate metadata if this happens.</p>
<h1><a class="anchor" id="omsptext"></a>
OMSP Text Protocol</h1>
<p>The text protocol is meant to simplify sourcing of measurement streams from applications written in languages which are not supported by the OML library or where the OML library is considered too heavy. It is primarily envisioned for low-volume streams which do not require additional client side filtering. There are native instrumentation (liboml2, <a href="https://rubygems.org/gems/oml4r">OML4R</a>, <a href="https://pypi.python.org/pypi/oml4py/">OML4Py</a>) but implementing the protocol from scratch in any language of choice should be very straight forward.</p>
<p>The text protocol simply serialises metadata and values of a tuple as one newline-terminated (<code>\n</code>), tab-separated (<code>\t</code>) line per sample.</p>
<p>The textual representation of the types defined above is as follows:</p>
<ul>
<li>All numeric types are represented as <em>decimal</em> strings suitable for <a href="http://linux.die.net/man/3/strtod">strtod(3) and siblings</a>; using <a href="http://linux.die.net/man/3/snprintf">snprintf(3)</a>, with the relevant <a href="http://linux.die.net/man/0/inttypes.h"><code>PRIuN</code> format</a> if needed, should provide good functionality (at least V&gt;=2; as of V&lt;=3, there is no guarantee for the interpretation of non-decimal notations)</li>
<li>Strings are represented directly (except for the nil-terminator) but some character values require special processing;<ul>
<li>As the text protocol assigns special meaning to the tab and newline characters they would confused the parser if they appeared verbatim. To avoid this a simple backslash encoding is used: tab characters are represented by the <em>string</em> "&lt;tt&gt;\\t&lt;/tt&gt;", newlines by the <em>string</em> "&lt;tt&gt;\\n&lt;/tt&gt;" and backslash itself by the <em>string</em> "&lt;tt&gt;\\\\&lt;/tt&gt;" (V&gt;=4; no other backslash expansion is made <em>TODO</em> what if <code>\whatever</code> is input?);</li>
</ul>
</li>
<li>BLOBs are encoded using <a href="https://tools.ietf.org/html/rfc4648#section-4">BASE64 encoding</a> and the resulting string is sent. No line breaks are permitted within the BASE64-encoded string (V&gt;=4);</li>
<li>GUIDs are globally unique IDs used to link different measurements. These are treated as large numbers and thus represented as UINT64, unsigned decimal strings. (V&gt;=4);</li>
<li>booleans are encoded as any case-insensitive stem of FALSE or TRUE (e.g., <code>fAL</code>, <code>trUe</code>, but generally <code>F</code> and <code>T</code> will suffice), being respectively False or True; any other value is considered True, <em>including '0'</em> (V&gt;=4);</li>
<li>vectors are encoded as a <em>space-separated</em> list in which the first element is the size of the vector followed by the vector elements themselves. Each vector entry is encoded according to its type as above. (V&gt;=5).</li>
</ul>
<h2><a class="anchor" id="omsptextexample"></a>
Example</h2>
<p>This example shows two streams, matching the <a class="el" href="omsp.html#omspschemaexample">schema</a> and <a class="el" href="headers_8c.html#omspheadersexample">headers</a> examples. </p>
<pre class="fragment">0.903816 2 0 sample-1  1
0.903904 1 0 sample-1  0.000000  0.000000
1.903944 2 1 sample-2  2
1.903961 1 1 sample-2  0.628319  0.587785
2.460049 2 3 sample-3  3
2.460557 1 3 sample-3  1.256637  0.951057
3.461064 2 4 sample-4  4
3.461103 1 4 sample-4  1.884956  0.951056
</pre><p><em>TODO</em>: Add example string and blob </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Thu Jun 25 2015 15:31:56 for oml2 by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.1.2 </li>
  </ul>
</div>
</body>
</html>
