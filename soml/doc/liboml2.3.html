<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.7" />
<title>liboml2(3)</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

tt {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
}

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

.monospaced {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
}

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>liboml2(3)</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="_name">NAME</h2>
<div class="sectionbody">
<div class="paragraph"><p>liboml2 - OML2 client library</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_synopsis">SYNOPSIS</h2>
<div class="sectionbody">
<div class="verseblock">
<pre class="content"><strong>#include &lt;oml2/omlc.h&gt;</strong></pre>
<div class="attribution">
</div></div>
<div class="verseblock">
<pre class="content"><em>int</em>    <strong>omlc_init</strong>(<em>const char</em> *appname, <em>int</em> *pargc, <em>const char</em> *argv[], <em>o_log_fn</em> log_fn);<br />
<em>OmlMP</em>* <strong>omlc_add_mp</strong>(<em>const char</em> *name, <em>OmlMPDef</em> *definition);<br />
<em>int</em>    <strong>omlc_start</strong>(<em>void</em>);<br />
<em>void</em>   <strong>omlc_inject</strong>(<em>OmlMP</em> *mp, OmlValueU *values);<br />
<em>int</em>    <strong>omlc_inject_metadata</strong>(<em>OmlMP</em>* mp, <em>const char</em>* key, <em>const OmlValueU</em>* value, <em>OmlValueT</em> type, <em>const char</em>* fname);<br />
<em>oml_guid_t</em> <strong>omlc_guid_generate</strong>();<br />
<em>int</em>    <strong>omlc_close</strong>(<em>void</em>);<br /></pre>
<div class="attribution">
</div></div>
<div class="verseblock">
<pre class="content"><strong>#define OML_FROM_MAIN</strong> <em>// enable oml_register_mps() and necessary storage; only in one file</em>
<strong>#include "APPNAME_oml.h"</strong></pre>
<div class="attribution">
</div></div>
<div class="verseblock">
<pre class="content"><em>inline void</em> <strong>oml_register_mps</strong>();<br />
<em>inline void</em> <strong>oml_inject_MPNAME</strong>(<em>OmlMP</em>* mp, &#8230;);<br /></pre>
<div class="attribution">
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_description">DESCRIPTION</h2>
<div class="sectionbody">
<div class="paragraph"><p><strong>liboml2</strong> is the client library for OML2.  It provides an API for
application writers to collect measurements from their applications via
user-defined <em>Measurement Points</em> (MPs).  It also provides a flexible
filtering and collection mechanism that allows application users to
customise how measurements are processed and stored by an OML-enabled
application.</p></div>
<div class="paragraph"><p>This man page summarises the API.  Each function in the API also has its
own detailed man page.  To learn how to configure an application that
uses the API from the command line, see <a href="liboml2.1.html">liboml2(1)</a>.  To learn
about the external configuration file that <strong>liboml2</strong> can use, see
<a href="liboml2.conf.5.html">liboml2.conf(5)</a>.</p></div>
<div class="paragraph"><p>A programmer who wants to use <strong>liboml2</strong> to perform measurements in their
application must first decide what to measure. OML lets the programmer
first define <em>MPs</em> and then inject measurement tuples into them. The
core of the library then performs filtering on the injected measurements
and, at predefined times, emits the filtered samples to either a local
file or a measurement server (see <a href="oml2-server.1.html">oml2-server(1)</a>).</p></div>
<div class="paragraph"><p>A program using OML can therefore be divided into two stages:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Initialisation
</dt>
<dd>
<p>
First the library is initialised and measurement points
are defined.
</p>
</dd>
<dt class="hdlist1">
Measurement
</dt>
<dd>
<p>
Second, the filters are constructed and enabled by calling
<a href="omlc_start.3.html">omlc_start(3)</a>. Measurement can proceed, with as many calls to
<a href="omlc_inject.3.html">omlc_inject(3)</a> as required.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>In some cases, it is necessary to occasionaly inject metadata about one
<em>MP</em>, or one of its fields (e.g., unit or quality index of the current
samples). The <a href="omlc_inject.3.html">omlc_inject_metadata(3)</a> function
can be used for this purpose.</p></div>
<div class="paragraph"><p>It is also sometimes necessary to link measurement tuples together
(e.g., the destination IP of a packet in a network <em>MP</em> and its
transport protocol and port in a transport <em>MP</em>). OML supports the
concept of a Globally Unique ID (GUID) as a data type. It is a random
identifier which can be generated on demand using the
<strong>omlc_guid_generate</strong>() function. It returns an <em>oml_guid_t</em>, which can
then be injected into any <em>MP</em> with a field of type <em>:guid</em> (see
<a href="oml2-scaffold.1.html">oml2-scaffold(1)</a>). In case a GUID is not required for the
injection of a specific tuple (i.e., no linkage to other measurements),
the special value <em>OMLC_GUID_NULL</em> can be used.</p></div>
<div class="paragraph"><p>For convenience, it is recommended to use <a href="oml2-scaffold.1.html">oml2-scaffold(1)</a> to
generate helper functions for MP registration and injection
(<strong>oml_register_mps</strong> and <strong>oml_inject_MPNAME</strong>) which take care of
preparing the data and passing it to <a href="omlc_add_mp.3.html">omlc_add_mp(3)</a> and
<a href="omlc_inject.3.html">omlc_inject(3)</a>, respectively.</p></div>
<div class="paragraph"><p>It is also best to call <a href="omlc_close.3.html">omlc_close(3)</a> to shut down the
measurement library cleanly once measurement tasks are completed, such
as when the application is terminating.</p></div>
<div class="sect2">
<h3 id="_initialisation">Initialisation</h3>
<div class="paragraph"><p>When the application starts up, the programmer should make a call to
<a href="omlc_init.3.html">omlc_init(3)</a> to initialise <strong>liboml2</strong>.  The function accepts a
name for the application itself, together with the executable&#8217;s command
line arguments (the C <strong>main</strong>() function&#8217;s <strong>argc</strong> and <strong>argv</strong> parameters),
and a fourth argument which is not widely used and can safely be set to
NULL:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>#include &lt;oml2/omlc.h&gt;

int main(int argc, const char **argv)
{
  int result = omlc_init ("MyOmlClient", &amp;argc, argv, NULL);
  if (result == -1) {
    fprintf (stderr, "Could not initialise OML\n");
    exit (1);
  } else if (result == 1) {
    fprintf (stderr, "OML was disabled by the user, exiting\n");
    exit (0);
  }

  /* Do application stuff... */

  return 0;
}</tt></pre>
</div></div>
<div class="paragraph"><p>The <a href="omlc_init.3.html">omlc_init(3)</a> function gathers configuration information from
the command line arguments, the environment, and possibly an external
configuration file, and sets internal configuration options of the
library.  It removes any command line options that it recognises, so
that the application itself does not get confused when it tries to
interpret the command line.  All OML options start with the prefix
<strong>--oml-</strong>.  An application should call <a href="omlc_init.3.html">omlc_init(3)</a> <em>before</em>
running its own command line option parser.</p></div>
<div class="paragraph"><p>After initialising the library, the programmer must define the
application&#8217;s <em>MPs</em>.  Each <em>MP</em> is defined as a typed tuple.  OML
supports basic integer types, a double-precision floating point type,
a string type and a blob type.</p></div>
<div class="sect3">
<h4 id="generated-register">Using the registration helper</h4>
<div class="paragraph"><p>This is the recommended method as it is easiest.</p></div>
<div class="paragraph"><p>The <a href="oml2-scaffold.1.html">oml2-scaffold(1)</a> tool can generate the definition of the
desired measurement points, and a single registration function as part
of the OML header (<em>APPNAME_oml.h</em> generated with the <strong>--oml</strong> flag).
The registration function, <strong>oml_register_mps</strong>(), declares theses MPs to
the library. It takes no argument, and initialises a structure
<strong>g_oml_mps_APPNAME</strong> which contains named pointer to each measurement
point. Taking the example from <a href="oml2-scaffold.1.html">oml2-scaffold(1)</a>,</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>defApplication('oml:man:foo', 'foo') do |app|
  # ... Some needed code skipped here ...
  app.defMeasurement("memory") do |mp|
    # ... Some more code skipped here ...
  end

  app.defMeasurement("cpu") do |mp|
    # ... Some more code skipped here ...
  end
end</tt></pre>
</div></div>
<div class="paragraph"><p>The <strong>oml_register_mps</strong>() function declares and initialises a structure
containing pointers to the <em>OmlMP*</em>. In this example, where the
application name is <em>foo</em>, it will be accessible as <em>g_oml_mps_foo</em>, and
the <em>OmlMP*</em> for <em>memory</em> and <em>cpu</em> as <em>g_oml_mps_foo&#8594;memory</em> and
<em>g_oml_mps_foo&#8594;cpu</em>, respectively.</p></div>
<div class="paragraph"><p>This function is made available conditionally from <em>APPNAME_oml.h</em>.
Indeed, it requires objects which need only be allocated once, and is
done at the same time. To make this function available, one must
<em>#define</em> <a href="http://linux.die.net/man/1/cpp">cpp(1)</a> macro <em>OML_FROM_MAIN</em> prior to the <em>#include</em>
statement for <em>APPNAME_oml.h</em>. This should be done <strong>only in file using
oml_register_mps()</strong>.</p></div>
</div>
<div class="sect3">
<h4 id="_registering_mps_manually">Registering MPs manually</h4>
<div class="paragraph"><p>In case some or more <em>MPs</em> cannot be known at compile time (e.g., a
plugin providing its own <em>MPs</em>), the auto-generated registration code
cannot be used. These <em>MPs</em> have to be defined and added manually in the
code. An <em>MP</em> definition is represented as an array of <em>OmlMPDef</em>
objects, terminated by a NULL object, as shown here:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>OmlMPDef mp_def [] =
{
  { "source", OML_UINT32_VALUE },
  { "destination", OML_UINT32_VALUE },
  { "length", OML_UINT32_VALUE },
  { "weight", OML_DOUBLE_VALUE },
  { "protocol", OML_STRING_VALUE },
  { NULL, (OmlValueT)0 }
};</tt></pre>
</div></div>
<div class="paragraph"><p>The first member of the <em>OmlMPDef</em> struct is the name of the field of
the <em>MP</em> that it represents.  The second member is its type.  The name
appears in the schema for the local file storage, and as part of the
database column name for the database created by <a href="oml2-server.1.html">oml2-server(1)</a>.</p></div>
<div class="paragraph"><p>To register the <em>MP</em> definition with <strong>liboml2</strong>, the programmer must call
<a href="omlc_add_mp.3.html">omlc_add_mp(3)</a>:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>OmlMP* mp = omlc_add_mp ("packet_info", mp_def);

if (mp == NULL) {
 fprintf (stderr, "Error: could not register Measurement Point 'packet_info'");
 exit (1);
}</tt></pre>
</div></div>
<div class="paragraph"><p>This function returns a handle to the internal <em>MP</em> object, which should
be used in subsequent calls to <a href="omlc_inject.3.html">omlc_inject(3)</a>, and should be
treated as opaque.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_measurement">Measurement</h3>
<div class="paragraph"><p>Once all measurement points have been defined and created using calls to
<a href="omlc_add_mp.3.html">omlc_add_mp(3)</a>, the programmer must start the measurement
collection process by calling <a href="omlc_start.3.html">omlc_start(3)</a>.  This call creates
the internal filters according to the current configuration options, and
starts the filter output sampling threads for 'interval' style filters
(for more information see <a href="liboml2.conf.5.html">liboml2.conf(5)</a>).  Once
<a href="omlc_start.3.html">omlc_start(3)</a> has been called, no more <em>MPs</em> can be added:
further calls to <a href="omlc_add_mp.3.html">omlc_add_mp(3)</a> will be ignored.  Conversely,
once <a href="omlc_start.3.html">omlc_start(3)</a> has been called, calls can be made to perform
measurements, and inject there results into the OML reporting path.</p></div>
<div class="sect3">
<h4 id="_using_injection_helpers">Using injection helpers</h4>
<div class="paragraph"><p>This is the recommended method as it is easiest and much less error-prone. It
is also more future-proof as it shields the application from low-level API
changes.  These helpers also provide C-compiler type-checking and proper memory
management.</p></div>
<div class="paragraph"><p>The <a href="oml2-scaffold.1.html">oml2-scaffold(1)</a> tool can generate helper injection
functions as part of the OML header (<strong>--oml</strong>). Their prototype is  of
the form <strong>oml_inject_MPNAME</strong>(<em>OmlMP*</em> mp, &#8230;), where <strong>MPNAME</strong> is the
name of the <em>MP</em> that is passed as <strong>mp</strong>. The remaining arguments are
C-typed variables constituting the sample to be injected in the <em>MP</em>.</p></div>
<div class="paragraph"><p>Continuing with the <a href="#generated-register">auto-generated example from above</a>,
injecting a sample in the <em>memory</em> <em>MP</em> can be done as</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>oml_inject_memory(g_oml_mps_foo-&gt;memory, ram, total, free, used, free_percent, used_percent);</tt></pre>
</div></div>
<div class="paragraph"><p>where <em>ram</em>, <em>total</em>, <em>free</em>, <em>used</em>, <em>free_percent</em> and <em>used_percent</em> are
assumed to be variables updated by the rest of the application code.</p></div>
</div>
<div class="sect3">
<h4 id="manual-inject">Implementing injection code manually</h4>
<div class="paragraph"><p>The <a href="omlc_inject.3.html">omlc_inject(3)</a> function accepts an <em>MP</em> handle and a vector
of <a href="OmlValueU.3.html">OmlValueU(3)</a> objects. These values MUST always be initialised
first with <a href="OmlValueU.3.html">omlc_zero(3)</a> or <a href="OmlValueU.3.html">omlc_zero_array(3)</a>. The
programmer should first load up the vector with new values to be
measured using the <strong>omlc_set_</strong>* macros, and then call
<a href="omlc_inject.3.html">omlc_inject(3)</a>. If string or blobs were affected to some of the
<a href="OmlValueU.3.html">OmlValueU(3)</a>, these have to be reset with
<a href="OmlValueU.3.html">omlc_reset_string(3)</a> or <a href="OmlValueU.3.html">omlc_reset_blob(3)</a> so any
allocated memory is properly cleared. For instance, here is how a
measurement injection might look for the <em>MP</em> definition above:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>...

OmlMP *mp = omlc_add_mp("packet_info", mp_def);

...

uint32_t source_id;
uint32_t destination_id;
uint32_t packet_length;
double weight;
char *protocol;

...

/* Some application-specific code to obtain new values for the variables above */

...

{
   OmlValueU values[5];

   omlc_zero_array(values, 5);

   omlc_set_uint32 (values[0], source_id);
   omlc_set_uint32 (values[1], destination_id);
   omlc_set_uint32 (values[2], packet_length);
   omlc_set_double (values[3], weight);
   omlc_set_string (values[4], protocol);

   omlc_inject (mp, values);

   omlc_reset_string (values[4]); /* Free potentially allocated space */
}</tt></pre>
</div></div>
<div class="paragraph"><p>The vector must be loaded with values in the same order as the original
definition of the fields of the <em>MP</em> in the call to
<a href="omlc_add_mp.3.html">omlc_add_mp(3)</a>. The call to <a href="omlc_inject.3.html">omlc_inject(3)</a> can be
repeated as many times as the program wants to make measurements for a
given <em>MP</em>.</p></div>
<div class="sect4">
<h5 id="_oml_types">OML Types</h5>
<div class="paragraph"><p>OML uses an opaque data structure, <a href="OmlValueU.3.html">OmlValueU(3)</a> to store
arbitrary data types. This structure can contain chunks of allocated
memory and should therefore be properly initialised before use (with the
<a href="OmlValueU.3.html">omlc_zero(3)</a> and <a href="OmlValueU.3.html">omlc_zero_array(3)</a> functions.</p></div>
<div class="paragraph"><p>OML defines the following types and setters:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>OML_INT32_VALUE</em> (<a href="OmlValueU.3.html">omlc_set_int32(3)</a>)
</p>
</li>
<li>
<p>
<em>OML_UINT32_VALUE</em> (<a href="OmlValueU.3.html">omlc_set_uint32(3)</a>)
</p>
</li>
<li>
<p>
<em>OML_INT64_VALUE</em> (<a href="OmlValueU.3.html">omlc_set_int64(3)</a>)
</p>
</li>
<li>
<p>
<em>OML_UINT64_VALUE</em> (<a href="OmlValueU.3.html">omlc_set_uint64(3)</a>)
</p>
</li>
<li>
<p>
<em>OML_DOUBLE_VALUE</em> (<a href="OmlValueU.3.html">omlc_set_double(3)</a>)
</p>
</li>
<li>
<p>
<em>OML_STRING_VALUE</em> (<a href="OmlValueU.3.html">omlc_set_string(3)</a>, <a href="OmlValueU.3.html">omlc_reset_string(3)</a>)
</p>
</li>
<li>
<p>
<em>OML_BLOB_VALUE</em> (<a href="OmlValueU.3.html">omlc_set_blob(3)</a>, <a href="OmlValueU.3.html">omlc_reset_blob(3)</a>)
</p>
</li>
<li>
<p>
<em>OML_GUID_VALUE</em> (<a href="OmlValueU.3.html">omlc_set_guid(3)</a>)
</p>
</li>
<li>
<p>
<em>OML_BOOL_VALUE</em> (<a href="OmlValueU.3.html">omlc_set_bool(3)</a>)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Each of the first four integer types maps to an underlying equivalent
type from the C standard header <a href="http://linux.die.net/man/0/stdint.h">stdint.h(0)</a>.  These types should
be used in calls to the <strong>omlc_set_</strong>* macros.  They are:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>int32_t</em>
</p>
</li>
<li>
<p>
<em>uint32_t</em>
</p>
</li>
<li>
<p>
<em>int64_t</em>
</p>
</li>
<li>
<p>
<em>uint64_t</em>
</p>
</li>
</ul></div>
<div class="paragraph"><p>The <em>OML_DOUBLE_VALUE</em> type maps to an underlying C double.</p></div>
<div class="paragraph"><p>The <em>OML_STRING_VALUE</em> maps to a nil-terminated C string. Memory will be
dynamically allocated (or reused) when a value of this type is set to an
<a href="OmlValueU.3.html">OmlValueU(3)</a>.</p></div>
<div class="paragraph"><p>The <em>OML_BLOB_VALUE</em> maps to an arbitrary block of binary data, of a given
size. It is handled in a way similar to <em>OML_STRING_VALUE</em>, save for the
nil-termination and automatic size calculation.</p></div>
<div class="paragraph"><p>The <em>OML_GUID_VALUE</em> type can be used to create logical groups of
samples, either within the same <em>MP</em>, or across <em>MPs</em>. For example,
parameters from the IP and TCP headers of a TCP packet should be
reported in separate <em>MPs</em> (as not all IP packets have TCP payload).
However, it is desirable to link these tuples together. Adding an
<em>OML_GUID_VALUE</em> field in both <em>MPs</em>, which can be filled with the same
GUID returned <a href="liboml2.3.html">omlc_guid_generate(3)</a> would allow to
join the relevant information about this packet at a later time, during
analysis.  Similarly, if multiple samples in an <em>MP</em> belong to the same
logical group (e.g., an array), they can be linked using the same
mechanism, by adding an <em>OML_GUID_VALUE</em> field to that <em>MP</em>, and
generating a new <em>oml_guid_t</em> every time a new group needs to be
created. To fill <em>OML_GUID_VALUE</em> fields where grouping is not needed, a
default <em>NULL</em> value is available as <em>OMLC_GUID_NULL</em>.</p></div>
<div class="paragraph"><p>The <em>OML_BOOL_VALUE</em> simply encapsulate a boolean value. Anything that is
not 0 is assumed to be true. There is however no guarantee that a
non-zero boolean will retain the actual (integral) value which was used
to set it, beyond its logical truth value.</p></div>
<div class="paragraph"><p><strong>liboml2</strong> currently also defines an <em>OML_LONG_VALUE</em> that maps to a C
<em>long</em> type, but this type is deprecated because it can change size
between 32-bit and 64-bit platforms. It will be removed from the API at
some point in the future. The library internally clamps <em>OML_LONG_VALUE</em>
<em>MP</em> fields to the most positive and negative values that will fit in an
<em>int32_t</em> object before sending them to the <a href="oml2-server.1.html">oml2-server(1)</a> or a
local measurement file. <em>OML_LONG_VALUE</em> should not be used in new
applications.</p></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building">Building</h3>
<div class="paragraph"><p>Applications using <strong>liboml2</strong> must include the <em>-loml2</em> flag on the
linker command line to link against the client library.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="example">EXAMPLE</h2>
<div class="sectionbody">
<div class="paragraph"><p>The following is a fully-functional example application that counts from
1 to 1000 and outputs the value of the counter as an unsigned integer, a
string, and a double at each step:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;oml2/omlc.h&gt;

int main (int argc, const char **argv)
{
  int result = omlc_init ("Simple", &amp;argc, argv, NULL);
  if (result == -1) {
    fprintf (stderr, "Could not initialise OML\n");
    exit (1);
  } else if (result == 1) {
    fprintf (stderr, "OML was disabled by the user, exiting\n");
    exit (0);
  }

  OmlMPDef mp_def [] = {
    { "count", OML_UINT32_VALUE },
    { "count_str", OML_STRING_VALUE },
    { "count_real", OML_DOUBLE_VALUE },
    { NULL, (OmlValueT)0 }
  };

  OmlMP *mp = omlc_add_mp ("counter", mp_def);

  if (mp == NULL) {
    fprintf (stderr, "Error: could not register Measurement Point 'counter'");
    exit (1);
  }

  omlc_start();

  int i = 0;
  for (i = 0; i &lt; 1000; i++) {
    uint32_t count = (uint32_t)i;
    char count_str[16];
    double count_real = (double)i;
    OmlValueU values[3];

    omlc_zero_array(values, 3);

    snprintf(count_str, sizeof(count_str), "%d", i);

    omlc_set_uint32 (values[0], count);
    omlc_set_string (values[1], count_str);
    omlc_set_double (values[2], count_real);

    omlc_inject (mp, values);

    omlc_reset_string(values[1]);
  }


  omlc_close();

  return 0;
}</tt></pre>
</div></div>
<div class="paragraph"><p>The following command should be sufficient to compile this
program:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>$ gcc -o counter counter.c -loml2</tt></pre>
</div></div>
<div class="paragraph"><p>Here is an example command line to run this application with a default
set of filters:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>$ ./counter --oml-id myid --oml-domain count --oml-collect file:-</tt></pre>
</div></div>
<div class="paragraph"><p>The output from this command will appear on the terminal because we told
OML to use the standard output (<strong>--oml-collect file:-</strong>).  Here is what
it looks like:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>INFO   OML Client 2.x.y [OMSPv5] Copyright 2007-2014, NICTA
protocol: 5
domain: count
start-time: 1283160287
sender-id: myid
app-name: Counter
schema: 1 Counter_counter count:uint32 count_str:string count_real:double
content: text


0.797713        1       1       0       0       0.000000
0.797736        1       2       1       1       1.000000
0.797748        1       3       2       2       2.000000
0.797760        1       4       3       3       3.000000
0.797774        1       5       4       4       4.000000
0.797785        1       6       5       5       5.000000
0.797796        1       7       6       6       6.000000
...</tt></pre>
</div></div>
<div class="paragraph"><p>An easy way to create more complicated applications is to use
<a href="oml2-scaffold.1.html">oml2-scaffold(1)</a>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_porting_pre_2_9_applications">PORTING PRE-2.9 APPLICATIONS</h2>
<div class="sectionbody">
<div class="paragraph"><p>In between OML 2.8 and 2.9, a heavy refactoring of the lower layers
happened to better track the memory used, and reduce memory leaks.
Unfortunately, this change could not be hidden from the higher layers,
as the API was extended with the introduction of initialisers
destructors for <a href="OmlValueU.3.html">OmlValueU(3)</a> variables, with proper management
of dynamic memory allocation.</p></div>
<div class="paragraph"><p>The shared library&#8217;s version has been bumped from 0.8.1 to 9.0.0, so old
binaries could still work properly (on distributions supporting multiple
library versions, such as Debian). However, this means these old
binaries will not benefit from the new features of OML 2.9 onwards.</p></div>
<div class="paragraph"><p>Porting pre-2.9 instrumentations to OML 2.9 is however relatively easy.
Whenever <a href="OmlValueU.3.html">OmlValueU(3)</a>, or arrays thereof, are declared, they
MUST be properly initialised prior to any use. Not doing so might result
in cryptic segmentation faults, or weird ghostly data being collected.
Refer to <a href="#manual-inject">Implementing injection code manually</a> and the
<a href="#example">example</a> above to see where calls to
<a href="OmlValueU.3.html">omlc_zero(3)</a> (or
<a href="OmlValueU.3.html">omlc_zero_array(3)</a>), and
<a href="OmlValueU.3.html">omlc_reset_string(3)</a> and
<a href="OmlValueU.3.html">omlc_reset_blob(3)</a> should be added to your code.</p></div>
<div class="paragraph"><p>Additionally, omlc_set_const_string() is deprecated, as it did not have
much significance. The string is now always duplicated into separate
storage to ensure integrity regardless of how the instrumented
application manipulates its original data after injection.</p></div>
<div class="paragraph"><p>All new instrumentations should however avoid using
<a href="omlc_inject.3.html">omlc_inject(3)</a> directly, and rely on the code generation
capabilities of <a href="oml2-scaffold.1.html">oml2-scaffold(1)</a> instead. It is also recommended
that these changes be taken as an opportunity to port old applications
to <a href="oml2-scaffold.1.html">oml2-scaffold(1)</a> too.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_bugs">BUGS</h2>
<div class="sectionbody">
<div class="paragraph"><p>If a problem you are experiencing is not addressed in the FAQ
(<a href="http://oml.mytestbed.net/projects/oml/wiki/FAQ_and_Support">http://oml.mytestbed.net/projects/oml/wiki/FAQ_and_Support</a>) nor already
present in the list of know bugs
(<a href="http://oml.mytestbed.net/projects/oml/issues">http://oml.mytestbed.net/projects/oml/issues</a>). You could discuss it on
the mailing list (details and archives at
<a href="http://oml.mytestbed.net/tab/show?id=oml">http://oml.mytestbed.net/tab/show?id=oml</a>).</p></div>
<div class="paragraph"><p>It is however advisable to open a ticket on our issue tracker at
<a href="http://oml.mytestbed.net/projects/oml/issues/new">http://oml.mytestbed.net/projects/oml/issues/new</a>. Don&#8217;t forget to
include details such as client and server logs (at <em>[--oml-log-level|-d]
2</em>). It also helps if you can share the source code of a (minimal, if
possible) example reliably triggering the problem.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_see_also">SEE ALSO</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_manual_pages">Manual Pages</h3>
<div class="paragraph"><p><a href="oml2-server.1.html">oml2-server(1)</a>, <a href="liboml2.1.html">liboml2(1)</a>, <a href="liboml2.conf.5.html">liboml2.conf(5)</a>, <a href="oml2-scaffold.1.html">oml2-scaffold(1)</a></p></div>
<div class="paragraph"><p><a href="omlc_init.3.html">omlc_init(3)</a>, <a href="omlc_add_mp.3.html">omlc_add_mp(3)</a>, <a href="omlc_start.3.html">omlc_start(3)</a>, <a href="omlc_inject.3.html">omlc_inject(3)</a>, <a href="omlc_close.3.html">omlc_close(3)</a></p></div>
<div class="paragraph"><p><a href="OmlValueU.3.html">OmlValueU(3)</a></p></div>
</div>
<div class="sect2">
<h3 id="_oml_user_manual">OML User Manual</h3>
<div class="paragraph"><p><a href="http://oml.mytestbed.net/projects/oml/wiki/Documentation">http://oml.mytestbed.net/projects/oml/wiki/Documentation</a></p></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
OML 2.12.0pre.79-58cf-dirty<br />
Last updated 2015-04-16 15:28:58 CEST
</div>
<div id="footer-badges">
<a href="http://validator.w3.org/check?uri=referer">
  <img style="border:0;width:88px;height:31px"
    src="http://www.w3.org/Icons/valid-xhtml11-blue"
    alt="Valid XHTML 1.1" height="31" width="88" />
</a>
<a href="http://jigsaw.w3.org/css-validator/">
  <img style="border:0;width:88px;height:31px"
    src="http://jigsaw.w3.org/css-validator/images/vcss-blue"
    alt="Valid CSS!" />
</a>
</div>
</div>
</body>
</html>
